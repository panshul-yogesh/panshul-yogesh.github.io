{
  "title": "Upgrade Audit (managed Kubernetes)",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">This page contains the steps to upgrade Audit service and Audit collector in a managed (AWS with EKS or OpenShift) environment. You need to upgrade both Audit service and Audit collector.</p>\n<h2>Back up Audit service</h2>\n<p>This section gives the steps to back up Audit files and data:</p>\n<ol>\n<li>\n<p>Back up audit database. </p>\n</li>\n<li>\n<p>Back up all the configuration files that you are using. For example, <b>values.yaml</b> file, <strong>audit-secret.yaml</strong>, chart tar file, and certificates.</p>\n</li>\n<li>\n<p>Back up the <strong>itom-audit</strong><b>-pv.yaml</b> file.</p>\n</li>\n<li>\n<p>Back up the following data on the Amazon Elastic File System (EFS) or Network File System (NFS) volumes for the Audit deployment:</p>\n<table>\n<thead>\n<tr>\n<th scope=\"col\">Component</th>\n<th scope=\"col\">EFS/NFS volume name</th>\n<th scope=\"col\">Description</th>\n<th scope=\"col\">Example directory path</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Audit</td>\n<td><strong>as-vault-volume-&lt;Audit Namespace&gt;</strong></td>\n<td>Stores Audit configuration files.</td>\n<td>/var/vols/itom/audit/auditns/vault</td>\n</tr>\n<tr>\n<td>Audit</td>\n<td><strong>as-log-volume-&lt;Audit Namespace&gt;</strong></td>\n<td>Stores logs generated by Audit.</td>\n<td>/var/vols/itom/audit/auditns/log</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ol>\n<h2>Download the new Audit service Helm chart</h2>\n<p>To download the Audit Helm chart to the bastion node, follow these steps:</p>\n<ol>\n<li>Log in to the bastion node and navigate to the directory where you want to download and install Audit service. In this directory, create a folder, for example, <strong>audit-2x.x</strong>.\n\n\t<pre>mkdir audit-2x.x\ncd audit-2x.x</pre>\n</li>\n<li>Download the <strong>Audit</strong><b>_Helm_Chart</b><b>-2x.x.zip</b> file from the <a href=\"https://sld.microfocus.com/mysoftware/index\" title=\"Software Licenses and Downloads\">Software Licenses and Downloads</a> website to this folder.</li>\n<li>Unzip the package:\n\t<pre>unzip Audit_Helm_Chart-2x.x.zip</pre>\n</li>\n<li>Untar the Audit chart package:\n\t<pre>$tar -xvf audit-1.2.0+2x.x.x-xx.tgz</pre>\n</li>\n<li>Copy the Helm chart and the sample files to the install directory created in the step 1.\n\t<pre>cp audit-helm-chart/audit/charts/*.tgz .\ncp audit-helm-chart/audit/samples/* .</pre>\n</li>\n<li>Refer to the <a href=\"/doc/423/26.1/configureaudityamleks\" title=\"Configure values.yaml for Audit service (EKS)\">Configure values.yaml for Audit service (EKS)</a> and <a href=\"/doc/423/26.1/configureaudityamlopenshift\" title=\"Configure values.yaml for Audit service (OpenShift)\">Configure values.yaml for Audit service (OpenShift)</a> pages and then update the backed up audit service values.yaml for EKS and OpenShift, respectively. </li>\n</ol>\n<h2>Download and upload new Audit service images</h2>\n<ol>\n<li>For EKS, prepare the related images by following the instructions in <a href=\"/doc/423/26.1/installauditdownloadimageseks\" title=\"Download and upload images for Audit service\">Download and upload images for Audit service</a>.</li>\n<li>For OpenShift, download the related images by following the instructions in <a href=\"/doc/423/26.1/installauditdownloadimagesopenshift\" title=\"Download Audit images\">Download Audit images</a>.</li>\n<li>For OpenShift, upload container images for Audit to a registry by following the instructions in <a href=\"/doc/423/26.1/uploadinstallationimagesopenshift\" title=\"Upload Audit images\">Upload Audit images</a>.</li>\n</ol>\n<h2>Upgrade Audit service</h2>\n<p>Perform the following steps to upgrade to the latest version of Audit service:</p>\n<ol>\n<li>First note down the namespace where you have installed the Audit service. Run the following command to get the namespace: \n\t<pre>kubectl get namespace</pre>\n</li>\n<li>Run the following command to upgrade the Audit service:\n\t<pre>$helm upgrade &lt;Audit Release Name&gt; &lt;Audit Service Chart&gt; -n &lt;Audit Namespace&gt; -f &lt;Values YAML File&gt; -f &lt;Secrets YAML File&gt; --set-file \"caCertificates.cert_one\"=/path/to/cert_one.crt --set-file \"caCertificates.cert_two\"=/path/to/cert_two.crt\n</pre>\n<p>where,<br/>\n<em>&lt;Audit Release Name&gt; </em> is the release name of the Audit deployment that you specified when installing Audit.<br/>\n<em>&lt;Audit Service Chart&gt;</em> is the new tar file containing the Audit installation chart.<br/>\n<em>&lt;Audit Namespace&gt;</em> is the unique namespace you created for the Audit service.<br/>\n<em>&lt;Values YAML File&gt;</em> is your <b>values.yaml</b> file with properties configured for the Audit deployment.<br/>\n<em>&lt;Secrets YAML File&gt;</em> is the YAML file that stores the Audit secrets. Specify the file name (for example, <strong>audit-secret-backup.yaml</strong>). If you don't have this file, run the following command to get the file:</p>\n<pre>kubectl get secret &lt;name&gt; -n &lt;auditns&gt; -o yaml &gt; audit-secret-backup.yaml</pre>\n<p>You can pass the certificates by using the <strong>--set-file</strong> option. You can pass the suite, database, and Internal ALB certificates for EKS. You can pass the suite, DB, and Audit service engine certificates for OpenShift.<br/>\n\tYou can find the <strong>values.yaml</strong>, <strong>audit-secret-backup.yaml</strong>, and the certificates in the backed up file.</p>\n<p>An example command:</p>\n<pre>$helm upgrade audit audit-&lt;version&gt;.tgz -n auditns -f values.yaml -f audit-secret-backup.yaml --set-file \"caCertificates.RE_ca_idmcrt\"=./RE_ca_idm.crt --set-file \"caCertificates.RE_ca_dbcrt\"=./RE_ca_db.crt --set-file \"caCertificates.RE_ca_intAlb\"=./RE_ca_intAlb.crt\n</pre>\n</li>\n<li>Run the following command to check if the Audit service pods are ready:\n\t<pre>kubectl get pod -n &lt;Audit Namespace&gt; |grep -v 1/1|grep -v 2/2|grep -v 3/3|grep -v 4/4|grep -v Completed</pre>\n<p>where,</p>\n<p><em>&lt;Audit Namespace&gt;</em> is the namespace where you have deployed the Audit Helm chart.</p>\n<p>This command returns a list of abnormal pods. When it returns no results, all pods are ready.</p>\n</li>\n</ol>\n<p><span style=\"color: rgb(0, 115, 231); font-family: Roboto, sans-serif; font-size: 24px;\">Restore Audit service to the previous version when upgrade fails</span></p>\n<p>Follow the instructions below to restore Audit service if upgrade fails due to failure or corruption of audit deployment. </p>\n<ol>\n<li>\n<p>To uninstall Audit, delete the Audit deployment.</p>\n</li>\n<li>\n<p>Remove persistent volumes.</p>\n</li>\n<li>\n<p>Clean the EFS/NFS volumes.</p>\n</li>\n<li>\n<p>Create a deployment.</p>\n</li>\n<li>\n<p>To restore secret, create a new <strong>audit-secret</strong> using the backup secret YAML file:</p>\n<pre>kubectl apply -f itom-audit-secret_backup_yyyy-mm-dd.yaml -n &lt;Audit namespace&gt;</pre>\n</li>\n<li>\n<p>Recreate EFS/NFS volumes (in the EFS/NFS server).</p>\n</li>\n<li>\n<p>Recreate PVs using the same configuration (<strong>itom-audit</strong><b>-pv.yaml</b>).</p>\n</li>\n<li>\n<p>Restore the Audit database from the backed up database.</p>\n</li>\n<li>\n<p>Reinstall Audit deployment with the same configuration (<b>values.yaml</b>) and the same helm chart.</p>\n</li>\n</ol>\n<h2>Back up Audit collector</h2>\n<p>Back up all the Audit collector configuration files: <strong>audit collector values.yaml</strong>, <strong>audit collector secret backup.yaml</strong> file (you may need this file in case you need to restore Audit collector to the previous version), audit collector chart tar file, and certificates.</p>\n<h2>Download the new Audit collector Helm chart</h2>\n<p>To download the Audit collector Helm chart to the bastion node, follow these steps:</p>\n<ol>\n<li>Log in to the bastion node and navigate to the directory where you want to download and install Audit collector, for example, <strong>auditcollector</strong>. In this directory, create a folder, for example, <strong>audit-collector-2x.x</strong>.\n\n\t<pre>mkdir audit-collector-2x.x\ncd audit-collector-2x.x</pre>\n</li>\n<li>Download the <strong>Audit</strong><b>_Collector_Helm_Chart</b><b>-2x.x.zip</b> file from the <a href=\"https://sld.microfocus.com/mysoftware/index\" title=\"Software Licenses and Downloads\">Software Licenses and Downloads</a> website to <strong>audit-collector-2x.x </strong>folder or the folder that you have created in Step 1.</li>\n<li>Unzip the package:\n\t<pre>unzip Audit_Collector_Helm_Chart-2x.x.zip</pre>\n</li>\n<li>Untar the Audit collector chart package:\n\t<pre>$tar -xvf audit-collector-&lt;Version&gt;.tgz</pre>\n</li>\n<li>Make sure you are in the <strong>audit-collector-2x.x</strong> folder or the folder that you have created in Step 1. Copy the Helm chart and the sample value.yaml files using the following commands:\n\t<pre>cp audit-collector-helm-chart/audit-collector/charts/*.tgz .\ncp audit-collector-helm-chart/audit-collector/samples/* .</pre>\n</li>\n<li>Refer to the <a href=\"/doc/423/26.1/131-configauditcollectoryamleks\" title=\"Configure values.yaml for Audit collector (EKS)\">Configure values.yaml for Audit collector (EKS)</a> and <a href=\"/doc/423/26.1/131-configureauditcollectoryamlopenshift\" title=\"Configure values.yaml for Audit collector (OpenShift)\">Configure values.yaml for Audit collector (OpenShift)</a> pages. Update the new audit collector values.yaml file referring the backed-up values.yaml file for EKS and OpenShift, respectively.</li>\n</ol>\n<h2>Download and upload new Audit collector images</h2>\n<p>Prepare the Audit collector images by following the instructions in <a href=\"/doc/423/26.1/installauditcollectordownloadimageseks\" title=\"Download and upload images for Audit collector (AWS)\">Download and upload images for Audit collector (AWS)</a> and <a href=\"/doc/423/26.1/auditcollectordownloadimagesopenshift\" title=\"Download images for Audit collector (OpenShift)\">Download images for Audit collector (OpenShift)</a>.</p>\n<h2>Upgrade Audit collector</h2>\n<ol>\n<li>Deploy the Audit collector file in the same namespace where the Audit producer (for example, SMAX or UD/UCMDB) is running.</li>\n<li>\n<p>Generate vault secrets for the Audit collector chart by running the following command on the bastion node:</p>\n<pre>$CDF_HOME/scripts/gen_secrets.sh -n &lt;Audit Producer Namespace&gt; -c &lt;Audit Collector Chart File&gt; -o &lt;Secrets YAML File&gt;</pre>\n<p>where,<br/>\n\t&lt;Audit Producer Namespace&gt; is the namespace in which the Audit Producer (for example, SMAX and UD/UCMDB) is running.<br/>\n\t&lt;Audit Collector Chart File&gt; is the tar file containing the Audit collector installation charts (<strong>audit-collector-&lt;version&gt;.tgz</strong>).<br/>\n\t&lt;Secrets YAML File&gt; is the YAML file that stores the Audit collector secret. Specify the file name (for example, <strong>audit-collector-secret.yaml</strong>), and then the script will generate this YAML file after you run the script. You will need to use this file when you run the command to install the Audit collector.</p>\n<p>For example:</p>\n<pre>/opt/cdf/scripts/gen_secrets.sh -n itsma-cfpni -c audit-collector-&lt;version&gt;.tgz -o audit-collector-secret.yaml</pre>\n</li>\n<li>\n<div>The vault secret utility prompts you for the Audit collector integration user password: <strong>audit_collector_integration_user_pass_key</strong>.</div>\n</li>\n<li>\n<div>Refer to the <a href=\"/doc/423/26.1/131-configureauditcollectoryaml\" title=\"https://docs.microfocus.com/doc/Audit/Main/ConfigureAuditCollectorYaml\">Configure values.yaml for Audit collector (on-premises)</a>, update the backed up values.yaml file, and use it in the helm upgrade.</div>\n</li>\n<li>Run the following command to upgrade audit collector to the latest version:\n\t<pre>$helm upgrade &lt;Audit Collector Release Name&gt; &lt;Audit Collector Chart&gt; -n &lt;Audit Producer Namespace&gt; -f values.yaml -f audit-collector-secret.yaml --set-file \"caCertificates.cert_one\\.crt\"=/path/to/cert_one.crt --set-file \"caCertificates.cert_two\\.crt\"=/path/to/cert_two.crt\n</pre>\n<p>where,</p>\n<p><em>&lt;Audit Collector Release Name&gt; </em>is the release name of the Audit collector deployment that you specified when installing the Audit collector.<br/>\n<em>&lt;Audit Collector Chart&gt;</em> is the tar file containing the Audit collector installation charts.<br/>\n<em>&lt;Audit Producer Namespace&gt;</em> is the namespace where the Audit producer is running.<br/>\n<em>&lt;Values YAML File&gt;</em> is your <strong>values.yaml</strong> file with properties configured for the Audit collector deployment.<br/>\n<em>&lt;Audit Collector Secrets YAML file&gt;</em> is the file that gen_secret script generates and holds the Audit collector secrets. <br/>\n\tYou can pass the certificates by using the<strong> --set-file</strong> option. You can pass the suite and Internal ALB certificates for EKS. You can pass the suite and Audit service engine certificates for OpenShift.<br/>\n\t </p>\n<p>An example command:</p>\n<pre>$helm upgrade audit-collector audit-collector-&lt;version&gt;.tgz -n itsma-cfpni -f values.yaml -f audit-secret-backup.yaml --set-file \"caCertificates.RE_ca_idmcrt\"=./RE_ca_idm.crt --set-file \"caCertificates.RE_ca_intAlb\"=./RE_ca_intAlb.crt\n</pre>\n</li>\n</ol>\n<h2>Restore Audit collector</h2>\n<p>Follow the instructions below to restore the Audit collector to the previous version if upgrade fails. </p>\n<ol>\n<li>\n<p>Uninstall Audit collector.</p>\n</li>\n<li>\n<p>To restore the secret, create a new <strong>audit-collector-secret</strong> using the backup secret YAML file:</p>\n<pre>kubectl apply -f itom-audit-collector-secret-backup-yyyy-mm-dd.yaml -n &lt;Audit producer namespace&gt;</pre>\n</li>\n<li>\n<p>Reinstall Audit collector with the same configuration (<b>values.yaml</b>) and the same helm chart.</p>\n</li>\n</ol>\n<h2>Enable indexing for existing tenants</h2>\n<p>To enable indexing in the audit database for existing tenants, you can run a script. Open the query tool for the required schema under the audit table and run the following script:</p>\n<pre>CREATE INDEX IF NOT EXISTS &lt;index_name&gt; ON \"&lt;schema&gt;\".audit (column1,column2,...);</pre>\n<p>Example:</p>\n<pre>CREATE INDEX IF NOT EXISTS AUDIT_INDEX ON \"100000002\".audit (action, audit_time, event_category, result, service, tenant_id);\n</pre>\n<p><strong>&lt;index_name&gt;</strong>: Any name you want to give for the index.<br/>\n<strong>&lt;schema&gt;</strong>: The schema for which you want to enable indexing.<br/>\n<strong>&lt;column 1, column 2...&gt;</strong>: The name of the columns that you want to enable indexing for. This is a comma separated list.</p>\n</div>",
  "modifiedon": "2025-10-24 08:51:12"
}