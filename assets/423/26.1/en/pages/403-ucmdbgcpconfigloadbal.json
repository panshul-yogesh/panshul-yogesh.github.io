{
  "title": "Configure load balancers for UD/UCMDB",
  "content": "<div class=\"mw-parser-output\"><br/><h2>Create an external Ingress for UD/UCMDB</h2>\n<div>To create an external Ingress for UD/UCMDB, follow these steps:</div>\n<ol>\n<li>Reserve a static global IP address for the external Load Balancer by running the following command:   \n\t<pre>gcloud compute addresses create uducmdb-external-lb \\ \n      --global \\ \n      --ip-version IPV4 </pre>\n</li>\n<li>Bind the static IP address with a DNS record.</li>\n<li>Create an SSL policy that defines the minimum TLS version and the allowed encryption ciphers by running the following command:\n\t<pre>gcloud compute ssl-policies create esm-ssl-strict-policy \\ \n    --profile RESTRICTED \\ \n    --min-tls-version 1.2 </pre>\n</li>\n<li>Copy the following content to a file named <code>FrontendConfig.yaml</code>:\n\t<pre>apiVersion: networking.gke.io/v1beta1 \nkind: FrontendConfig \nmetadata: \n  name: ucmdb-external-lb-frontend-config \n  namespace: ucmdb \nspec: \n  sslPolicy: esm-ssl-strict-policy \n  redirectToHttps: \n    enabled: true \n    responseCodeName: MOVED_PERMANENTLY_DEFAULT \n</pre>\n</li>\n<li>Create the <code>FrontendConfig.yaml</code> by running the following command:\n\t<pre>kubectl create -f FrontendConfig.yaml -n &lt;uducmdb_namespace&gt;</pre>\n</li>\n<li>Copy the following content to a file named <code>BackendConfig.yaml</code>:\n\t<pre>apiVersion: cloud.google.com/v1 \nkind: BackendConfig \nmetadata: \n  name: ucmdb-lb-backendconfig \n  namespace: ucmdb \nspec: \n  timeoutSec: 180 \n  healthCheck: \n    checkIntervalSec: 10 \n    timeoutSec: 10 \n    healthyThreshold: 1 \n    unhealthyThreshold: 3 \n    type: HTTPS \n    requestPath: / \n    port: 443 </pre>\n</li>\n<li>Create the <code>BackendConfig.yaml</code> by running the following command:\n\t<pre>kubectl create -f BackendConfig.yaml -n &lt;uducmdb_namespace&gt;</pre>\n</li>\n<li>Ensure that the <code>itom-ingress-controller-svc</code> service has the following annotations:\n\t<pre>apiVersion: v1 \nkind: Service \nmetadata: \n  annotations: \n    cloud.google.com/neg: '{\"ingress\": true}' \n    cloud.google.com/backend-config: '{\"ports\": {\"443\":\"ucmdb-lb-backendconfig\"}}' \n    cloud.google.com/app-protocols: '{\"https\":\"HTTPS\"}' \n  name: itom-ingress-controller-svc \n  namespace: ucmdb \nspec: \n  ports:\n  - name: https\n    nodePort: 30443\n    port: 30443\n    protocol: TCP\n    targetPort: 8443 \n\n  selector:\n    app.kubernetes.io/instance: ucmdb\n    app.kubernetes.io/name: itom-ingress-controller\n  sessionAffinity: None\n  type: NodePort\n </pre>\n</li>\n<li>Copy the following content to a file named <code>ucmdb-external-lb-ing.yaml</code>:\n\t<pre>apiVersion: networking.k8s.io/v1 \nkind: Ingress \nmetadata: \n  name: \"ucmdb-external-lb-ing\" \n  namespace: ucmdb \n  annotations: \n    networking.gke.io/v1beta1.FrontendConfig: \"ucmdb-external-lb-frontend-config\" \n    kubernetes.io/ingress.class: gce \n    kubernetes.io/ingress.global-static-ip-name: \"&lt;static-ip-name-lb&gt;\" \n    kubernetes.io/ingress.allow-http: \"false\" \nspec:\n  rules:\n  - host: &lt;public-fqdn-of-ucmdb&gt;\n    http:\n      paths:\n      - backend:\n          service:\n            name: itom-ingress-controller-svc\n            port:\n              number: 30443\n        pathType: ImplementationSpecific\n  tls:\n  - secretName: nginx-default-secret  </pre>\n</li>\n<li>Create the <code>ucmdb-external-lb-ing</code> ingress resource by running the following command:\n\t<pre>kubectl create -f ucmdb-external-lb-ing.yaml -n &lt;uducmdb_namespace&gt;</pre>\n</li>\n</ol>\n<h2>Create an internal Ingress for UD/UCMDB </h2>\n<div>To create an internal Ingress for UD/UCMDB, follow these steps:</div>\n<ol>\n<li>Set up the Proxy-Only subnet. For details, see the official documentation <a href=\"https://cloud.google.com/load-balancing/docs/l7-internal/setting-up-l7-internal#configuring_the_proxy-only_subnet\" title=\"Set up a regional internal Application Load Balancer with VM instance group backends\">Set up a regional internal Application Load Balancer with VM instance group backends</a>.\n\n\t<pre>\tgcloud compute networks subnets create proxy-only-subnet \\\n  --purpose=REGIONAL_MANAGED_PROXY \\\n  --role=ACTIVE \\\n  --region=&lt;region name, e.g. us-west1&gt; \\\n  --network=&lt;vpc name&gt; \\\n  --range=&lt;IP CIDR, e.g. 10.129.0.0/24&gt;</pre>\n</li>\n<li>Set up a Private subnet for the Internal LB.\n\t<pre>gcloud compute networks subnets create esm-internal-lb-subnet \\\n    --network=NETWORK \\\n    --range=&lt;IP CIDR, e.g. 10.129.1.0/24&gt; \\\n    --region=&lt;region name, e.g. us-west1&gt;</pre>\n</li>\n<li>Reserve a static internal IP address for the Internal LB from the Private subnet:\n\t<pre>\tgcloud compute addresses create smax-internal-lb \\\n    --region REGION --subnet SUBNETWORK \\\n    --addresses IP_ADDRESS</pre>\n<p>For details, see <a href=\"https://cloud.google.com/vpc/docs/reserve-static-internal-ip-address#reservenewip\" title=\"Reserve a new static internal IPv4 or IPv6 address\">Reserve a new static internal IPv4 or IPv6 address</a>.</p>\n</li>\n<li>Bind the IP address with a Private DNS record.</li>\n<li>Ensure that the <code>itom-nginx-ingress-svc-internal</code> service has the following annotations:\n\t<pre>apiVersion: v1\n\tkind: Service\n\tmetadata:\n\t  annotations:\n\t    cloud.google.com/neg: '{\"ingress\": true}'\n\t    cloud.google.com/backend-config: '{\"ports\": {\"443\":\"ucmdb-lb-backendconfig\"}}'\n\t    cloud.google.com/app-protocols: '{\"https\":\"HTTPS\"}'\n\t  name: itom-nginx-ingress-svc-internal\n\t  namespace: &lt;namespace&gt;\n\tspec:\n\t  ports:\n\t  - name: https\n        nodePort: 30445\n        port: 30445\n        protocol: TCP\n        targetPort: 8443\n      selector:\n        app.kubernetes.io/instance: ucmdb\n        app.kubernetes.io/name: itom-ingress-controller\n      sessionAffinity: None\n      type: NodePort</pre>\n</li>\n<li>Copy the following content to a file named <code>&lt;esm-product-name&gt;-internal-lb-ing.yaml</code>:\n\t<pre>apiVersion: networking.k8s.io/v1\n\tkind: Ingress\n\tmetadata:\n\t  name: \"&lt;esm-product-name&gt;-internal-lb-ing\"\n\t  namespace: &lt;namespace&gt;\n\t  annotations:\n\t    kubernetes.io/ingress.class: gce-internal\n\t    kubernetes.io/ingress.regional-static-ip-name: \"&lt;static-internal-ip-name-for-the-internal-lb&gt;\"\n\t    kubernetes.io/ingress.allow-http: \"false\"\n\tspec:\n\t  tls:\n\t    - secretName: &lt;k8s-secret-name-for-storing-server-cert&gt;\n\t  rules:\n  - host: &lt;internal-fqdn-of-ucmdb&gt;\n    http:\n      paths:\n      - backend:\n          service:\n            name: itom-ingress-controller-svc\n            port:\n              number: &lt;nodeport port value from svc eg. 30445&gt;\n        pathType: ImplementationSpecific\n</pre>\n</li>\n<li>Create the <code>&lt;esm-product-name&gt;-internal-lb-ing</code> ingress resource by running the following command:\n\t<pre>kubectl create -f &lt;esm-product-name&gt;-internal-lb-ingress.yaml -n &lt;uducmdb_namespace&gt; <smax-namespace></smax-namespace></pre>\n</li>\n</ol>\n</div>",
  "modifiedon": "2025-10-24 08:51:12"
}