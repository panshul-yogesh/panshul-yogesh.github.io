{
  "title": "Subscribe premium Azure Files for UD/UCMDB",
  "content": "<div class=\"mw-parser-output\"><br/>\n<p>This release only supports Azure Files as the storage service of CMS on Azure.</p>\n<p>Follow the steps in this section to create and configure Azure file shares.</p>\n<h2 id=\"Create_premium_Azure_file_shares\">Create premium Azure file shares</h2>\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Storage Admin</td>\n<td>Bastion node</td>\n</tr>\n</tbody>\n</table>\n<p>To create and configure premium Azure file shares for CMS, log on to the bastion and follow these steps:</p>\n<p>The FileStorage account to use CMS Azure file share is the same one that you created when you <a href=\"/doc/423/26.1/akspremiumnfshelm\" title=\"Prepare File Storage - Subscribe premium Azure Files and Azure Disks\">create premium Azure file shares for SMAX</a>.</p>\n<ol>\n<li>Run the following command to get the key of the created FileStorage account:\n\t<pre>az storage account keys list \\\n    --resource-group &lt;resource_group_name&gt; \\\n    --account-name &lt;storage_account_name&gt; \\\n    --query \"[0].value\" | tr -d '\"'</pre>\n<p>In this command,</p>\n<ul>\n<li><b>&lt;resource_group_name&gt;</b> is the name of the resource group you created on the <a href=\"/doc/423/26.1/akscluster#Prerequisites\" title=\"Build AKS cluster\">Build AKS cluster</a> page. Do <b>NOT</b> use your cluster's resource group name with the format <code>MC_&lt;resource_group&gt;_&lt;aks_cluster_name&gt;_&lt;location&gt;</code>.</li>\n<li><b>&lt;storage_account_name&gt;</b> is the name of the created FileStorage account when you <a href=\"/doc/423/26.1/akspremiumnfshelm\" title=\"Prepare File Storage - Subscribe premium Azure Files and Azure Disks\">create premium Azure file shares for SMAX</a>.</li>\n</ul>\n</li>\n<li>Create an Azure file share for CMS by running the following command. \n\t<pre>az storage share create \\\n--account-name &lt;storage_account_name&gt; \\\n--account-key &lt;storage_account_key&gt; \\\n--name \"&lt;cms_fileshare_name&gt;\" \\\n--quota &lt;share_quota&gt;</pre>\n<p>In this command,</p>\n<ul>\n<li><b>&lt;storage_account_name&gt;</b> is the name of the created FileStorage account when you <a href=\"/doc/423/26.1/akspremiumnfshelm\" title=\"Prepare File Storage - Subscribe premium Azure Files and Azure Disks\">create premium Azure file shares for SMAX</a>.</li>\n<li><b>&lt;storage_account_key&gt;</b> is the key you got in the previous step.</li>\n<li><b>&lt;cms_fileshare_name&gt;</b>: Specify a name of the Azure file share for CMS. For example, <strong>cms</strong>.</li>\n<li><b>&lt;share_quota&gt;</b>: Specify the size of the share (<b>in GB</b>) by referring to <a href=\"/doc/423/26.1/akssizing\" title=\"SMAX:24.3/AKSSizing\">Sizing recommendations</a>. Must be greater than 0, and less than or equal to 5 TB (5120).</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"Configure_CMS_volumes\">Configure UD/UCMDB volumes</h2>\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Storage Admin</td>\n<td>Bastion node</td>\n</tr>\n</tbody>\n</table>\n<p>Once the Azure file share for CMS is ready, log on to the bastion and set up volumes to store all CMS data by following these steps:</p>\n<ol>\n<li>Run the following command to mount the Azure file share for storing the UD/UCMDB data to bastion:\n\t<pre>sudo ./mountazurefile.sh  &lt;storage_account_name&gt; &lt;storage_account_key&gt; &lt;cms_fileshare_name&gt; &lt;SYSTEM_USER_ID&gt; &lt;SYSTEM_GROUP_ID&gt;</pre>\n<p>In these commands,</p>\n<ul>\n<li><strong>mountazurefile.sh</strong> is the file created when you <a href=\"/doc/423/26.1/akspremiumnfshelm\" title=\"Prepare File Storage - Subscribe premium Azure Files and Azure Disks\">create premium Azure file shares for SMAX</a>.</li>\n<li><b>&lt;storage_account_name&gt;</b> is the name of the created FileStorage account when you <a href=\"/doc/423/26.1/akspremiumnfshelm\" title=\"Prepare File Storage - Subscribe premium Azure Files and Azure Disks\">create premium Azure file shares for SMAX</a>.</li>\n<li><b>&lt;storage_account_key&gt;</b> is the key you got when creating Azure file shares.</li>\n<li><b>&lt;cms_fileshare_name&gt;</b> is the name of the Azure file share for storing the <b>cms </b>data.</li>\n<li><b>&lt;SYSTEM_USER_ID&gt;</b> and <b>&lt;SYSTEM_GROUP_ID&gt;</b>: specify an operating system user ID and group ID that are used to run the process in the container, respectively. Both values must be 1999 or a number between 100000 and 2000000000. </li>\n</ul>\n</li>\n<li>Run the following command to test the performance of the Azure file share. <strong>Do not proceed if the result can't meet the minimum requirement.</strong><button>Copy</button>\n<pre>sudo dd if=/dev/zero of=/mnt/nfs/&lt;cms_fileshare_name&gt;/small.img bs=512 count=10000 oflag=dsync</pre>\n<p>In this command, <b>&lt;cms_fileshare_name&gt;</b> is the name of the Azure file share for storing the <b>cms</b> data.</p>\n<p>The output looks as below:</p>\n<pre>10+0 records in\n10+0 records out\n5120 bytes (5.1 kB, 5.0 KiB) copied, 0.0713496 s, 71.8 kB/s</pre>\n<p>The minimum requirement for the UD/UCMDB installation is <strong>60 kB/s</strong>. Based on the performance tests, the command returns an output higher than 60 kB/s in most Azure regions.</p>\n<p>Any number smaller than that will cause the installation to fail. In this case, contact Azure support to fix the performance issue.</p>\n</li>\n<li>Run the following commands to create directories for the <b>cms</b> data:\n\t<pre>cd /mnt/nfs/&lt;cms_fileshare_name&gt;\n\nsudo mkdir  -p ./var/vols/itom/cms/cms-data-volume\nsudo mkdir  -p ./var/vols/itom/cms/cms-config-volume\nsudo mkdir  -p ./var/vols/itom/cms/cms-log-volume\n</pre>\n<p>In these commands,</p>\n<p><b>&lt;cms_fileshare_name&gt;</b> is the name of the Azure file share for storing the <b>cms</b> data.</p>\n</li>\n<li>Copy and save the following script as <b>createCMSPV.sh</b>:\n\t<pre>#!/bin/bash\nAZURE_SECRECT=\"azure-secret\"\nSTORAGE_TYPE=\"azurefile\"\nSTORAGE_CLASS=\"cms-default\"\nPV_DIR=\"/tmp/cmspvyamlsfolder\"\nSUITE_VOLUMES=\"\ncms-data-volume\ncms-config-volume\ncms-log-volume\n\"\nusage() {\n    echo \"Usage: $0  [-n|--namespace &lt;namespace&gt;] [-cp|--cms-volume-path &lt;cms_volume_path&gt;]\"\n    echo \"       -n|--namespace            Name space.\"\n    echo \"       -cp|--cms-volume-path Path of volumes for storing cms data.\"\n    echo \"       -u|--uid Suite user UiD.\"\n    echo \"       -g|--gid Suite user GiD.\"\n    echo \"       -h|--help                 Show help.\"\n    echo -e \"\nExamples:\n1)   $0  -n core   -cp file1/var/vols/itom/cms\n2)   $0  -n cms    -cp file1/var/vols/itom/cms\"\nexit 1\n}\nwhile [[ ! -z $1 ]] ; do\n    case \"$1\" in\n        -n|--namespace)\n        case \"$2\" in\n            -*) echo \"-n|--namespace parameter requires a value. \" ; exit 1 ;;\n            *)  if [[ -z $2 ]] ; then echo \"-n|--namespace parameter requires a value. \" ; exit 1 ; fi ; NAME_SPACE=$2 ; shift 2 ;;\n        esac ;;\n        -cp|--cms-volume-path)\n        case \"$2\" in\n            -*) echo \"-cp|--cms-volume-path parameter requires a value. \" ; exit 1 ;;\n            *)  if [[ -z $2 ]] ; then echo \"-cp|--cms-volume-path parameter requires a value. \" ; exit 1 ; fi ; CMS_PATH_VOLUME=$2 ; shift 2 ;;\n        esac ;;\n        -u|--uid)\n        case \"$2\" in\n            -*) echo \"-u|--uid. \" ; exit 1 ;;\n            *)  if [[ -z $2 ]] ; then echo \"-u|--uid parameter requires a value. \" ; exit 1 ; fi ; UiD=$2 ; shift 2 ;;\n        esac ;;\n        -g|--gid)\n        case \"$2\" in\n            -*) echo \"-g|--gid. \" ; exit 1 ;;\n            *)  if [[ -z $2 ]] ; then echo \"-g|--gid parameter requires a value. \" ; exit 1 ; fi ; GiD=$2 ; shift 2 ;;\n        esac ;;\n        *|-*|-h|--help|/?|help) usage ;;\n    esac\ndone\nif [ -z \"$NAME_SPACE\" ];then\n    echo \"Abort installation because the '--namespace' is missing.\"\n    exit 1\nfi\nif [ -z \"$CMS_PATH_VOLUME\" ];then\n    echo \"Abort installation because the '--cms-volume-path' is missing.\"\n    exit 1\nfi\nif [ -z \"$UiD\" ];then\n    echo \"Abort installation because the '--uid' is missing.\"\n    exit 1\nfi\nif [ -z \"$GiD\" ];then\n    echo \"Abort installation because the '--gid' is missing.\"\n    exit 1\nfi\nif [ -d $PV_DIR ];then\n    sudo rm -rf $PV_DIR\nfi\nsudo mkdir -p $PV_DIR\necho \"The pv yamls files can be found in $PV_DIR\"\ncd $PV_DIR\n\n###azure file pv yaml template\ncat&gt;azurepvtemplate.yaml&lt;&lt;EOF\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: {{provide_pv_name}}\nspec:\n  accessModes:\n  - ReadWriteMany\n  capacity:\n    storage: 1Mi\n  azureFile:\n    secretName: ${AZURE_SECRECT}\n    shareName: {{path_volume}}/{{provide_volume_folder_name}}\n    secretNamespace: ${NAME_SPACE}\n  mountOptions:\n  - dir_mode=0775\n  - uid=${UiD}\n  - gid=${GiD}\n  - mfsymlinks\n  persistentVolumeReclaimPolicy: Retain\n  storageClassName: cms-default\n  volumeMode: Filesystem\nEOF\n\nreplaceSuitePvTemplate(){\n    local volumeName=$1\n    sed -i -e s!{{path_volume}}!${CMS_PATH_VOLUME}!g $volumeName.yaml\n    if [[ $volumeName =~ \"cms\" ]]\n    then\n         sed -i -e s/1Mi/5Gi/g $volumeName.yaml\n         sed -i -e s/{{provide_pvc_claim_name}}/$volumeName/g $volumeName.yaml\n         sed -i -e s/{{provide_volume_folder_name}}/$volumeName/g $volumeName.yaml\n         sed -i -e s/{{provide_pv_name}}/$volumeName/g $volumeName.yaml\n         sed -i -e '/mfsymlinks/a\\  - nobrl' $volumeName.yaml\n         sed -i -e s!{{path_volume}}!${CMS_PATH_VOLUME}!g $volumeName.yaml\n    else\n         echo \"Wrong pv volume name, so exit\"\n         exit 1\n     fi\n}\n\ncreateSuitePv(){\n    local pvList=$@\n    for i in $pvList\n    do\n        cp azurepvtemplate.yaml $i.yaml\n        replaceSuitePvTemplate $i\n        kubectl create -f $i.yaml\n    done\n}\nif [[ $NAME_SPACE == \"core\" ]]\nthen\n    createCdfPv ${CDF_VOLUMES}\nelif [[ $NAME_SPACE =~ \"cms\" ]]\nthen\n    createSuitePv ${SUITE_VOLUMES}\nelse\n    echo \"please use the right namespace\"\n    exit 1\nfi\n</pre>\n</li>\n<li>Check if a file named <code>/&lt;root&gt;/.kube/config</code> with cluster credentials exists. If not, follow these steps:\n\t<ol>\n<li>Log in to the Azure CLI by running the command below and following the instructions in the command output:\n\t\t<pre>sudo az login</pre>\n</li>\n<li>Run the following command to get the required permission to run the Kubernetes commands:\n\t\t<pre>sudo az aks get-credentials --resource-group &lt;resource_group_name&gt; --name &lt;kubernetes_cluster_name&gt; --subscription &lt;subscription_name_or_id&gt;</pre>\n<p>In this command,</p>\n<ul>\n<li><b>&lt;resource_group_name&gt;</b>: Enter the name of the resource group you created on the <a href=\"/doc/423/26.1/akscluster#Prerequisites\" title=\"Build AKS cluster\">Build AKS cluster</a> page. Do <b>NOT</b> use your cluster's resource group name with the format <code>MC_&lt;resource_group&gt;_&lt;aks_cluster_name&gt;_&lt;location&gt;</code>.</li>\n<li><b>&lt;kubernetes_cluster_name&gt;</b>: Enter the name of the created Kubernetes cluster.</li>\n<li><b>&lt;subscription_name_or_id&gt;</b>: Enter your subscription name or ID. You can get it by navigating to the Azure portal <b>Home</b> page &gt; <b>Subscriptions</b>.</li>\n</ul>\n</li>\n</ol>\n</li>\n<li>\n<p>Run the following command to generate the secret under the UD/UCMDB namespace for Kubernetes to access the Azure file shares:</p>\n<pre>kubectl create secret generic azure-secret --from-literal=azurestorageaccountname=&lt;storage_account_name&gt; --from-literal=azurestorageaccountkey=&lt;storage_account_key&gt; -n &lt;cms_namespace&gt;</pre>\n<p>In this command,</p>\n<ul>\n<li><b>&lt;storage_account_name&gt;</b> is the name of the FileStorage account created.</li>\n<li><b>&lt;storage_account_key&gt;</b> is the key you obtained for the FileStorage account created.</li>\n<li><strong>&lt;cms_namespace&gt; </strong>is the cms namespace.</li>\n</ul>\n</li>\n<li>Run the following command to create Persistent Volumes for CMS:\n\t<pre>chmod 755 createCMSPV.sh\nsudo ./createCMSPV.sh  -n &lt;cms_namespace&gt; -cp &lt;cms_file_share_name&gt;/var/vols/itom/cms -u &lt;SYSTEM_USER_ID&gt; -g &lt;SYSTEM_GROUP_ID&gt; </pre>\n<p>In these commands,</p>\n<ul>\n<li>\n<p><strong>&lt;cms_namespace&gt;</strong> is the unique namespace of the UD/UCMDB deployment when you <a href=\"/doc/423/26.1/createdeploymentakscms\" title=\"Create a new deployment for CMS\">Create a new deployment for CMS</a>.</p>\n</li>\n<li>\n<p><strong>&lt;cms_file_share_name&gt;</strong> is the name of the Azure file share for storing <b>cms </b>data. </p>\n</li>\n<li><b>&lt;SYSTEM_USER_ID&gt;</b> and <b>&lt;SYSTEM_GROUP_ID&gt;</b>: specify the operating system user ID and group ID respectively that are used to run the process in the container. Both values must be 1999 or a number between 100000 and 2000000000.</li>\n</ul>\n<p>For example: <strong>./createCMSPV.sh -n cms -cp cms/var/vols/itom/cms -u 1999 -g 1999</strong></p>\n</li>\n</ol>\n<div> </div>\n</div>",
  "modifiedon": "2025-10-24 08:51:12"
}