{
  "title": "Build AKS cluster",
  "content": "<div class=\"mw-parser-output\">\n<p><br/>\nTo use the Azure Kubernetes Service (AKS) to install and manage the suite on Azure, you need to perform the following prerequisite tasks and then create an AKS cluster. </p>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-important-icon\"></div><div class=\"admonition-content admonition-important-content\"><div>\n<p>You must place all the created resources in the same VNet to prevent performance issues caused by network latency, including resource group, AKS cluster, bastion, Azure Files, Azure NetApp Files, PostgreSQL, etc.</p>\nAnd do <b>NOT</b> route the internal traffic inside this VNet out to another VNet (for example, a firewall VNet). That is, make sure all the traffic between the created resources is within the same VNet.<br/>\n<br/>\nAKS isn't compatible with <strong>Azure Security Center</strong> very well. Therefore, if you enable <strong>Azure Security Center</strong> on a subscription, there will be disk IOPS spikes on all worker nodes of all AKS clusters in the subscription. See <a href=\"/doc/423/26.1/aksiopsspike\" title=\"Disk IOPS spikes on AKS worker nodes\">Disk IOPS spikes on AKS worker nodes</a> for the solution.</div></div></div>\n<h2 class=\"mw-headline\" id=\"Prerequisites\"><a id=\"Prerequisites\" name=\"Prerequisites\" title=\"Prerequisites\"></a>Prerequisites</h2>\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Cloud administrator &amp; IT / Network administrator</td>\n<td>Azure Cloud Shell</td>\n</tr>\n</tbody>\n</table>\n<p>Before creating the AKS cluster, follow these steps to prepare all the required resources:</p>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Log in to the Azure portal at <a class=\"external free\" href=\"https://portal.azure.com\" rel=\"nofollow\" target=\"1\" title=\"https://portal.azure.com\">https://portal.azure.com</a>.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Open the Azure Cloud Shell by clicking the shell icon <a class=\"image\" href=\"\"> <img alt=\"CloudShell.PNG\" data-file-height=\"55\" data-file-width=\"59\" src=\"../../../images/50px-CloudShell_49585982.png\" style=\"width: 50px; height: 47px;\"/> </a> in the header bar and select <b>Bash</b> when prompted.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following command to create a resource group:\n\t<pre>az group create --name &lt;resource_group_name&gt; --location &lt;location&gt;</pre>\n<p>where:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><code>&lt;resource_group_name&gt;</code>: Give a name to this resource group, for example, <em>myResourceGroup</em><i>.</i></li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;location&gt;</code>: Specify a location for this resource group. For example, <em>westus2</em>.</li></ul>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following command to create a virtual network (VNet) and a subnet for AKS:\n\t<pre>az network vnet create -g &lt;resource_group_name&gt; -n &lt;vnet_name&gt; --address-prefix &lt;vnet_CIDR&gt; --subnet-name &lt;subnet_name&gt; --subnet-prefix &lt;subnet_CIDR&gt;</pre>\n<p>where:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><code>&lt;resource_group_name&gt;</code>: Type the name of the resource group created in the previous step, for example, <em>myResourceGroup.</em></li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;vnet_name&gt;</code>: Give a name to this virtual network.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;vnet_CIDR&gt;</code>: Specify a CIDR notation for this virtual network. For example, <em>10.1.0.0/16</em>.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;subnet_name&gt;</code>: Give a name to this subnet for AKS.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;subnet_CIDR&gt;</code>: Specify a CIDR notation for this subnet. In the next section when you create an AKS cluster, you will need to specify a network plugin. If you choose to use the <strong>azure</strong> plugin, make sure this subnet for AKS contains <b>at least 500</b> IP addresses (See <a href=\"/doc/423/26.1/aksdeploymentfaq#Do_I_really_need_500_private_IPs_for_SMA_deployment_on_AKS?\" title=\"Why 500 IPs are required?\">Why 500 IPs are required?</a>). For example, <em>10.1.10.0/23</em>. </li></ul>\n</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Collect the AKS subnet ID by running the following command. You may get more than one subnet ID in this step, however, you will need the one for <strong>AKS</strong> when creating an AKS cluster.\n\t<pre>az network vnet subnet list --vnet-name &lt;vnet_name&gt; -g &lt;resource_group_name&gt; -o json | grep 'subnets' | awk '{print $2}' | sed 's/,//g' | sed 's/\"//g'| sed 2d</pre>\n<p>where:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><code>&lt;vnet_name&gt;</code>: Enter the name of the created virtual network.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;resource_group_name&gt;</code>: Enter the name of the resource group created in step 3, for example, <em>myResourceGroup</em><i>.</i></li></ul>\n</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Prepare subnets for bastion, database and FileStorage. You need to create three more subnets under the same created virtual network.\n\t<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><strong>For bastion</strong>: \n\t\t<pre><code>az network vnet subnet create -n &lt;subnet name&gt;  -g &lt;resource_group_name&gt;  --vnet-name &lt;vnet_name&gt; --address-prefixes &lt;subnet_CIDR&gt; </code>\n</pre>\n</li><li style=\"margin-left: 40px; position: relative;\"><strong>For database</strong>: \n\t\t<pre><code>az network vnet subnet create -n &lt;subnet name&gt;  -g &lt;resource_group_name&gt;  --vnet-name &lt;vnet_name&gt; --address-prefixes &lt;subnet_CIDR&gt; --delegations  \"Microsoft.DBforPostgreSQL/flexibleServers\" </code>\n</pre>\n</li><li style=\"margin-left: 40px; position: relative;\">(optional) If you choose NetApp as File Storage, you need prepare subnet for it: \n\t\t<pre><code>az network vnet subnet create -n &lt;subnet name&gt;  -g &lt;resource_group_name&gt;  --vnet-name &lt;vnet_name&gt; --address-prefixes &lt;subnet_CIDR&gt;  --delegations  \"Microsoft.Netapp/volumes\", </code>\n</pre>\n</li><li style=\"margin-left: 40px; position: relative;\"><strong>For Application gateway</strong>: Prepare a subnet which only contain your application gateway. \n\t\t<pre><code>az network vnet subnet create -n &lt;subnet name&gt;  -g &lt;resource_group_name&gt;  --vnet-name &lt;vnet_name&gt; --address-prefixes &lt;subnet_CIDR&gt;</code></pre>\n</li></ul>\n</li></ol>\n<h3 class=\"mw-headline\"><a id=\"Create_an_NSG\" name=\"Create_an_NSG\" title=\"Create an NSG\"></a>Create an NSG</h3>\n<div>Run the following command to create NSG:</div>\n<pre><code>az network nsg create\\\n--resource-group &lt;resource-group &gt;\\\n--name &lt;name of nsg&gt;\n--location &lt;Location&gt; az network nsg rule create \\\n--resource-group &lt;resource group&gt; \\\n--nsg-name &lt;nsg name&gt; \\\n--name ssh \\ --priority 102 \\\n--direction Inbound \\\n--access Allow \\\n--protocol Tcp \\\n--source-address-prefixes '0.0.0.0/0' \\\n--source-port-ranges '*' \\ \n--destination-address-prefixes '*' \\ \n--destination-port-ranges 22</code></pre>\n<h3><a id=\"Associate_the_network_security_group_to_the_Bastion_public_subnet\" name=\"Associate_the_network_security_group_to_the_Bastion_public_subnet\" title=\"Associate the network security group to the Bastion public subnet\"></a>Associate the network security group to the Bastion public subnet</h3>\n<div>Run this command to associate the network security group:</div>\n<pre><code>az network vnet subnet update \\\n  --resource-group &lt;Resource group&gt; \\\n  --vnet-name &lt;Vnet name&gt;  \\\n  --name &lt;subnet name&gt; \\\n  --network-security-group&lt;NSG name&gt;</code></pre>\n<h3><a id=\"Create_Static_IP_for_the_Bastion_Host\" name=\"Create_Static_IP_for_the_Bastion_Host\" title=\"Create Static IP for the Bastion Host\"></a>Create Static IP for the Bastion Host</h3>\n<div>Run the following command to create static IP:</div>\n<pre><code>az network public-ip create \\\n--name &lt;name of Public IP&gt; \\\n--resource-group &lt;Resource group&gt; \\\n--location &lt;Location&gt; \\\n--allocation-method Static \\\n--version IPv4 \\\n--sku standard</code></pre>\n<h3><a id=\"Create_and_configure_Network_Interface_for_Bastion_Public_Subnet\" name=\"Create_and_configure_Network_Interface_for_Bastion_Public_Subnet\" title=\"Create and configure Network Interface for Bastion Public Subnet\"></a>Create and configure Network Interface for Bastion Public Subnet</h3>\n<div>Run the following command to create and configure a network interface:</div>\n<pre><code>az network nic create \\\n--name &lt;Bastion Nic Name&gt; \\\n--resource-group &lt;Resource group&gt; \\\n--location &lt;Location&gt; \\\n--subnet &lt;Bastion subnet Name&gt; \\\n--vnet-name &lt;Vnet Name&gt;</code></pre>\n<br/>\nAssign the Network Contributor and Reader role for cluster resource group \n<pre><code>az login --service-principal -u &lt;client ID&gt; -p &lt;Client Secret&gt; --tenant &lt;tenant ID&gt;\nget the Service principal display Name\n\n\naz ad sp list --display-name &lt;Display Name&gt;</code></pre>\n<h3><a id=\"Fetch_the_Id\" name=\"Fetch_the_Id\" title=\"Fetch the Id\"></a>Fetch the Id</h3>\n<p>Assign Network Contributor and Reader Role to the resource group we created earlier.</p>\n<pre><code>az role assignment create \\\n  --assignee \"ID\" \\\n  --role \"Network Contributor\" \\\n  --scope /subscriptions/6f33f7c2-ad9f-4cde-b090-e4065a475109/resourceGroups/&lt;Resource-Group&gt;\n\n\n\naz role assignment create   --assignee \"ID\"   --role \"Reader\"   --scope /subscriptions/&lt;Subscription ID&gt;/resourceGroups/&lt;Resource Group&gt;</code></pre>\n<h2><a id=\"Create_an_AKS_cluster\" name=\"Create_an_AKS_cluster\" title=\"Create an AKS cluster\"></a>Create an AKS cluster</h2>\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>IT / Kubernetes Cluster administrator</td>\n<td>Azure Cloud Shell</td>\n</tr>\n</tbody>\n</table>\n<p>To build an AKS cluster for the suite installation, make sure you have the <a href=\"https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#owner\" title=\"Owner role\"><b>Owner</b> role</a> and run this command in the Azure Cloud Shell:</p>\n<pre>az aks create \\\n --resource-group &lt;resource_group_name&gt; \\\n --name &lt;kubernetes_cluster_name&gt; \\\n --node-count &lt;node_number&gt; \\\n --max-pods 60 \\\n --dns-name-prefix &lt;dns_prefix_name&gt; \\\n --node-vm-size &lt;node_vm_size&gt; \\\n --network-plugin &lt;network_plugin&gt; \\\n --node-osdisk-size &lt;node_disk_size&gt; \\\n --nodepool-labels Worker=label role=loadbalancer \\\n --generate-ssh-keys \\\n --load-balancer-sku standard \\\n --vm-set-type VirtualMachineScaleSets \\\n --subscription &lt;subscription_id&gt; \\\n --vnet-subnet-id &lt;subnet_id&gt; \\\n --kubernetes-version &lt;kubernetes_version&gt; \\\n --enable-managed-identity \n</pre>\n<p>where:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 28px; position: relative;\"><code>&lt;resource_group_name&gt;</code>: Enter the name of the resource group created in the prerequisite tasks. For example, <em>myResourceGroup</em><i>.</i></li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;kubernetes_cluster_name&gt;</code>: Give a name to this Kubernetes cluster.</li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;node_number&gt;</code>: Specify the number of nodes in the Kubernetes node pool by referring to <a href=\"/doc/423/26.1/akssizing#SizingforSMAXdeployment\" title=\"SMAX:25.1/AKSSizing\">Sizing on Azure</a>.</li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;dns_prefix_name&gt;</code>: Enter the prefix for created hostnames. If not specified, generate a hostname using the managed cluster and resource group names.</li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;node_vm_size&gt;</code>: Specify the size of virtual machines to create as Kubernetes nodes by referring to <a href=\"/doc/423/26.1/akssizing#SizingforSMAXdeployment\" title=\"SMAX:25.1/AKSSizing\">Sizing on Azure</a>. For example, <em>Standard_D8s_v3</em>.</li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;network_plugin&gt;</code>: Specify the network plugin to create as this Kubernetes cluster's network model. You can use <strong>azure</strong> or <strong>kubenet</strong>.<strong> </strong>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-tip-icon\"></div><div class=\"admonition-content admonition-tip-content\"><div>To choose an <strong>azure</strong> or <strong>kubenet</strong> network plugin, refer to the <a href=\"https://docs.microsoft.com/en-us/azure/aks/operator-best-practices-network#kubenet-networking\" title=\"best practices\">best practices</a> recommended by Azure for more information.<br/>\n\tAccording to the Azure documentation, \"Kubenet is suitable for small development or test workloads, as you don't have to create the virtual network and subnets separately from the AKS cluster. Simple websites with low traffic, or to lift and shift workloads into containers, can also benefit from the simplicity of AKS clusters deployed with kubenet networking. For most production deployments, you should plan for and use Azure CNI networking. You can also configure your own IP address ranges and virtual networks using kubenet (see this <a href=\"https://docs.microsoft.com/en-us/azure/aks/configure-kubenet\" title=\"Azure document\">Azure document</a>).\"</div></div></div>\n</li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;node_disk_size&gt;</code>: Specify the size (<b>in GB</b>) of the OS disk for each node in the node pool by referring to <a href=\"/doc/423/26.1/akssizing#SizingforSMAXdeployment\" title=\"SMAX:25.1/AKSSizing\">Sizing on Azure</a>. For example, <em>100</em>.</li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;subscription_id&gt;</code>: Type your subscription ID. You can get it by navigating to the Azure portal <b>Home</b> page &gt; <b>Subscriptions</b>.</li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;subnet_id&gt;</code>: Type the AKS subnet ID collected in the prerequisite tasks. For example, <em>/subscriptions/xxx/resourceGroups/xxx/providers/Microsoft.Network/virtualNetworks/xxx/subnets/xxx</em>.</li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;kubernetes_version&gt;</code>: Specify a <a href=\"/doc/423/26.1/akssupportmatrix\" title=\"supported AKS version\">supported AKS version</a>. You can get all the Kubernetes versions supported in a location by running <code>az aks get-versions --location &lt;location&gt; --output table</code>. </li><li style=\"margin-left: 28px; position: relative;\">--enable-managed-identity: Enables a system-assigned identity. AKS will create a system-assigned kubelet identity in the Node resource group if you do not specify your own kubelet managed identity. To specify your own managed identity, see <a href=\"https://docs.microsoft.com/en-us/azure/aks/use-managed-identity#use-a-pre-created-kubelet-managed-identity\" title=\"Use a pre-created kubelet managed identity\">Use a pre-created kubelet managed identity</a></li></ul>\n<p><br/>\nYou can verify the AKS cluster status by running the following commands:</p>\n<pre>az aks get-credentials --resource-group &lt;resource_group_name&gt; --name &lt;kubernetes_cluster_name&gt;\nkubectl get nodes\n</pre>\n<p>where:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 28px; position: relative;\"><code>&lt;resource_group_name&gt;</code>: Enter the name of the resource group created in the prerequisite tasks. For example, <em>myResourceGroup</em><i>.</i></li><li style=\"margin-left: 28px; position: relative;\"><code>&lt;kubernetes_cluster_name&gt;</code>: Enter the name of the Kubernetes cluster created in the previous step.</li></ul>\n<div class=\"transcontent stn-begin--relatedTopics\"></div>\n<h2 class=\"mw-headline\" id=\"Related_topics\"><a id=\"External_references\" name=\"External_references\" title=\"External references\"></a>External references</h2>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 28px; position: relative;\">For AKS information, see <a class=\"external text\" href=\"https://docs.microsoft.com/en-us/azure/aks/\" rel=\"nofollow\" target=\"1\" title=\"AKS overview\">AKS overview</a>.</li><li style=\"margin-left: 28px; position: relative;\">For Azure Cloud Shell information, see <a class=\"external text\" href=\"https://docs.microsoft.com/en-us/azure/cloud-shell/overview\" rel=\"nofollow\" target=\"1\" title=\"Azure Cloud Shell\">Azure Cloud Shell</a>.</li><li style=\"margin-left: 28px; position: relative;\">For resource group information, see <a class=\"external text\" href=\"https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview#resource-groups\" rel=\"nofollow\" target=\"1\" title=\"Resource group\">Resource group</a>.</li><li style=\"margin-left: 28px; position: relative;\">For information on Azure Container Registry , see <a class=\"external text\" href=\"https://docs.microsoft.com/en-us/azure/container-registry/\" rel=\"nofollow\" target=\"1\" title=\"Azure Container Registry\">Azure Container Registry</a>.</li><li style=\"margin-left: 28px; position: relative;\">For information on SKU types of Azure Container Registry, see <a class=\"external text\" href=\"https://docs.microsoft.com/en-us/azure/container-registry/container-registry-skus\" rel=\"nofollow\" target=\"1\" title=\"SKUs\">SKUs</a>.</li><li style=\"margin-left: 28px; position: relative;\">For VNet and subnet information, see <a class=\"external text\" href=\"https://docs.microsoft.com/en-us/azure/virtual-network/\" rel=\"nofollow\" target=\"1\" title=\"Virtual network overview\">Virtual network overview</a>.</li><li style=\"margin-left: 28px; position: relative;\">For information on the supported Kubernetes versions in AKS, see <a class=\"external text\" href=\"https://docs.microsoft.com/en-us/azure/aks/supported-kubernetes-versions\" rel=\"nofollow\" target=\"1\" title=\"Supported Kubernetes versions in Azure Kubernetes Service\">Supported Kubernetes versions in Azure Kubernetes Service</a>.</li></ul>\n<div class=\"transcontent stn-end--relatedTopics\"></div>\n</div>",
  "modifiedon": "2025-12-10 06:43:40"
}