{
  "title": "Prepare File Storage - Subscribe premium Azure Files and Azure Disks(Helm)",
  "content": "<div class=\"mw-parser-output\">\n \n\n<p>This release supports <strong>NetApp Files</strong> or <strong>Azure Files and Azure Disks</strong> as the storage service on Azure.</p>\n<p>Due to the unstable performance of Azure Files, it's highly recommended that you deploy the suite using NetApp Files (see<a href=\"/doc/423/26.1/aksnfshelm\" title=\" Subscribe NetApp Files\"> Subscribe NetApp Files</a>).</p>\n<p>To use<strong> Azure</strong><strong> Files and Azure Disks</strong> as the storage service, you can use either of the following methods:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 28px; position: relative;\">Option 1: Azure File static provision and Azure Disk dynamic provision</li><li style=\"margin-left: 28px; position: relative;\">Option 2: Azure File dynamic provision and Azure Disk dynamic provision</li></ul>\n<p>You will need to create a premium Azure file share for your deployment first, and then refer to the appropriate section below for the method you want to use.</p>\n<h2><a id=\"Create_premium_Azure_file_share\" name=\"Create_premium_Azure_file_share\" title=\"Create premium Azure file share\"></a>Create premium Azure file share</h2>\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Storage administrator</td>\n<td>Bastion node</td>\n</tr>\n</tbody>\n</table>\n<p>To create and configure premium Azure file share, log on to the bastion and follow these steps:</p>\n<h3><a id=\"Add_network_information\" name=\"Add_network_information\" title=\"Add network information\"></a>Add network information</h3>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Go to <strong>Security</strong> &gt; <strong>Networking</strong> &gt; <strong>Network connectivity</strong>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\">Select <strong>Enable public access</strong> from selected networks and IP</li><li style=\"margin-left: 40px; position: relative;\">Select<strong> IP address</strong>, <strong>Bastion public IP</strong></li></ul>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">In the left navigation bar, select  <strong>DataStorage</strong>  &gt; <strong>File Share</strong>.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Create an entry named <code>itomfileshare</code> with 100 GB.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Leave protocol as SMB (associated vault for this subscription is lixue-test-AzureBackup)</li></ol>\n<h3><a id=\"Create_private_endpoint\" name=\"Create_private_endpoint\" title=\"Create private endpoint\"></a><a id=\"Create_private_end_point\" name=\"Create_private_end_point\" title=\"Create private  end point\"></a>Create private endpoint</h3>\n<div>To create a private endpoint:</div>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Go to <strong>All Services</strong> &gt; <strong>Private endpoints</strong> &gt; <strong>+Create</strong>. Enter the following details:\n\n\t<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\">Name &lt;prefix&gt;-private Resource</li><li style=\"margin-left: 40px; position: relative;\">Resource Type : Microsoft.Storage/storageAccounts</li><li style=\"margin-left: 40px; position: relative;\">Resource: created storage account</li><li style=\"margin-left: 40px; position: relative;\">Target subresource_name: file</li></ul>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Select the virtual network and aks-private-subnet</li></ol>\n<h3><a id=\"Update_AKS_Cluster_Private_Subnet\" name=\"Update_AKS_Cluster_Private_Subnet\" title=\"Update AKS Cluster Private Subnet\"></a><a id=\"Update_AKS_Cluster_Private_Subnet_Missing_Info_\" name=\"Update_AKS_Cluster_Private_Subnet_Missing_Info_\" title=\"Update AKS Cluster Private Subnet [Missing Info]\"></a>Update AKS Cluster Private Subnet </h3>\n<div>To update AKS cluster:</div>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Go to <strong>All Services</strong> &gt; <strong>Virtual network</strong> &gt; select your <strong>vnet</strong> &gt; <strong>settings</strong> &gt; <strong>subnets</strong></li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Select the <strong>AKS private subnet</strong>: Example: &lt;aks-private-subnet&gt;</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Update these details. Service Endpoints - Microsoft.sql and Private endpoint network policy - route table and nsg</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Get the subnet ID from the json view or edit subnet view to use it later</li></ol>\n<h3><a id=\"Create_log_analytics_workspace\" name=\"Create_log_analytics_workspace\" title=\"Create log analytics workspace\"></a><a id=\"Create_Log_analytics_workspace\" name=\"Create_Log_analytics_workspace\" title=\"Create Log analytics workspace\"></a>Create log analytics workspace</h3>\n<div>To create a log, run the following command:</div>\n<div>\n<pre><code>az monitor log-analytics workspace create \\ \n--resource-group &lt;resource_group_name&gt; \\ \n--workspace-name &lt;Log Analytics Workspace Name&gt;</code></pre>\n</div>\n<div>\n<h3><a id=\"Create_Azure_files_in_storage_account\" name=\"Create_Azure_files_in_storage_account\" title=\"Create Azure files in storage account\"></a><a id=\"Create_azure_files_in_storage_account\" name=\"Create_azure_files_in_storage_account\" title=\"Create azure files in storage account\"></a>Create Azure files in storage account</h3>\n<div>\n<p>To create and configure premium Azure file share, log on to the bastion and follow these steps:</p>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following command to create a FileStorage account:\n\n\t<pre>az storage account create \\\n    --resource-group &lt;resource_group_name&gt; \\\n    --name &lt;storage_account_name&gt; \\\n    --location &lt;location&gt; \\\n    --sku Premium_LRS \\\n    --kind FileStorage</pre>\n<p>In this command,</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><code>&lt;resource_group_name&gt;</code> is the name of the resource group you created on the <a href=\"/doc/423/25.4/akscluster#Prerequisites\" title=\"Build AKS cluster\">Build AKS cluster</a> page. Do <b>NOT</b> use your cluster's resource group name with the format <code>MC_&lt;resource_group&gt;_&lt;aks_cluster_name&gt;_&lt;location&gt;</code>.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;storage_account_name&gt;</code>: Define a name for this FileStorage account.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;location&gt;</code> is the location of the created resource group. For example, <i>westus2</i>.</li></ul>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following command to get the key of the created FileStorage account:\n\t<pre>az storage account keys list \\\n    --resource-group &lt;resource_group_name&gt; \\\n    --account-name &lt;storage_account_name&gt; \\\n    --query \"[0].value\" | tr -d '\"'</pre>\n<div>\n<div>After running the command, save the output. The <code>storage_account_key</code> will be used to create azure credentials later.</div>\n</div>\n<p>In this command,</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><code>&lt;resource_group_name&gt;</code> is the name of the resource group you created on the <a href=\"/doc/423/25.4/akscluster#Prerequisites\" title=\"Build AKS cluster\">Build AKS cluster</a> page. Do <b>NOT</b> use your cluster's resource group name with the format <code>MC_&lt;resource_group&gt;_&lt;aks_cluster_name&gt;_&lt;location&gt;</code>.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;storage_account_name&gt;</code> is the name of the created FileStorage account.</li></ul>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\"><strong>(Option 1 only)</strong> Create an Azure file share for storing the <b>generic</b> data (all data of OMT and the suite except the search engine and RabbitMQ), by running the following command.\n\t<pre>az storage share create \\\n--account-name &lt;storage_account_name&gt; \\\n--account-key &lt;storage_account_key&gt; \\\n--name \"&lt;fileshare_name&gt;\" \\\n--quota &lt;share_quota&gt;</pre>\n<p>In this command,</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><code>&lt;storage_account_name&gt;</code> is the name of the created FileStorage account.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;storage_account_key&gt;</code> is the key you got in the previous step.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;fileshare_name&gt;</code>: Specify a name for the Azure file share to store the <strong>generic</strong> data.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;share_quota&gt;</code>: Specify the size of the share (<b>in GB</b>) by referring to <a href=\"/doc/423/25.4/akssizing\" title=\"SMAX:Main/AKSSizing\">Sizing recommendations</a>. Must be greater than 0, and less than or equal to 5 TB (5120).</li></ul>\n</li></ol>\n</div>\n<h3><a id=\"Using_Static_provision_Azure_File_and_Azure_Disk_dynamic_provision\" name=\"Using_Static_provision_Azure_File_and_Azure_Disk_dynamic_provision\" title=\"Using Static provision Azure File and Azure Disk dynamic provision\"></a>Using Static provision Azure File and Azure Disk dynamic provision</h3>\n<p>To use a Static provision Azure File and Azure Disk dynamic provision for your deployment, use the following steps to configure storage volumes:</p>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Install the NFS client on the bastion:\n\n\t<pre>sudo yum install -y nfs-utils cifs-utils</pre>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Copy and save the following script as <code>mountazurefile.sh</code>:\n\t<pre>#!/bin/bash\nMOUNTPOINT=/mnt/nfs/$3\nsudo mkdir -p $MOUNTPOINT\nif [ ! -d \"/etc/smbcredentials\" ]; then\nsudo mkdir /etc/smbcredentials\nfi\nif [ ! -f \"/etc/smbcredentials/$1.cred\" ]; then\n    sudo bash -c \"echo username=$1 &gt;&gt; /etc/smbcredentials/$1.cred\"\n    sudo bash -c \"echo password=$2 &gt;&gt; /etc/smbcredentials/$1.cred\"\nfi\nsudo chmod 600 /etc/smbcredentials/$1.cred\nsudo bash -c \"echo //$1.file.core.windows.net/$3 $MOUNTPOINT cifs nofail,vers=3.0,credentials=/etc/smbcredentials/$1.cred,dir_mode=0775,file_mode=0775,serverino,mfsymlinks,uid=$4,gid=$5 &gt;&gt; /etc/fstab\"\nsudo mount -t cifs //$1.file.core.windows.net/$3 $MOUNTPOINT -o vers=3.0,credentials=/etc/smbcredentials/$1.cred,dir_mode=0775,file_mode=0775,serverino,mfsymlinks,uid=$4,gid=$5</pre>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following command to mount the Azure file share for the <b>generic</b> data to the bastion:\n\t<pre>sudo ./mountazurefile.sh  &lt;storage_account_name&gt; &lt;storage_account_key&gt; &lt;generic_fileshare_name&gt; &lt;system_user_id&gt; &lt;system_group_id&gt;\n</pre>\n<p>In this command,</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><code>&lt;storage_account_name&gt;</code> is the name of the created FileStorage account.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;storage_account_key&gt;</code> is the key you obtained when creating the Azure file share.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;generic_fileshare_name&gt;</code> is the name of the Azure file share for storing the <b>generic</b> data.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;system_user_id&gt;</code> and <code>&lt;system_group_id&gt;</code>: specify an operating system user ID and group ID that are used to run the process in the container, respectively. Both values must be 1999 or a number between 100000 and 2000000000.</li></ul>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following commands to create directories for the <b>generic</b> data:\n\t<pre>cd /mnt/nfs/&lt;generic_fileshare_name&gt;\nsudo mkdir  -p var/vols/itom/itsma/logging-volume\nsudo mkdir  -p var/vols/itom/itsma/config-volume\nsudo mkdir  -p var/vols/itom/itsma/data-volume</pre>\n<p>In these commands,</p>\n<p><code>&lt;generic_fileshare_name&gt;</code> is the name of the Azure file share for storing the <b>generic</b> data.</p>\n</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following command to test the performance of the Azure file share. <strong>Do not proceed if the result can't meet the minimum requirement.</strong>\n<pre>dd if=/dev/zero of=/mnt/nfs/&lt;generic_fileshare_name&gt;/small.img bs=512 count=10000 oflag=dsync</pre>\n<p>In this command, <code>&lt;generic_fileshare_name&gt;</code> is the name of the Azure file share for storing the <b>generic</b> data.</p>\n<p>The output should resemble the following:</p>\n<pre>10+0 records in\n10+0 records out\n5120 bytes (5.1 KB, 5.0 KiB) copied, 0.0713496 s, <span style=\"color: red\">71.8 KB/s</span></pre>\n<p>The minimum requirement for the suite installation is <strong>60 KB/s</strong>. Based on the performance tests, the command returns an output higher than 60 KB/s in most Azure regions.</p>\n<p>Any number smaller than that will cause the installation to fail. In this case, you have two options:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\">\n<p>Consider using <a href=\"/doc/423/26.1/aksnfshelm\" title=\"Azure NetApp Files\">Azure NetApp Files</a>.</p>\n</li><li style=\"margin-left: 40px; position: relative;\">\n<p>Contact Azure support to fix the performance issue.</p>\n</li></ul>\n</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Create a StorageClass for Azure Disks later. See <a href=\"/doc/423/26.1/preparepvsaks\" title=\"Prepare persistent storage for ESM on Azure\">Prepare persistent storage for ESM on Azure</a>.</li></ol>\n<h3><a id=\"Using_Dynamic_provision_for_both_Azure_File_and_Azure_Disk\" name=\"Using_Dynamic_provision_for_both_Azure_File_and_Azure_Disk\" title=\"Using Dynamic provision for both Azure File and Azure Disk\"></a>Using Dynamic provision for both Azure File and Azure Disk</h3>\n<p>To use dynamic provision for both Azure File and Azure Disk, you need to create a separate StorageClass for Azure Disks and Azure File. See <a href=\"/doc/423/26.1/preparepvsaks\" title=\" Prepare persistent storage for ESM on Azure\"> Prepare persistent storage for ESM on Azure</a>.</p>\n</div>\n</div>",
  "modifiedon": "2025-12-10 08:25:11"
}