{
  "title": "Enable SSL connections to external PostgreSQL after suite installation",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\"></p><div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>When Service Management sends an SSL connection request to an external PostgreSQL server that has SSL enabled, Service Management acts as a client. To enable Service Management to connect to the external PostgreSQL server through SSL, you must import the PostgreSQL CA certificate into Service Management. This can be done either during or after the suite installation. This topic describes how to enable PostgreSQL SSL connections after the suite installation. Additionally, this topic also describes how to replace the PostgreSQL CA certificate file in the suite. </p>\n<p><strong>Notes</strong>:</p>\n<ul>\n<li>This operation might cause system downtime. Perform this operation in a planned maintenance window.</li>\n<li>If the PostgreSQL server certificate is about to expire or is no longer valid, you need to replace it with another new certificate on the database server side. If the CA certificate chain of the new certificate is the same as the CA certificate chain of the old certificate, no action is required on the Service Management side.</li>\n<li>The PostgreSQL CA certificate (for example, <code>PG_CA.crt</code>) must be in PEM format. The CA certificate can be single-level or multi-level. If multi-level, the CA certificate must include the entire CA certificate chain (the root CA certificate and all intermediate CA certificates). The following are example commands to combine multi-level CA certificates.\n\t<pre>cat thirdCA.crt&gt;&gt;PG_CA.crt\ncat secondCA.crt&gt;&gt;PG_CA.crt\ncat rootCA.crt&gt;&gt;PG_CA.crt\n</pre>\n</li>\n</ul>\n<h2>Obtain the PostgreSQL CA certificate</h2>\n<p>Follow the instructions on how to obtain the PostgreSQL CA certificate for your PostgreSQL server according to its deployment platform.</p>\n<h3>On-premises</h3>\n<p>When the PostgreSQL server is on-premises, use the CA certificate that you configure when enabling SSL for the PostgreSQL server.</p>\n<h3>AKS</h3>\n<p>Follow the <a href=\"https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/how-to-connect-tls-ssl\" target=\"1\" title=\"TLS in Azure Flexible Server\">TLS in Azure Flexible Server</a> document to enforce TLS for all connections to your Azure Flexible Server and then download a PostgreSQL CA certificate file.</p>\n<h3>AWS</h3>\n<p>Download a root certificate that works for all AWS Regions from the <a href=\"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL.html\" target=\"1\" title=\"Amazon Relational Database Service\">Amazon Relational Database Service</a> website.</p>\n<h3>GCP</h3>\n<p>Follow the <a href=\"https://cloud.google.com/sql/docs/sqlserver/configure-ssl-instance\" target=\"1\" title=\"Google Cloud\">Google Cloud</a> documentation to enforce SSL/TLS for all connections to your Cloud SQL instance and then download a PostgreSQL CA certificate file.</p>\n<h2>Prerequisites</h2>\n<p>To enable SSL connection to external database server or replace the database server CA certificate chain in Service Management, you need to do the following step:</p>\n<h3>Classic deployment</h3>\n<p>To enable SSL connection to external database server or replace the database server CA certificate chain in Service Management, you need to run the script <strong>updateSMAExternalDBInfo.sh</strong>. For a managed Kubernetes environment, you must run the script on the runtime platform provided by the <a href=\"https://marketplace.microfocus.com/itom/content/service-management-automation-support-assistant\" title=\"SMA Support Assistant\">Service Management Support Assistant</a>. For an embedded Kubernetes environment, you can run the script either on a control plane node or on the runtime platform.</p>\n<ul>\n<li>Download the <a href=\"https://marketplace.microfocus.com/itom/content/service-management-automation-operation-toolkit\" target=\"1\" title=\"SMA Operation Toolkit\">Service Management Operation Toolkit</a>  to a control plane node (in an embedded Kubernetes environment) or to a bastion node (in a managed Kubernetes environment). Uncompress the package and locate the <strong>updateSMAExternalDBInfo.sh</strong> script and <strong>component.json</strong> in the <strong>db_connection_management</strong> folder.</li>\n<li>Upload the PostgreSQL CA certificate to the node on which you will run the script. </li>\n<li>If you need to install the runtime platform, please see <a href=\"/doc/423/26.1/tookitcontainer#Install_the_runtime_platform\" title=\"Install the runtime platform\">Install the runtime platform</a> to set up the toolkit. Prepare the script and the PostgreSQL CA certificate chain file on the runtime platform by referring to <a href=\"/doc/423/26.1/tookitcontainer#Prepare_scripts_on_the_runtime_platform\" title=\"Prepare the scripts on the runtime platform\">Prepare the scripts on the runtime platform</a>.</li>\n<li>For an embedded Kubernetes, if CMP FinOps or DND are installed and you plan to run the script on a control plane node, please upload the PostgreSQL CA (with file extension .crt) to the NFS folder <strong>&lt;global-volume&gt;/certificate/cmp/source</strong> manually. Change the file ownership with the correct UID and GID. For example, run the following command:\n\t<div contenteditable=\"false\" tabindex=\"-1\">\n<pre><code> chown 1999:1999 *.crt</code></pre>\n</div>\n</li>\n</ul>\n<h3>Helm deployment</h3>\n<p>To enable SSL connection to external database server or replace the database server CA certificate chain in Service Management, you need to do the following step:</p>\n<ul>\n<li>To avoid system downtime, you may download the <a href=\"https://marketplace.opentext.com/itom/content/service-management-automation-operation-toolkit\" title=\"SMA Operation Toolkit\">Service Management Operation Toolkit</a> package (<strong>SMA-operation-toolkit-xxxx.xx.tar.gz</strong> and <strong>SMA-operation-toolkit-xxxx.xx.tar.gz.sig</strong>) and upload it to a control plane node (in an embedded Kubernetes environment) or to the bastion node (in a managed Kubernetes environment). Extract the package by running the command <code>tar zxvf SMA-operation-toolkit-xxxx.xx.tar.gz</code>. Then, you can use the <strong>helm-restart-db-pods.sh</strong> script to perform a rolling restart of the database-related pods later.</li>\n</ul>\n<h2>Enable Service Management to connect to external PostgreSQL through SSL</h2>\n<p>If you did not enable PostgreSQL SSL during the suite installation and want to do this now (after the installation) or you have previously enabled PostgreSQL SSL but now want to replace the PostgreSQL CA certificate chain, follow the instructions in this section. Before you proceed, make sure that you have already enabled SSL on the PostgreSQL server. The following PostgreSQL SSL modes are supported:</p>\n<ul>\n<li><strong>verify-ca</strong>: the client will verify that the server is trustworthy by checking the certificate chain up to a trusted certificate authority (CA).</li>\n<li><strong>verify-full</strong>: the client will also verify that the server hostname matches the common name in the server certificate. The SSL connection will fail if the server certificate can't be verified. This mode is recommended in most security-sensitive environments.</li>\n</ul>\n<h3>Classic deployment</h3>\n<p>If you prepared the <strong>updateSMAExternalDBInfo.sh</strong>  script on the runtime platform, run the script by referring to <a href=\"/doc/423/26.1/tookitcontainer#Run_scripts_on_the_runtime_platform\" title=\"Run the scripts on the runtime platform\">Run the scripts on the runtime platform</a>. Before running the script, please replace the following parameters in the commands to be run next:</p>\n<ul>\n<li>Replace <strong>&lt;certificate-file-path&gt;</strong> with your CA certificate chain file name along with the path in the next commands. Make sure you have permission to access the CA certificate chain file before running the commands. <bre> </bre></li>\n<li><bre> Replace <strong>&lt;ssl-mode&gt;</strong> with the supported value. If you have previously enabled PostgreSQL SSL connection with a supported SSL mode in Service Management and only want to replace the CA certificate chain this time, remove \" <code>--secure --ssl_mode &lt;ssl-mode&gt;</code>\" from the commands.  <bre> </bre> </bre></li>\n<li><bre> <bre> Replace <strong>&lt;backup-folder&gt;</strong> with your folder used to back up the configmap in the yaml file. </bre> </bre></li>\n</ul>\n<p>If all components use the same database instance, follow these steps:</p>\n<ol>\n<li>Enable SSL connection to the database server and apply the CA certificate chain for all components by running the following command:\n\t<pre><code>updateSMAExternalDBInfo.sh --component all --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart </code></pre>\n</li>\n<li>Check the status of each related pod's component. If the status of each related pod is running, the component can successfully connect to the external database through SSL.</li>\n</ol>\n<p>Otherwise, follow these steps:</p>\n<ol>\n<li>Enable SSL connection to the database server and apply the CA certificate chain for the <strong>Service Management</strong>-related components by running the following commands:\n\n\t<pre><code>updateSMAExternalDBInfo.sh --component ServiceManagement --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart \nupdateSMAExternalDBInfo.sh --component ServiceManagementReadOnly --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart\nupdateSMAExternalDBInfo.sh --component SuiteAdministration --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart\nupdateSMAExternalDBInfo.sh --component Idm --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart\nupdateSMAExternalDBInfo.sh --component SmartAnalytics --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart\nupdateSMAExternalDBInfo.sh --component Autopass --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart</code></pre>\n</li>\n<li>Enable SSL connection to the database server and apply the CA certificate chain for the<strong> CMP, CMP FinOps, </strong>and <strong>DND</strong> components if they are installed. These three components need the CA certificate chain file to be placed in NFS folder <strong>&lt;global-volume&gt;/certificate/cmp/source</strong> with correct UID and GID (for example, 1999). Run the following commands:\n\t<pre><code>updateSMAExternalDBInfo.sh --component CMPFinOps --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart\nupdateSMAExternalDBInfo.sh --component CMP --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart\nupdateSMAExternalDBInfo.sh --component DND --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart</code></pre>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-note-icon\"></div>\n<div class=\"admonition-content admonition-note-content\">The CMP component is required only if you have DND or CMP FinOps installed; the DND component is required only if you have DND installed; the CMP FinOps component is required only if you have CMP FinOps installed.</div>\n</div>\n</li>\n<li>Enable an SSL connection on the database server and apply the certificate for the <strong>SAM </strong>component if it's installed by running the following command:\n\t<pre><code>updateSMAExternalDBInfo.sh --component SAM --secure --ssl_mode &lt;ssl-mode&gt; --cacert &lt;certificate-file-path&gt; -b &lt;backup-folder&gt; --restart</code></pre>\n</li>\n<li>Check the status of each related pod's component. If the status of each related pod is running, the component can successfully connect to the external database through SSL.</li>\n</ol>\n<h4>Enable OMT to connect to external PostgreSQL through SSL</h4>\n<p>To enable OMT to connect to external PostgreSQL through SSL, run the command <code>$CDF_HOME/bin/updateExternalDbInfo</code> to modify the following configurations:</p>\n<ul>\n<li><strong>-s|--ssl</strong> specifies whether to enable the SSL connection. Optional choices are (\"on\",\"off\").</li>\n<li><strong>--cacert FILE</strong> specifies the ca certificate. </li>\n</ul>\n<p>For more information, see <a href=\"/doc/423/26.1/modifyexternaldbconfig\" title=\"Modify the OMT external database configuration\">Modify the OMT external database configuration</a>. </p>\n<h3>Helm deployment</h3>\n<p>Perform the following steps.</p>\n<ol>\n<li>[Optional] Run the following command to get the release name of the deployment:\n\t<pre><code>helm list -n &lt;ESM_NAMESPACE&gt; | awk '{print $1}'</code></pre>\n\tWhere <strong>&lt;ESM_NAMESPACE&gt;</strong> is the unique namespace of the Service Management deployment.</li>\n<li>[Optional] Run the following command to extract the deployment YAML values to <strong>my-values.yaml</strong> file:\n\t<pre>helm get values &lt;ESM_RELEASE_NAME&gt; -n &lt;ESM_NAMESPACE&gt; &gt; my-values.yaml</pre>\n\tWhere <strong>&lt;ESM_RELEASE_NAME&gt;</strong> is the release name obtained in Step 1.</li>\n<li>Edit the <strong>my-values.yaml</strong> file, enable SSL connection by setting <code>tlsEnabled</code> to true. Your single cert or cert chain should be in one file. Then you can choose to paste the PEM content directly or encrypt the contents inside the certificate PEM file using the Base64 encryption method.  (e.g cat &lt;certFile&gt; | base64).  For example: \n\t<pre>global:\n  database:\n    tlsEnabled: true\n    tlsMode: verify-full    # or use verify-ca\n\n... ...\ndatabase:\n  caCertificates: \n    pg_ca.crt: &lt;cert-file-base64-encoded&gt; or PEM</pre>\n</li>\n<li>Run the following command to clean up unused jobs before applying the changes:\n\t<pre><span style=\"font-size:11.0pt\"><span style=\"font-family:Calibri\">kubectl get job -n </span></span>&lt;ESM_NAMESPACE&gt;<span style=\"font-size:11.0pt\"><span style=\"font-family:Calibri\">|grep -v NAME | awk '{print $1}'|xargs kubectl delete job -n </span></span>&lt;ESM_NAMESPACE&gt;</pre>\n</li>\n<li>Run the following commands to apply DB setting change: \n\t<pre>helm upgrade &lt;ESM_RELEASE_NAME&gt; &lt;ESM_HELM_CHART_PATH&gt; -n &lt;ESM_NAMESPACE&gt; -f my-values.yaml</pre>\n<p>Where <strong>&lt;ESM_HELM_CHART_PATH&gt;</strong> is the tar file in the extracted patch package containing the installation file. This file is located in the <strong>charts </strong>folder. For example:</p>\n<pre>helm upgrade sma ESM_Helm_Chart-2x.x.x/charts/esm-1.0.0+2x.x-xxx.tgz -n itsma -f  my-values.yaml</pre>\n</li>\n<li>Run the following command to make sure the sma-approle-secret-init-job-xxx  pod status is completed before next step. \n\t<pre>kubectl get pod -n &lt;<em>ESM_NAMESPACE</em>&gt; |grep sma-approle-secret-init-job</pre>\n</li>\n<li>\n<div>If a system downtime is acceptable:</div>\n<ol start=\"1\">\n<li>\n<div>Run the following command to stop the suite after completing the upgrade.</div>\n<pre>$CDF_HOME/bin/cdfctl runlevel set -l DOWN -n &lt;ESM_NAMESPACE&gt;\n</pre>\n</li>\n<li>\n<div>Run the following command to restart.</div>\n<pre>$CDF_HOME/bin/cdfctl runlevel set -l UP -n &lt;ESM_NAMESPACE&gt;</pre>\n</li>\n</ol>\n</li>\n<li>\n<div>If system downtime is unacceptable, go to the path where you extracted the <a href=\"https://marketplace.opentext.com/itom/content/service-management-automation-operation-toolkit\" title=\"SMA Operation Toolkit\">Service Management Operation Toolkit</a> package, in the subfolder <strong>db_connection_management</strong>, run <strong>helm-restart-db-pods.sh</strong> script to perform a rolling restart of the database-related pod.</div>\n</li>\n</ol>\n<h2 id=\"(Optional) Enforce_TLSv1.3_on_the_PostgreSQL_server\">(Optional) Enforce TLSv1.3 on the PostgreSQL server</h2>\n<p>To enforce TLSv1.3, set the <a href=\"https://postgresqlco.nf/doc/en/param/ssl_min_protocol_version/\" title=\"ssl_min_protocol_version\"><strong>ssl_min_protocol_version</strong></a> and <strong><a href=\"https://postgresqlco.nf/doc/en/param/ssl_max_protocol_version/\" title=\"ssl_max_protocol_version\">ssl_max_protocol_version</a></strong> parameters to <strong>TLSv1.3</strong> on the PostgreSQL server side. </p>\n<ul>\n<li>For an on-premises environment, you can set <strong>ssl_min_protocol_version=TLSv1.3</strong> and <strong>ssl_max_protocol_version=TLSv1.3 </strong>in the <code>postgresql.conf</code> file, then run the <code>select pg_reload_conf()</code> SQL statement to apply the change without restarting the PostgreSQL database server. On the PostgreSQL database server, you also need to make sure the OpenSSL version is 1.1.1 or greater, which supports TLSv1.3.</li>\n<li>For EKS, see <a href=\"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithDBInstanceParamGroups.html\" title=\"Working with DB parameter groups\">Working with DB parameter groups</a> for details.</li>\n<li>For AKS, see <a href=\"https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-server-parameters\" title=\"Server parameters in Azure Database for PostgreSQL - Flexible Server\">Server parameters in Azure Database for PostgreSQL - Flexible Server</a> for details.</li>\n<li>For GCP, see <a href=\"https://cloud.google.com/sql/docs/postgres/flags\" title=\"Configure database flags\">Configure database flags</a> for details.</li>\n</ul>\n<h2></h2>\n<p class=\"mw-empty-elt\"></p></div>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}