{
  "title": "Generate vault secrets (OpenShift)",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\"></p><div class=\"mw-parser-output\">\n<h2>Generate vault secrets for the UD/UCMDB charts</h2>\n<p>Perform the following tasks to generate vault secrets for the UD/UCMDB charts:</p>\n<ol>\n<li>\n<p>On the bastion node, run the following command:</p>\n<pre>$CDF_HOME/scripts/gen_secrets.sh -n &lt;<em>UD/UCMDB NAMESPACE</em>&gt; -c &lt;<em>UD/UCMDB CHART FILE</em>&gt; -o &lt;<em>SECRETS YAML FILE</em>&gt;</pre>\n<p>Where:</p>\n<ul>\n<li>\n<p><code>&lt;<em>UD/UCMDB NAMESPACE</em>&gt;</code> is the unique namespace of the UD/UCMDB deployment. Use the name that you specified when creating the project for UD/UCMDB deployment in OpenShift.</p>\n</li>\n<li>\n<p><code>&lt;<em>UD/UCMDB CHART FILE</em>&gt;</code> is the tar file containing the UD/UCMDB installation charts (<strong>ucmdb-1.x.x+</strong><b>2x.x.x-</b><strong>xxx.tgz</strong>)</p>\n</li>\n<li>\n<p><code>&lt;<em>SECRETS YAML FILE</em>&gt;</code> is the YAML file that stores the UD/UCMDB secrets. Specify the file name (for example, <strong>cms-secrets.yaml</strong>), and then the script will generate this YAML file after you run the script. You will need to use this file when you run the command to install UD/UCMDB later.</p>\n</li>\n</ul>\n<p>For example:</p>\n<pre>/opt/cdf/scripts/gen_secrets.sh -n ucmdb-prod -c UCMDB_Helm_Chart-2x.x/ucmdb-helm-charts/charts/ucmdb-1.xx.x-xxx+2x.x.x.tgz -o cms-secrets.yaml</pre>\n</li>\n<li>\n<p>The Vault secret utility will prompt you for the following passwords. </p>\n<table>\n<caption>Entering passwords</caption>\n<thead>\n<tr>\n<th scope=\"col\">\n<p>Key</p>\n</th>\n<th scope=\"col\">\n<p>Required?</p>\n</th>\n<th scope=\"col\">\n<p>Description</p>\n</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>\n<p>ITOM_DB_PASSWD_KEY</p>\n</td>\n<td>\n<p>No</p>\n</td>\n<td>\n<p>Internal PostgreSQL database root password.</p>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-important-icon\"></div>\n<div class=\"admonition-content admonition-important-content\">Useless in the current scenario because the internal PostgreSQL database is only for deploying UD/UCMDB in the demo mode. However, in this version, you must enter an arbitrary value conforming to the password policy to pass the check by the script.</div>\n</div>\n</td>\n</tr>\n<tr>\n<td>\n<p>idm_db_password</p>\n</td>\n<td>\n<p>No</p>\n</td>\n<td>\n<p>IdM database password.</p>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-important-icon\"></div>\n<div class=\"admonition-content admonition-important-content\">Useless in the current scenario because when using the shared IdM solution, UD/UCMDB uses the suite IdM. Press <strong>Enter</strong> to get a random value and continue.</div>\n</div>\n</td>\n</tr>\n<tr>\n<td>\n<p>idm_admin_admin_password</p>\n</td>\n<td>No</td>\n<td>\n<p>UD/UCMDB admin user password.</p>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-important-icon\"></div>\n<div class=\"admonition-content admonition-important-content\">Useless in the current scenario because when using the shared IdM solution, UD/UCMDB and Service Management share the administer account <strong>suite-admin</strong>.\n\n\t\t\t\t<p>However, in this version, you must enter an arbitrary value conforming to the password policy to pass the check by the script.</p>\n</div>\n</div>\n</td>\n</tr>\n<tr>\n<td>\n<p>idm_sysadmin_admin_password</p>\n</td>\n<td>\n<p>No</p>\n</td>\n<td>\n<p>UD/UCMDB sysadmin user password.</p>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-important-icon\"></div>\n<div class=\"admonition-content admonition-important-content\">Useless in the current scenario because when using the shared IdM solution, UD/UCMDB and Service Management share the administer account <strong>suite-admin</strong>.\n\n\t\t\t\t<p>However, in this version, you must enter an arbitrary value conforming to the password policy to pass the check by the script.</p>\n</div>\n</div>\n</td>\n</tr>\n<tr>\n<td>idm_audit_integration_password</td>\n<td>No</td>\n<td>\n<p>IdM audit integration password.</p>\n<p>If you use the Audit service for UD/UCMDB, enter the password of the user used for the audit integration. Otherwise, just press <strong>Enter</strong> to get a random value and continue.</p>\n<p>For more information about enabling UD/UCMDB Audit, see <a href=\"/doc/423/26.1/enableaudit#Enable_Audit_for_CMS\" title=\"Enable Audit for UD/UCMDB\">Enable Audit for UD/UCMDB</a>.</p>\n</td>\n</tr>\n<tr>\n<td>\n<p>autopass_db_password</p>\n</td>\n<td>\n<p>Yes</p>\n</td>\n<td>\n<p>Autopass database password.</p>\n<p>Enter the password that you use when you create the database. See <a href=\"/doc/423/26.1/cmswithsmaxprepareexternaldbopenshift#Create_CMS_database_users_and_databases\" title=\"Create database users and databases for UD/UCMDB\">Create database users and databases for UD/UCMDB</a>.</p>\n</td>\n</tr>\n<tr>\n<td>\n<p>ucmdb_server_db_password</p>\n</td>\n<td>\n<p>Yes</p>\n</td>\n<td>\n<p>UCMDB Server database password.</p>\n<p>Enter the password that you use when you create the database. See <a href=\"/doc/423/26.1/cmswithsmaxprepareexternaldbopenshift#Create_CMS_database_users_and_databases\" title=\"Create database users and databases for UD/UCMDB\">Create database users and databases for UD/UCMDB</a>.</p>\n</td>\n</tr>\n<tr>\n<td>\n<p>ucmdb_master_key</p>\n</td>\n<td>\n<p>No</p>\n</td>\n<td>\n<p>UCMDB master key.</p>\n<p>Press <strong>Enter</strong> to get a random value and continue.</p>\n<p>This key is required only if you're reinstalling UD/UCMDB with an existing database  that is used by the previous UD/UCMDB installation.</p>\n</td>\n</tr>\n<tr>\n<td>\n<p>ucmdb_probe_pg_probe_password</p>\n</td>\n<td>\n<p>Yes if you deploy a probe</p>\n</td>\n<td>\n<p>Data flow probe database password.</p>\n<p>Enter the password that you use when you create the database. See <a href=\"/doc/423/26.1/cmswithsmaxprepareexternaldbopenshift#Create_CMS_database_users_and_databases\" title=\"Create database users and databases for UD/UCMDB\">Create database users and databases for UD/UCMDB</a>.</p>\n<p>However, if you don't deploy the data flow probe, in this version, you still need to enter an arbitrary value conforming to the password policy to pass the check by the script.</p>\n</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ol>\n<h2>Update UD/UCMDB secret with suite IdM secrets</h2>\n<div class=\"transcontent stn-begin--UpdateCmsSecret\"> </div>\n<p>With the shared IdM solution, you need to update <strong>cms-secret </strong>with suite IdM secrets so that you can deploy UD/UCMDB as the next deployment of Service Managementwith the right secrets.</p>\n<p>You can create a <strong>cms_shared_idm_vault_secret.sh </strong>to help you get IdM related keys from Service Management and update the keys for UD/UCMDB secret.</p>\n<p>To do this, follow these steps:</p>\n<ol>\n<li>\n<p>On the bastion node, copy and save the following scripts as <strong>cms_shared_idm_vault_secret.sh</strong>:</p>\n<pre><code>#!/bin/bash\n\ndescription() {\n    echo \"--------------------------------------------------\"\n    echo \"-- Shared IdM Vault-secrets Utility --\"\n    echo \"--------------------------------------------------\"\n    echo \" \"\n}\n\nusage() {\n    echo \"Usage: $0  [-p|--password &lt;ucmdb_integration_admin_password&gt;] [-n|--namespace &lt;ucmdb_namespace&gt;]\"\n    echo \"       -p|--password             Password when creating UD/UCMDB integration admin user in suite IdM.\"\n    echo \"       -n|--namespace            Namespace when generating vault secrets.\"\n    echo \"       -f|--file                 The cms-secrets.yaml file.\"\n    echo \"       -h|--help                 Show help.\"\n    echo -e \" \"\nexit 1\n}\nwhile [[ ! -z $1 ]] ; do\n    case \"$1\" in\n        -p|--password)\n        case \"$2\" in\n            -*) echo \"The -p|--password parameter requires a value. \" ; exit 1 ;;\n            *)  if [[ -z $2 ]] ; then echo \"The -p|--password parameter requires a value. \" ; exit 1 ; fi ; integration_admin_password=$2 ; shift 2 ;;\n        esac ;;\n         -n|--namespace)\n        case \"$2\" in\n            -*) echo \"-n|--namespace. \" ; exit 1 ;;\n            *)  if [[ -z $2 ]] ; then echo \"The -n|--namespace parameter requires a value. \" ; exit 1 ; fi ; ucmdb_namespace=$2 ; shift 2 ;;\n        esac ;;\n         -f|--file)\n        case \"$2\" in\n            -*) echo \"-f|--file. \" ; exit 1 ;;\n            *)  if [[ -z $2 ]] ; then echo \"The -f|--file parameter requires a value. \" ; exit 1 ; fi ; file_location=$2 ; shift 2 ;;\n        esac ;;\n        *|-*|-h|--help|/?|help) usage ;;\n    esac\ndone\n\n\nif [ -z \"$integration_admin_password\" ];then\n    echo \"Abort! The value of &lt;ucmdb_integration_admin_password&gt; is missing.\"\n    exit 1\nfi\n\nif [ -z \"$ucmdb_namespace\" ];then\n    echo \"Abort! The value of &lt;ucmdb_namespace&gt; is missing.\"\n    exit 1\nfi\n\nif [ -z \"$file_location\" ];then\n    echo \"Abort! The value of &lt;file_location&gt; is missing.\"\n    exit 1\nfi\n\nfunction get_suite_namespace(){\n  echo \"$(kubectl get configmaps --all-namespaces -o=jsonpath='{range .items[?(@.metadata.name==\"itom-bo-configmap\")]}{.metadata.namespace}{end}')\"\n}\n\nfunction get_secret() {\n    local key=${1}\n    local role=${2}\n    local ITOM_BO_UI_POD=$(kubectl get pods -n ${NAMESPACE} | grep -m1 itom-bo-login | awk '{print $1}')\n    PASSWORD=$(kubectl exec -it ${ITOM_BO_UI_POD} -n ${NAMESPACE} -c itom-bo-login -- bash -c \"/bin/get_secret ${key} ${role}\")\n    PASSWORD=${PASSWORD//PASS=/}\n    echo ${PASSWORD%$'\\r'}\n}\n\ndeclare NAMESPACE=$(get_suite_namespace)\ndeclare HPSSO_INIT_STRING=$(get_secret \"lwsso_init_string_secret_key\" \"itom-itsma-config\")\ndeclare HPSSO_INIT_STRING_KEY=$(echo -n $HPSSO_INIT_STRING|base64)\ndeclare CMS_INTEGRATION_ADMIN_PASSWORD_KEY=$(echo -n $integration_admin_password|base64)\ndeclare IDM_TRANSPORT_USER_PASSWORD=$(get_secret \"idm_transport_user_password_secret_key\" \"itom-idm\")\ndeclare IDM_TRANSPORT_USER_PASSWORD_KEY=$(echo -n $IDM_TRANSPORT_USER_PASSWORD|base64)\n\n\nget_smax_idm_related_keys(){\n    echo \"===== Get suite IdM Related Keys =====\"\n    echo \"Getting four suite IdM related keys.\"\n    if [ \"$HPSSO_INIT_STRING_KEY\" ];then\n    echo \"Get HPSSO_INIT_STRING_KEY successfully.\"\n    else\n    echo \"Fail to get HPSSO_INIT_STRING_KEY.\"\n    fi\n    if [ \"$CMS_INTEGRATION_ADMIN_PASSWORD_KEY\" ];then\n    echo \"Get idm_integration_admin_password successfully.\"\n    else\n    echo \"Fail to get idm_integration_admin_password.\"\n    fi\n    if [ \"$IDM_TRANSPORT_USER_PASSWORD_KEY\" ];then\n    echo \"Get  idm_transport_admin_password successfully.\"\n    else\n    echo \"Fail to get idm_transport_admin_password.\"\n    fi\n    \n}\n\nupdate_cms_secret(){\n    echo \"===== Find cms-secrets.yaml Location =====\"\n    if [ -e $file_location ]; then\n    echo \"Successful\"\n    else\n    echo \"Fail to find cms-secrets.yaml.\"\n    fi\n    echo \"===== Update cms-secrets.yaml File =====\"\n    sed -i -e \"s/HPSSO_INIT_STRING_KEY.*$/HPSSO_INIT_STRING_KEY: ${HPSSO_INIT_STRING_KEY}/g\" $file_location\n    sed -i -e \"s/idm_integration_admin_password.*$/idm_integration_admin_password: ${CMS_INTEGRATION_ADMIN_PASSWORD_KEY}/g\" $file_location\n    sed -i -e \"s/idm_transport_admin_password.*$/idm_transport_admin_password: ${IDM_TRANSPORT_USER_PASSWORD_KEY}/g\" $file_location\n}\n\nmain(){\n    description\n    get_smax_idm_related_keys\n    update_cms_secret\n}\n\n\nmain\n</code></pre>\n</li>\n<li>\n<p>Configure permission for the script:</p>\n<pre>chmod 755 cms_shared_idm_vault_secret.sh\n</pre>\n</li>\n<li>\n<p>Run the following command to execute the <strong>cms_shared_idm_vault_secret.sh </strong>script:</p>\n<pre>./cms_shared_idm_vault_secret.sh -p <i>&lt;ucmdb_integration_admin_password&gt;</i> -n <i>&lt;<code>UD/UCMDB NAMESPACE</code>&gt;</i> -f <em>&lt;SECRETS YAML FILE&gt;</em></pre>\n<p>Where,</p>\n<ul>\n<li><code><em>&lt;ucmdb_integration_admin_password&gt;</em> </code>is the IdM integration admin password that you set in <a href=\"/doc/423/26.1/createcmsroleuserinsmaidmopenshift\" title=\"Create UD/UCMDB integration admin user in the suite IdM (OpenShift)\">Create UD/UCMDB integration admin user in the suite IdM (OpenShift)</a> for <strong>ucmdb-integration-admin</strong>.</li>\n<li><em><code>&lt;UD/UCMDB NAMESPACE&gt;</code></em> is the unique name of the namespace for the UD/UCMDB deployment. </li>\n<li><em><code>&lt;SECRETS YAML FILE&gt;</code></em><strong> </strong>is the YAML file that stores the UD/UCMDB secrets. Specify the YAML file (for example, <strong>cms-secrets.yaml</strong>) when you run the <strong>gen_secrets.sh</strong> script to generate vault secrets for the UD/UCMDB charts in the previous step. </li>\n</ul>\n</li>\n</ol>\n<p>After you successfully run the script, the following keys are updated:</p>\n<ul>\n<li>HPSSO_INIT_STRING_KEY</li>\n<li>idm_integration_admin_password</li>\n<li>idm_transport_admin_password</li>\n</ul>\n</div>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}