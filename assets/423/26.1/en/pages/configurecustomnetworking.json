{
  "title": "Configure Custom Networking (EKS)",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\"></p><div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>IT / Network administrator</td>\n<td>AWS Management Console</td>\n</tr>\n</tbody>\n</table>\n<p>The number of IPv4 addresses available in the subnet that hosts the primary network interface is limited, this might limit the number of Pods you can create in the subnet. Using a different subnet for secondary network interfaces can increase the number of IPv4 addresses available for Pods. To create a subnet for secondary network interfaces, you will need to configure custom networking to associate different security groups to the secondary network interfaces.</p>\n<p>This topic helps you configure custom networking. For more details on custom networking, see <a href=\"http://docs.aws.amazon.com/eks/latest/userguide/cni-custom-network.html\" title=\"AWS Custom Networking\">AWS official documentation</a>.</p>\n<h2>Configure custom networking</h2>\n<p>Perform the following steps to configure custom networking for your deployment.</p>\n<h3>Configure VPC</h3>\n<ol>\n<li>Log in to the AWS Management Console and switch to the selected region</li>\n<li>Go to <strong>All services</strong> &gt; <strong>Management &amp; Governance</strong> &gt; <strong>CloudFormation</strong>.</li>\n<li>Click <strong>Create stack</strong> &gt; <strong>With new resources(standard)</strong>, click <strong>Template is ready</strong> &gt; <strong>Upload a template file</strong> &gt; <strong>Choose file</strong> and select the <code>custom-networking.template</code> file under directory <code>../Cloud Deployment x.x.x/../byok/smax-cloudformation-aws</code> in the <a href=\"/doc/423/26.1/downloadcloudpackage\" title=\"Download the cloud deployment package\">cloud deployment package</a>.</li>\n<li>Click <strong>Next </strong>and populate the following fields.\n\t<ul>\n<li><strong>Stack name</strong>: Give a name to this stack, such as <code>eks-custom-netwoking</code>.</li>\n<li><strong>MyVPC</strong>: Select the created <strong>VPC </strong>from the drop-down list.</li>\n<li><strong>VPCCIDR</strong>: Define a new <strong>Classless Inter-Domain Routing</strong> (<strong>CIDR</strong>) to associate additional IPv4 CIDR blocks with your VPC.</li>\n<li><strong>Private Subnet 1/2/3 CIDR</strong>: New <strong>Private Subnet 1/2/3</strong>, with <strong>CIDR </strong>equal to or larger than 24.</li>\n<li><strong>EKS Cluster Name</strong>: Enter the EKS cluster name you defined in the <a href=\"/doc/423/26.1/eksvpc\" title=\"Prepare VPC\">Prepare VPC</a> step. You must use the same EKS cluster name when creating the VPC, EKS cluster, and worker nodes; otherwise, the suite installation will fail.</li>\n</ul>\n</li>\n<li>Click <strong>Next </strong>&gt; <strong>Next</strong>, acknowledge the required capabilities, and click <strong>Submit</strong>. Wait until the stack creation is complete, and check the results on the <strong>Outputs </strong>tab.</li>\n<li>Check if those subnets have been accurately tagged so that the EKS cluster can discover them. For details, see the AWS document <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/network_reqs.html#vpc-tagging\" title=\"AWS VPC tagging\">VPC tagging requirements</a>.</li>\n</ol>\n<h3>Configure Kubernetes resources</h3>\n<ol>\n<li>Log in to the bastion with the following command:\n\t<pre>ssh -i &lt;private_key_pem_file&gt; centos@&lt;bastion_ip&gt;</pre>\n</li>\n<li>Copy and save the following script as <strong>configureCustomNetworking.sh</strong>\n<pre>#!/bin/bash\n#Get  EKS cluster name from command line argument\ncluster_name=\"$1\"\noutput_dir=/tmp/configYamls\nif [[ -d $output_dir ]]; then\n    rm -rf $output_dir\nfi\nmkdir -p $output_dir\n#Retrieve the ID of your cluster security group and store it in a variable\nget_cluster_security_group_id() {\n  aws eks describe-cluster --name \"$1\" --query 'cluster.resourcesVpcConfig.clusterSecurityGroupId' --output text\n}\n\n# Retrieve the IDs of your custom subnets in the VPC associated with your Amazon EKS cluster and store them in an array\n get_custom_subnet_ids() {\naws ec2 describe-subnets --filters \"Name=tag:Name,Values=*custom*\" \"Name=vpc-id,Values=$(aws eks describe-cluster --name $1 --query 'cluster.resourcesVpcConfig.vpcId' --output text)\" --query 'Subnets[].SubnetId' --output text\n }\n\n\n# Create an ENIConfig custom resource YAML file for each subnet's availability zone\ncreate_eni_config_files() {\n  subnet_ids=($(get_custom_subnet_ids \"$cluster_name\"))  # Get custom subnet ids and store them in an array\n  cluster_security_group_id=\"$(get_cluster_security_group_id \"$cluster_name\")\"\n subnet_azs=$(aws ec2 describe-subnets --subnet-ids $subnet_ids --query 'Subnets[*].AvailabilityZone' --output text)\n  # Loop through each subnet and generate an ENIConfig file for its availability zone\n  for subnet_id in \"${subnet_ids[@]}\"\n  do\n    az=$(aws ec2 describe-subnets --subnet-id \"$subnet_id\" | jq -r '.Subnets[].AvailabilityZone')\n    cat &gt;\"$output_dir/${az}.yaml\" &lt;&lt;EOF\napiVersion: crd.k8s.amazonaws.com/v1alpha1\nkind: ENIConfig\nmetadata:\n  name: $az\nspec:\n  securityGroups:\n    - $cluster_security_group_id\n  subnet: $subnet_id\nEOF\n  done\n  kubectl apply -f \"$output_dir/\"\n\n}\n\n\n# Set AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG environment variable to true , set ENI_CONFIG_LABEL_DEF environment variable to topology.kubernetes.io/zone in the aws-node daemonset\nset_aws_vpc_k8s_env_var() {\n  kubectl set env daemonset aws-node -n kube-system AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true\n}\n\nset_aws_eni_config_label() {\nkubectl set env daemonset aws-node -n kube-system ENI_CONFIG_LABEL_DEF=topology.kubernetes.io/zone\n}\n\n# Perform setup functions\n\nset_aws_vpc_k8s_env_var\ncreate_eni_config_files\nset_aws_eni_config_label</pre>\n</li>\n<li>Run the following commands to configure custom networking.\n\t<pre>chmod 755 configureCustomNetworking.sh\n./configureCustomNetworking.sh &lt;cluster_name&gt;<cluster_name></cluster_name></pre>\n</li>\n<li>Run the following command to shutdown OMT and SMA. \n\t<pre>$CDF_HOME/bin/cdfctl.sh runlevel set -l DOWN -n core\n$CDF_HOME/bin/cdfctl.sh runlevel set -l DOWN -n &lt;itsma-namespace&gt;\n</pre>\n</li>\n<li>Run the following commands to restart the auto scaling group:\n\t<pre>aws autoscaling update-auto-scaling-group --auto-scaling-group-name &lt;AutoScalingGroupName&gt; --min-size 0 --max-size 0 --desired-capacity 0\naws autoscaling update-auto-scaling-group --auto-scaling-group-name &lt;AutoScalingGroupName&gt; --min-size &lt;MinNumber&gt; --max-size &lt;MaxNumber&gt; --desired-capacity &lt;DesiredNumber&gt;\n</pre>\n<p>Where:</p>\n<ul>\n<li>\n<p><code>&lt;AutoScalingGroupName&gt;</code>: Open the <a href=\"https://console.aws.amazon.com/ec2/\" title=\"AWS console\">Amazon EC2 console</a> , and choose Auto Scaling Groups from the navigation pane. Find your auto scaling group name.</p>\n</li>\n<li>\n<p><code>&lt;MinNumber&gt;</code>, <code>&lt;MaxNumber&gt;</code>, <code>&lt;DesiredNumber&gt;</code>: You can use the same number when <a href=\"/doc/423/26.1/ekscluster#Launch_EKS_cluster_worker_nodes\" title=\"EKS Cluster\">Launching EKS cluster worker nodes</a>.</p>\n</li>\n</ul>\n</li>\n<li>Run the following command to start OMT and SMA\n\t<pre>$CDF_HOME/bin/cdfctl.sh runlevel set -l UP -n core \n$CDF_HOME/bin/cdfctl.sh runlevel set -l UP -n &lt;itsma-namespace&gt;\n</pre>\n</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}