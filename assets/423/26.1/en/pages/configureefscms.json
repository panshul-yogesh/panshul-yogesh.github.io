{
  "title": "Configure EFS for UD/UCMDB",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\"></p><div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>This section describes how to create and configure AWS EFS to store UD/UCMDB data on AWS, as well as how to configure EFS volumes for UD/UCMDB.</p>\n<h2 id=\"Prepare_EFS_template_for_CMS\">Prepare EFS template for UD/UCMDB</h2>\n<ol>\n<li>Navigate to the <strong>smax-efs.template</strong> file under <code>../Cloud Deployment x.x.x/byok/smax-cloudformation-aws</code> in <a href=\"/doc/423/26.1/downloadcloudpackage\" title=\"Download the cloud deployment package\">the cloud deployment package</a>.</li>\n<li>Create a copy of the <strong>smax-efs.template</strong> file and rename the new file to<strong> cms-efs.template</strong>.</li>\n<li>Replace the <strong>SMAX-EFS-Security-Group</strong> key (under <strong>EFSSecurityGroup </strong>in <strong>cms-efs.template</strong>) with <strong>CMS-EFS-Security-Group</strong>, and then save the file.</li>\n</ol>\n<h2>Launch EFS for UD/UCMDB</h2>\n<ol>\n<li>Log in to the AWS Management Console and switch to the selected region.</li>\n<li>Go to <b>All services</b> &gt; <b>Management &amp; Governance</b> &gt; <b>CloudFormation</b>.</li>\n<li>Click <b>Create stack </b>&gt; <strong>With new resources(standard)</strong>, click <b>Template is ready</b> &gt; <b>Upload a template file</b> &gt; <b>Choose file</b> and select the <strong>cms-efs.template</strong> file.</li>\n<li>Click <b>Next</b> and populate the following fields:\n\t<ul>\n<li><b>Stack name:</b> Give a name to this stack, such as <b>cms-efs</b>.</li>\n<li><b>VPC ID:</b> Select your created VPC from the drop-down list.</li>\n<li><b>Subnets for EFS:</b> Select the three private subnets created.</li>\n<li><b>EFS Performance Mode</b>: Select the default value, <b>generalPurpose</b>.</li>\n<li><b>EFS Name</b>: Give a name to this EFS instance, such as <b>cms-efs</b>.</li>\n<li><b>BastionSecurityGroup</b>: Select the bastion security group to allow the bastion node to communicate with EFS.</li>\n<li><b>ClusterSecurityGroup</b>: Select the cluster security group to allow the EKS cluster to communicate with EFS. For example, <strong>eks-cluster-sg-*</strong>.</li>\n</ul>\n</li>\n<li>\n<p>Click <b>Next</b> &gt; <b>Next</b> &gt; <b>Submit</b>. Wait until the stack creation has finished and you can check the results on the <b>Outputs </b>tab. Take note of the value of <strong>FileServerDNSName</strong>, which will be used in later steps.</p>\n</li>\n</ol>\n<h2>Volumes required for UD/UCMDB</h2>\n<p>The following EFS volumes are required for the UD/UCMDB deployment. Make sure the exported EFS volumes are empty and have no data.</p>\n<table>\n<caption>Volumes required for UD/UCMDB</caption>\n<thead>\n<tr>\n<th scope=\"col\">Component</th>\n<th scope=\"col\">EFS volume name</th>\n<th scope=\"col\">Description</th>\n<th scope=\"col\">Example directory path</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>UD/UCMDB</td>\n<td>ucmdb-data-volume</td>\n<td>Stores data generated by UD/UCMDB.</td>\n<td>/var/vols/itom/ucmdb/data_volume</td>\n</tr>\n<tr>\n<td>UD/UCMDB</td>\n<td>ucmdb-config-volume</td>\n<td>Stores UD/UCMDB configuration files.</td>\n<td>/var/vols/itom/ucmdb/conf_volume</td>\n</tr>\n<tr>\n<td>UD/UCMDB</td>\n<td>ucmdb-log-volume</td>\n<td>Stores logs generated by UD/UCMDB.</td>\n<td>/var/vols/itom/ucmdb/log_volume</td>\n</tr>\n</tbody>\n</table>\n<h2>Configure EFS volumes for UD/UCMDB</h2>\n<ol>\n<li>\n<p>Log in to the bastion with the following command:</p>\n<pre>ssh -i &lt;private_key_pem_file&gt; centos@&lt;bastion_ip&gt;</pre>\n<div class=\"Admonition_Note\"><span class=\"autonumber\">Note </span>The <code>private_key_pem_file</code> and <code>bastion_ip</code> are created during the SMA installation.</div>\n</li>\n<li>\n<p>Copy and save the following script as<b> configureCMSEFS.sh</b>:</p>\n<div class=\"Admonition_Note\"><span class=\"autonumber\">Note </span> In the following script, the mountEFS function uses <strong>Example directory path</strong> in the \"Volumes required for UD/UCMDB\" table as the directory path of the EFS volumes for UD/UCMDB.</div>\n<pre>#!/bin/bash\nif [ $# -lt 1 ]; then\necho \"Need Parameter: $1 cms_efs_dns_name\"\nexit 1\nfi\nCURRENTDIR=$(cd \"$(dirname \"$0\")\";pwd)\nsuite_user_uid=$2\nsuite_user_gid=$3\nmount_point=/mnt/cms\nefs_server=$1\nif [ ! -d $mount_point ]; then\nsudo mkdir -p $mount_point\nfi\nexport TIMEOUT_FOR_SERVICES=120\n    \n#=== FUNCTION ==================================================\n# NAME: checkMountEFS\n# DESCRIPTION: check aws efs server is ready\n#=================================================================\nmountEFS() {\nlocal n=0\nwhile :; do\nn=$(($n + 1))\nif [[ $n -ge $TIMEOUT_FOR_SERVICES ]]; then\necho \"check timeout for mount EFS\"\nexit 1\nfi\nsudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 $efs_server:/ $mount_point\nif [ $? -eq 0 ] || [ $? -eq 32 ]; then\necho \"Successfully mount EFS\"\nsudo sed -i '$a\\'\"$efs_server:/ $mount_point nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,_netdev 0 0\" /etc/fstab\nbreak\nfi\nsleep 15\ndone\n}\n\nmake_volume() {\nlocal volume=$1\ncd $mount_point\nlocal mounted_pv=${mount_point}${volume}\nif [ ! -d $mounted_pv ]; then\nsudo mkdir -p $mounted_pv\nfi\nchown -R $suite_user_uid:$suite_user_gid $mounted_pv\nchmod g+w $mounted_pv\nchmod g+s $mounted_pv\necho \"Successfully make volume: ${volume}\"\n}\n\nmountEFS\nmake_volume /var/vols/itom/ucmdb/data_volume\nmake_volume /var/vols/itom/ucmdb/conf_volume\nmake_volume /var/vols/itom/ucmdb/log_volume\necho \"Finish making all volumes Successfully.\"\ncd ${CURRENTDIR}</pre>\n</li>\n<li>\n<p>Run the following commands to configure the EFS volumes for UD/UCMDB:</p>\n<pre>chmod 755 configureCMSEFS.sh\nsudo ./configureCMSEFS.sh &lt;CMS_EFS_DNS_NAME&gt; &lt;SYSTEM_USER_ID&gt; &lt;SYSTEM_GROUP_ID&gt;</pre>\n<p>Where:</p>\n<ul>\n<li>\n<p><b>&lt;cms_efs_dns_name&gt;</b> is the <strong>FileServerDNSName</strong> you get on the Outputs tab when creating the EFS stack.</p>\n</li>\n<li><b>&lt;SYSTEM_USER_ID&gt;</b> and <b>&lt;SYSTEM_GROUP_ID&gt;</b>: specify an operating system user ID and group ID respectively that are used to run the process in the container. Both values must be 1999 or a number between 100000 and 2000000000 (for example, UID=100001 and GID=100002).</li>\n</ul>\n</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}