{
  "title": "Configure EFS (Helm)",
  "content": "<div class=\"mw-parser-output\">\n \n\n\n<div></div>\n<p>This section describes how to create <span class=\"nanospell-typo\">AWS</span> <span class=\"nanospell-typo\">EFS</span> to store <span class=\"nanospell-typo\">SMA</span> data on <span class=\"nanospell-typo\">AWS</span>, as well as how to configure <span class=\"nanospell-typo\">EFS</span> volumes.</p>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-note-icon\"></div><div class=\"admonition-content admonition-note-content\"><div>For information about <span class=\"nanospell-typo\">EFS</span> storage sizing and management, see  <a href=\"/doc/423/26.1/managestoragesuite\" title=\"Manage persistent storage for the suite\">Manage persistent storage for the suite</a>.</div></div></div>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-note-icon\"></div><div class=\"admonition-content admonition-note-content\"><div>The storage throughput hugely impacts the <span class=\"nanospell-typo\">SMA</span> performance. Low throughput storage might cause slow response from the <span class=\"nanospell-typo\">SMA</span> system, or even an <span class=\"nanospell-typo\">http</span> error codes, such as 500, 504. Amazon <span class=\"nanospell-typo\">EFS</span> uses a credit system to determine when file systems can burst. When in burst mode, the file system will drive throughput at its baseline rate after running out of its credit. This throughput baseline rate is however too low for the <span class=\"nanospell-typo\">SMA</span> system to run effectively. You need to keep monitoring your <span class=\"nanospell-typo\">EFS</span> bursting credits balance with <span class=\"nanospell-typo\">AWS</span> <span class=\"nanospell-typo\">CloudWatch</span>. See <a href=\"/doc/423/26.1/eksdeploymentfaq#Do_we_still_need_to_write_500_GB_dummy_data_in_EFS_on_EKS_to_improve_EFS_performance?_What's_the_suggested_size_for_dummy_data?\" title=\"EFS Deployment FAQs\"><span class=\"nanospell-typo\">EFS</span> Deployment <span class=\"nanospell-typo\">FAQs</span></a>.</div></div></div>\n<h2><a id=\"Launch_EFS\" name=\"Launch_EFS\" title=\"Launch EFS\"></a>Launch <span class=\"nanospell-typo\">EFS</span></h2>\n<table>\n<caption>Role and location</caption>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Storage administrator</td>\n<td><span class=\"nanospell-typo\">AWS</span> Management Console</td>\n</tr>\n</tbody>\n</table>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Log in to the <span class=\"nanospell-typo\">AWS</span> Management Console and switch to the selected region.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Go to <b>All services</b> &gt; <b>Management &amp; Governance</b> &gt; <b><span class=\"nanospell-typo\">CloudFormation</span></b>.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Click <b>Create stack</b> &gt; <strong>With new resources(standard)</strong>, click <b>Template is ready</b> &gt; <b>Upload a template file</b> &gt; <b>Choose file</b> and select the <code><span class=\"nanospell-typo\">smax</span>-<span class=\"nanospell-typo\">efs</span>.template</code> file under <code>../Cloud Deployment x.x.x/../<span class=\"nanospell-typo\">byok</span>/<span class=\"nanospell-typo\">smax</span>-<span class=\"nanospell-typo\">cloudformation</span>-<span class=\"nanospell-typo\">aws</span> </code>in <a href=\"/doc/423/26.1/downloadcloudpackage\" title=\"the cloud deployment package\">the cloud deployment package</a>.<code> </code></li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Click <b>Next</b> and populate the following fields:\n\t<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><b>Stack name:</b> Give a name to this stack, such as <em><span class=\"nanospell-typo\">sma</span>-<span class=\"nanospell-typo\">efs</span></em>.</li><li style=\"margin-left: 40px; position: relative;\"><b><span class=\"nanospell-typo\">VPC</span> ID:</b> Select your created <span class=\"nanospell-typo\">VPC</span> from the drop-down list.</li><li style=\"margin-left: 40px; position: relative;\"><b><span class=\"nanospell-typo\">Subnets</span> for <span class=\"nanospell-typo\">EFS</span>:</b> Select the three private <span class=\"nanospell-typo\">subnets</span> created.</li><li style=\"margin-left: 40px; position: relative;\"><b><span class=\"nanospell-typo\">EFS</span> Performance Mode</b>: Select the default value, <strong><span class=\"nanospell-typo\">generalPurpose</span></strong>.</li><li style=\"margin-left: 40px; position: relative;\"><b><span class=\"nanospell-typo\">EFS</span> Name</b>: Give a name to this <span class=\"nanospell-typo\">EFS</span> instance, such as <em><span class=\"nanospell-typo\">smax</span>-<span class=\"nanospell-typo\">efs</span></em>.</li><li style=\"margin-left: 40px; position: relative;\"><b><span class=\"nanospell-typo\">BastionSecurityGroup</span></b>: Select the bastion's security group to allow the bastion node to communicate with <span class=\"nanospell-typo\">EFS</span>.</li><li style=\"margin-left: 40px; position: relative;\"><b><span class=\"nanospell-typo\">ClusterSecurityGroup</span></b>: Select the <span class=\"nanospell-typo\">EKS</span> cluster's security group (<em><span class=\"nanospell-typo\">eks</span>-cluster-sg-*</em>) to allow the <span class=\"nanospell-typo\">EKS</span> cluster to communicate with <span class=\"nanospell-typo\">EFS</span>.</li></ul>\n</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Click <b>Next</b> &gt; <b>Next</b> &gt; <b>Submit</b>. Wait until the stack creation has finished and you can check the results on the <b>Outputs</b> tab. \n\t<div class=\"admonition\"><div class=\"admonition-icon admonition-tip-icon\"></div><div class=\"admonition-content admonition-tip-content\"><div>  Take a note of the value of <strong><span class=\"nanospell-typo\">FileServerDNSName</span></strong>. It will be used in later steps.</div></div></div>\n</li></ol>\n<h2><a id=\"_Static_volume_provisioning_only_Configure_EFS_volumes\" name=\"_Static_volume_provisioning_only_Configure_EFS_volumes\" title=\"(Static volume provisioning only) Configure EFS volumes\"></a>(Static volume provisioning only) Configure <span class=\"nanospell-typo\">EFS</span> volumes</h2>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-note-icon\"></div><div class=\"admonition-content admonition-note-content\"><div>If you're using dynamic volume provisioning, skip this step.</div></div></div>\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Storage administrator</td>\n<td>Bastion node</td>\n</tr>\n</tbody>\n</table>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Log in to the bastion with the following command: <br/>\n<code><span class=\"nanospell-typo\">ssh</span> -i &lt;private_key_<span class=\"nanospell-typo\">pem</span>_file&gt; <span class=\"nanospell-typo\">centos</span>@&lt;bastion_ip&gt;</code></li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following command to download the required package:\n\t<pre><span class=\"nanospell-typo\">sudo</span> yum install -y <span class=\"nanospell-typo\">nfs</span>-<span class=\"nanospell-typo\">utils</span></pre>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Copy and save the following script as <strong><span class=\"nanospell-typo\">configureEFS</span>.sh</strong>:\n\t<pre><code class=\"language-bash\">#!/bin/bash\n\nif [ $# -lt 1 ]; then\n    echo \"Usage: $0 \"\n    exit 1\nfi\nCURRENTDIR=$(cd \"$(dirname \"$0\")\";pwd)\nsuite_user_uid=$2\nsuite_user_gid=$3\nmount_point=/mnt/efs\nefs_server=$1\nif [ ! -d $mount_point ]; then\n    sudo mkdir -p $mount_point\nfi\nexport TIMEOUT_FOR_SERVICES=120\n\n#=== FUNCTION ==================================================\n# NAME: checkMountEFS\n# DESCRIPTION: check aws efs server is ready\n#=================================================================\nmountEFS() {\n    local n=0\n    while :; do\n        n=$(($n + 1))\n        if [[ $n -ge $TIMEOUT_FOR_SERVICES ]]; then\n            echo \"check timeout for mount EFS\"\n            exit 1\n        fi\n        returnCode=`sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 $efs_server:/ $mount_point`\n        if [[ $returnCode -eq 0 ]] || [[ $returnCode -eq 32 ]]; then\n            echo \"Successfully mount EFS\"\n            sudo sed -i '$a\\'\"$efs_server:/ $mount_point nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,_netdev 0 0\" /etc/fstab\n            break\n        fi\n        sleep 15\n    done\n}\n\nmake_volume() {\n    local volume=$1\n    cd $mount_point\n    local mounted_pv=${mount_point}${volume}\n    if [ ! -d $mounted_pv ]; then\n        sudo mkdir -p $mounted_pv\n    fi\n    chown -R $suite_user_uid:$suite_user_gid $mounted_pv\n    chmod g+w $mounted_pv\n    chmod g+s $mounted_pv\n    echo \"Successfully make volume: ${volume}\"\n}\n\nmountEFS\nmake_volume /var/vols/itom/itsma/logging-volume\nmake_volume /var/vols/itom/itsma/config-volume\nmake_volume /var/vols/itom/itsma/data-volume\nmake_volume /var/vols/itom/itsma/db-volume\nmake_volume /var/vols/itom/itsma/rabbitmq-infra-rabbitmq-0\nmake_volume /var/vols/itom/itsma/rabbitmq-infra-rabbitmq-1\nmake_volume /var/vols/itom/itsma/rabbitmq-infra-rabbitmq-2\nmake_volume /var/vols/itom/itsma/itsma-smarta-sawarc-con-0\nmake_volume /var/vols/itom/itsma/itsma-smarta-sawarc-con-1\nmake_volume /var/vols/itom/itsma/itsma-smarta-sawarc-con-a-0\nmake_volume /var/vols/itom/itsma/itsma-smarta-sawarc-con-a-1\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-0\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-1\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-2\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-3\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-4\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-5\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-a-0\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-a-1\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-a-2\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-a-3\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-a-4\nmake_volume /var/vols/itom/itsma/itsma-smarta-saw-con-a-5\nmake_volume /var/vols/itom/itsma/itsma-smarta-sawmeta-con-0\nmake_volume /var/vols/itom/itsma/itsma-smarta-sawmeta-con-1\nmake_volume /var/vols/itom/itsma/itsma-smarta-sawmeta-con-a-0\nmake_volume /var/vols/itom/itsma/itsma-smarta-sawmeta-con-a-1\necho \"Finish making all volumes Successfully.\"\ncd ${CURRENTDIR}</code></pre>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following commands to configure <span class=\"nanospell-typo\">EFS</span> volumes:\n\t<pre><span class=\"nanospell-typo\">chmod</span> 755 <span class=\"nanospell-typo\">configureEFS</span>.sh\n<span class=\"nanospell-typo\">sudo</span> ./<span class=\"nanospell-typo\">configureEFS</span>.sh &lt;<span class=\"nanospell-typo\">efs</span>_<span class=\"nanospell-typo\">dns</span>_name&gt; &lt;system_user_id&gt; &lt;system_group_id&gt;\n</pre>\n\tWhere:\n\n\t<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><code>&lt;<span class=\"nanospell-typo\">efs</span>_<span class=\"nanospell-typo\">dns</span>_name&gt;</code> is the <b><span class=\"nanospell-typo\">FileServerDNSName</span></b> you got on the <b>Outputs</b> tab when creating the <span class=\"nanospell-typo\">EFS</span> stack (see the last step in the <em>Launch <span class=\"nanospell-typo\">EFS</span></em> section).</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;system_user_id&gt;</code> and <code>&lt;system_group_id&gt;</code>: specify an operating system user ID and group ID respectively that are used to run the process in the container. Both values must be 1999 or a number between 100000 and 2000000000 (for example, <span class=\"nanospell-typo\">UID</span>=100001 and <span class=\"nanospell-typo\">GID</span>=100002).</li></ul>\n</li></ol>\n</div>",
  "modifiedon": "2025-11-10 06:40:21"
}