{
  "title": "Configure a new load balancer on Azure",
  "content": "<div class=\"mw-parser-output\">\n<p class=\"mw-headline\">This topic covers the basic process to configure a new load balancer (LB) for helm deployment on Azure platform.</p>\n<p class=\"mw-headline\">The process to configure a new LB on your deployment depends on whether or not OMT is included in your deployment. If you have OMT installed, you will need to configure an LB for the OMT management portal uisng the steps below and then later <a href=\"/doc/423/26.1/samelbforsuiteomt\" title=\"Suite to use the same LB you created for OMT\">configure the Suite to use the same LB you created for OMT</a>. If your deployment doesn't include OMT, you only need to configure an LB for the Suite using the steps below.</p>\n<p class=\"mw-headline\">Use the steps below to configure a new load balancer according to your deployment. </p>\n<h2 class=\"mw-headline\">Configure a new load balancer</h2>\n<p>The process to configure a new balancer for either OMT management portal or the suite are the same. However, if your deployment requires OMT Apphub, you will first need to configure the load balancer for OMT with the steps below for port <strong>5443</strong> and then Bind this load balancer with the port for the Suite using a different topic after you have installed the Suite. If your deployment doesn't require OMT AppHub, use the steps below to configure a new load balancer for the Suite for port <strong>443</strong>.</p>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-important-icon\"></div><div class=\"admonition-content admonition-important-content\"><div>This section contains information to create a new load balancer for either OMT management portal or the Suite on port 5443 or 443 respectively. When using the document, refer to steps specific to the port you are creating the load balaner.</div></div></div>\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Suite administrator</td>\n<td>Azure portal</td>\n</tr>\n</tbody>\n</table>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-important-icon\"></div><div class=\"admonition-content admonition-important-content\"><div>The Azure application gateway you will create is dedicated to the SMA suite only. Please do not configure anything other than the resources required on this page. Or else, your configurations might get lost after the suite upgrade.</div></div></div>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-note-icon\"></div><div class=\"admonition-content admonition-note-content\"><div>When performing the following steps on the Azure portal, if you see any parameters on the UI that are not mentioned in the steps, use their default value. </div></div></div>\n<h3 class=\"mw-headline\" id=\"Step_1:_Create_an_Azure_application_gateway\">Step 1: Create an Azure application gateway</h3>\n<p>After the bootstrap installation, follow these steps to create an Azure application gateway.<br/>\n </p>\n<div class=\"transcontent stn-begin--CreateAzureAppGateway\"></div>\n<ol>\n<li>Create an application gateway from the <a class=\"external text\" href=\"https://portal.azure.com/#create/Microsoft.ApplicationGateway-ARM\" rel=\"nofollow\" target=\"1\" title=\"Azure portal\">Azure portal</a>.</li>\n<li>Populate the following basics settings:\n\t<ul>\n<li><b>Subscription</b>: Select your subscription.</li>\n<li><b>Resource group</b>: Use the same one as your VNet and VMs.</li>\n<li><b>Application gateway name</b>: Enter a descriptive name.</li>\n<li><b>Region</b>: Select the same region as your VNet.</li>\n<li><b>Tier</b>: Select <b>Standard V2</b>.</li>\n<li>Under <b>Configure virtual network</b>, select your VNet for the environment and prepared subnet for Application gateway.</li>\n</ul>\n</li>\n<li>On the <b>Frontends</b> page, set <b>Frontend IP address type</b> to <b>Public</b>. Click <b>Add new</b> for the public IP address and enter a name for it, and then click <b>OK</b>. <b>Note</b>: With the Application Gateway v2 SKU, you can only use public frontend IP configuration. Private frontend IP configuration is currently not enabled for this SKU.</li>\n<li>Click <b>Next: Backends &gt;</b>.</li>\n</ol>\n<div class=\"transcontent stn-end--CreateAzureAppGateway\"></div>\n<h3 class=\"mw-headline\" id=\"Step_2:_Configure_a_backend_pool_for_port_3000\">Step 2: Configure a backend pool</h3>\n<p>To configure a backend pool for port 443 or 5443:</p>\n<ol>\n<li>On the <b>Backends</b> page, click <b>Add a backend pool</b> to create a new backend pool for port 443 or 5443.</li>\n<li>Provide the following information:\n\t<ul>\n<li><b>Name</b>: Enter a name.</li>\n<li><b>Add backend pool without targets</b>: Select <b>No</b>.</li>\n<li><b>Target type</b>: Select <b>IP address or FQDN</b>.</li>\n<li><b>Target</b>: Enter the IP address of the load balancer for port <strong>443 or 5443</strong>.\n\t\t<p>For 443, you can obtain the IP address by running the following command:</p>\n<pre>kubectl get svc itom-ingress-controller-svc -n $(kubectl get namespaces|grep itsma|head -n 1|awk '{print $1}') | grep -v EXTERNAL-IP |awk '{print $4}'</pre>\n<p>For 5443, run the following command to obtain the IP address.</p>\n<pre>kubectl get svc portal-ingress-controller-svc -n core | grep -v EXTERNAL-IP |awk '{print $4}'</pre>\n<p><b>Note</b>: If you fail to get the IP address, see <a href=\"/doc/423/26.1/aksfailtopatchlb\" title=\"Fail to configure a load balancer (AKS)\">Fail to configure a load balancer (AKS)</a> for troubleshooting information.</p>\n</li>\n</ul>\n</li>\n<li>Click <b>Add</b>.</li>\n<li>Click <b>Next: Configuration &gt;</b>.</li>\n</ol>\n<h3 class=\"mw-headline\" id=\"Step_3:_Add_a_routing_rule\">Step 3: Add a routing rule</h3>\n<ol>\n<li>First, you will need to prepare a server certificate for the listener. Run the following commands on the bastion node to create the certifcate:\n\t<pre>ESM_NAMESPACE=$(kubectl get namespaces|grep itsma|head -n 1|awk '{print $1}')</pre>\n</li>\n<li>Create the server certificate  and server certificate key\n\t<p>If you are configuring for 443, run the following commands：</p>\n<pre>kubectl get secret nginx-default-secret -n $(kubectl get namespaces|grep itsma|head -n 1|awk '{print $1}') -o json  | jq .data.'\"tls.crt\"' -r | base64 -d &gt; server.crt\nkubectl get secret nginx-default-secret -n $(kubectl get namespaces|grep itsma|head -n 1|awk '{print $1}') -o json  | jq .data.'\"tls.key\"' -r | base64 -d &gt; server.key\n</pre>\n<p>If you are configuring for 5443, run the following commands：</p>\n<pre>kubectl get secret nginx-default-secret -n core -o json  | jq .data.'\"tls.crt\"' -r | base64 -d &gt; server.crt\nkubectl get secret nginx-default-secret -n core -o json  | jq .data.'\"tls.key\"' -r | base64 -d &gt; server.key</pre>\n</li>\n<li>Export the server certificate to a PFX file:\n\t<pre>openssl pkcs12 -export -out certificate.pfx -inkey server.key -in server.crt</pre>\n<p>When prompted, enter a password for the <code>certificate.pfx</code> file.</p>\n</li>\n<li>Copy the <code>certificate.pfx</code> file to the local drive of the machine on which you will launch the Azure portal.</li>\n<li>Return to the Azure portal to configure the routing rule.</li>\n<li>On the <b>Configuration</b> page, follow these steps to add a routing rule for each of the port 443 or 5443.\n\t<ul>\n<li>Select <b>Add a routing rule</b>. </li>\n<li>In the window that opens, fill the following fields\n\t\t<ul>\n<li>Rule name: Enter a name for the rule.</li>\n<li>Priority: For 443, set as 10. For 5443, set it as 20.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<h4>Configure listener</h4>\n<p>A routing rule requires a listener. Click the <b>Listener</b> tab to create a listener with the following settings:</p>\n<ol>\n<li><b>Listener name</b>: Enter a name for the listener.</li>\n<li><b>Frontend IP</b>: Use the default value.</li>\n<li><b>Protocol</b>: Select <b>HTTPS</b>.</li>\n<li><b>Port</b>: Enter <b>443 or 5443</b>.</li>\n<li>In the <b>HTTPS Settings</b> section,\n\t<ul>\n<li>Click <strong>Upload a certificate</strong> to upload the certificate you created.</li>\n<li><b>Cert name</b>: Enter the name of the certificate you created earlier.</li>\n<li><b>PFX certificate file</b>: Select the pfx file you exported from the certificate.</li>\n<li><b>Password</b>: Enter the password that you specified for the pfx file.</li>\n<li><b>Listener type</b>: Select <b>Basic.</b></li>\n</ul>\n</li>\n</ol>\n<h4 id=\"Step_3:_Configure_HTTP_settings_for_ports_5443_and_443\">Configure Backend </h4>\n<p>Create a separate backend setting for each of the port 443 or 5443 as follows. Navigate to the <b>Backend targets</b> tab,</p>\n<ol>\n<li>Provide the followin information:\n\t<ul>\n<li><strong>Target type</strong>: Select <strong>Backend pool</strong>. </li>\n<li><strong>Backend target</strong>: Select the backend pool you created earlier.</li>\n</ul>\n</li>\n<li>In <b>Backend settings</b>, click <b>Add new</b> to create a backend setting for port 443 or 5443.\n\t<p>Run the following commands on the bastion node to create an <code>RE_ca.cer</code> file, which will be used when you configure a backend setting for port 443.</p>\n<pre>kubectl get cm -n $(kubectl get namespaces|grep itsma|head -n 1|awk '{print $1}') public-ca-certificates -o json |sed -n '/\"RE_ca.crt\": \"-----BEGIN CERTIFICATE-----/p'|sed 's/\\\\n//g'|sed 's/ //g' |sed 's/\"RE_ca.crt\":\"-----BEGINCERTIFICATE-----/-----BEGIN CERTIFICATE-----\\n/g' |sed 's/-----ENDCERTIFICATE-----\",/\\n-----END CERTIFICATE-----/g' &gt; RE_ca.cer</pre>\n<p>For 5443，the command should be </p>\n<p>Run the following commands on the bastion node to create an <code>RE_ca.cer</code> file, which will be used when you configure a backend setting for port 5443.</p>\n<pre>kubectl get cm -n core public-ca-certificates -o json |sed -n '/\"RE_ca.crt\": \"-----BEGIN CERTIFICATE-----/p'|sed 's/\\\\n//g'|sed 's/ //g' |sed 's/\"RE_ca.crt\":\"-----BEGINCERTIFICATE-----/-----BEGIN CERTIFICATE-----\\n/g' |sed 's/-----ENDCERTIFICATE-----\",/\\n-----END CERTIFICATE-----/g' &gt; RE_ca.cer</pre>\n<p>Follow these steps to add a backend setting:</p>\n<ol start=\"1\">\n<li>Click <b>Add new</b>.</li>\n<li>Enter a name for the backend setting.</li>\n<li>Provide the following information:\n\t\t<ul>\n<li><b>Backend protocol</b>: Choose <b>HTTPS</b>.</li>\n<li><b>Backend port</b>: Enter <b>443</b>.</li>\n<li><b>CER certificate</b>: Choose the <code>RE_ca.cer</code> certificate file that you created.</li>\n<li><b>Request time-out (seconds)</b>: Enter <b>180</b>.</li>\n<li><b>Override with new hostname</b>: Select <b>Yes</b>, choose <b>Override with specific domain name</b>, and then enter your external access hostname.</li>\n<li><b>Create custom probes</b>: Select <b>Yes</b>. A custom probe is automatically created. You will configure this custom probe in the next step.</li>\n</ul>\n</li>\n<li>Click <b>Add</b>. The backend setting configuration for port 443/5443 is completed.</li>\n</ol>\n</li>\n<li>Click <b>Next: Tags &gt;</b></li>\n<li>Click <b>Next: Review + create &gt;</b>, and wait until the validation has passed.</li>\n<li>Click <b>Create</b>. The application gateway will be created in several minutes.</li>\n</ol>\n<h3 class=\"mw-headline\" id=\"Step_4:_Configure_a_health_probe_for_3000\">Step 5: Configure a health probe for all ports</h3>\n<ol>\n<li>Open the application gateway that you created in the previous step.</li>\n<li>Click <b>Health probe</b> to create a health probe for each of the port 443 or 5443.</li>\n<li>Open the custom health probe created in the previous step.</li>\n<li>Configure the following parameters:\n\t<ul>\n<li><b>Protocol</b>: Select <b>HTTPS</b>.</li>\n<li><b>Host</b>: Enter your external access hostname.</li>\n<li><b>Path</b>: Enter <b>/</b> for 5443 or <b>/healthz</b>. for 443.</li>\n<li><b>Interval (seconds)</b>: Enter <b>30</b>.</li>\n<li><b>Timeout (seconds)</b>: Enter <b>5</b>.</li>\n<li><b>Unhealthy threshold</b>: Enter <b>15</b>.</li>\n<li><b>Backend settings</b>: Choose the one you created for port 443 or 5443.</li>\n</ul>\n</li>\n<li>Deselect <b>I want to test the backend health before adding the health probe</b>.</li>\n<li>Click <b>Add</b>.</li>\n</ol>\n<h3 class=\"mw-headline\" id=\"Step_5:_Check_the_backend_health_for_port_3000\">Step 6: Configure a SSL settings for application gateway</h3>\n<p>In the <strong>SSL settings</strong>, click <strong>Add SSL Profiles</strong> to create an SSL profile.</p>\n<ul>\n<li><strong>SSL Profile Name</strong>: enter a name for the SSL profile.</li>\n<li>Choose <strong>SSL Policy</strong>, enable <strong>listener-specific SSL Policy</strong>, Choose <strong>CustomV2</strong>.</li>\n<li><strong>Min protocol version</strong>: TLSv1_3</li>\n</ul>\n<h3 class=\"mw-headline\">Step 7: Check the backend health</h3>\n<ol>\n<li>Open the application gateway that you created.</li>\n<li>Click <b>Backend health</b>.</li>\n<li>Make sure that the <b>Status</b> value is <b>Healthy</b> for port 443 or 5443. This indicates that the application gateway has been configured successfully.</li>\n</ol>\n<h2 class=\"mw-headline\" id=\"Bind_the_external_access_host_name_with_the_application_gateway\">Bind the external access hostname with the application gateway</h2>\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Suite administrator</td>\n<td>DNS provider</td>\n</tr>\n</tbody>\n</table>\n<p>After configuring the application gateway, to allow users to access the suite services with the external access hostname, you need to bind the hostname with the static IP address of the created application gateway.</p>\n<p>To find your application gateway's IP address, navigate to the Azure portal &gt; <b>Application gateways</b>, click your application gateway name, and find the IP address under <b>Frontend public IP address</b>.</p>\n<h2 class=\"mw-headline\" id=\"Related_topics\">External references</h2>\n<ul>\n<li>For more information about Application Gateway, see <a href=\"https://docs.microsoft.com/en-us/azure/application-gateway/overview\" title=\"Azure Application Gateway\">Azure Application Gateway</a>.</li>\n<li>For more information about binding the external access hostname with the application gateway, see <a href=\"https://learn.microsoft.com/en-us/azure/app-service/environment/integrate-with-application-gateway#add-a-public-dns-record\" rel=\"nofollow\" target=\"1\" title=\"Add a public DNS record\">Add a public DNS record</a>.</li>\n</ul>\n</div>",
  "modifiedon": "2025-10-24 08:51:12"
}