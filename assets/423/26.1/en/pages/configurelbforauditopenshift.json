{
  "title": "Configure a load balancer for Audit port 9889 (OpenShift)",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>After installing Audit on OpenShift, you need to get the actual node port of the front end ingress and then add traffic map rules to the load balancer. The port map points from port 9889 to the actual node ports. If you installed nginx on the bastion node when configuring a load balancer for Service Management,use the same nginx as a load balancer for the Audit port 9889. </p>\n<p>Follow these steps:</p>\n<ol>\n<li>Get the node port of the front end ingress service:\n\t<pre><code>kubectl get svc itom-ingress-controller-svc -n audit-prod -o jsonpath='{range .spec.ports[?(@.name == \"https\")]}{.nodePort}{\"\\n\"}{end}'</code></pre>\n</li>\n<li>Configure the nginx configuration file (<strong>nginx.conf</strong>) for the application load balancer or the network load balancer.</li>\n<li>For application load balancer, make sure the nginx configuration file (<strong>nginx.conf</strong>) contains the following settings:\n\t<pre><code>http {\n    upstream auditrouter9889 {    #upstream for Audit\n        least_conn;\n        keepalive 32;\n        server &lt;control plane node 1&gt;:&lt;node port&gt; max_fails=0 fail_timeout=0;     #control plane node 1\n        server &lt;control plane node 2&gt;:&lt;node port&gt; max_fails=0 fail_timeout=0;     #control plane node 2\n        server &lt;control plane node 3&gt;:&lt;node port&gt; max_fails=0 fail_timeout=0;     #control plane node 3\n    } \n    server { #listen on 9889 and proxy to audit\n        listen 9889  ssl http2;\n        ssl_certificate                         /root/server.crt;       #certificate generated by customers\n        ssl_certificate_key                  /root/server.key;      #key generated by customers \n        location ^~ / {\n            proxy_set_header Host            \"&lt;external load balancer&gt;:9889\";\n            proxy_pass                              https://auditrouter9889 ;\n            client_max_body_size              4096m\n        }\n    } \n  \n}</code></pre>\n</li>\n<li>For network load balancer, add the following lines to <strong>nginx.conf</strong>, and replace <strong>&lt;node port&gt;</strong> with the value you have obtained from step 1:\n\t<pre><code>stream {\n    upstream auditrouter9889 { #upstream for 9889\n         least_conn;\n         server &lt;control plane node 1 IP address&gt;:&lt;node port&gt; max_fails=0 fail_timeout=0; #control plane node 1\n         server &lt;control plane node 2 IP address&gt;:&lt;node port&gt; max_fails=0 fail_timeout=0; #control plane node 2\n         server &lt;control plane node 3 IP address&gt;:&lt;node port&gt; max_fails=0 fail_timeout=0; #control plane node 3\n    }\n\n    server {\n         listen 9889;\n         proxy_pass auditrouter9889;\n     }\n }</code></pre>\n</li>\n<li>Restart nginx:\n\t<pre><code>nginx -s reload</code></pre>\n</li>\n<li>Verify that you can open the Audit UI: <strong>https://&lt;external_access_host&gt;:&lt;External_access_port&gt;/audit-gateway?TenantID=&lt;tenantID&gt;</strong>.</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}