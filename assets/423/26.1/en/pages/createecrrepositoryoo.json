{
  "title": "Create ECR repository",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>Before pushing images to Amazon Elastic Container Registry (ECR), create a repository for each image. Make sure to save the <code>create_aws_repositories.py</code> script in the  <code>OMT_External_K8s_2x.x-xxx/scripts</code> directory on the bastion.</p>\n<ol>\n<li>If the script isn't present, copy and save the script below as <strong>create_aws_repositories.py</strong> to the <code>OMT_External_K8s_2x.x-xxx/scripts</code> directory on the bastion:\n\n\t<pre><code>import os\nimport subprocess\nimport time\nimport sys\nimport json\nimport argparse\nimport logging\nfrom collections import OrderedDict\nfrom subprocess import CalledProcessError\n\nlogFile = os.path.dirname(os.path.realpath(__file__)) + '/create_aws_repositories.log'\nif os.path.exists(logFile):\n    os.remove(logFile)\nlogging.basicConfig(level=logging.DEBUG,\n                    format='%(asctime)s %(name)-12s %(levelname)-8s %(message)s',\n                    datefmt='%m-%d %H:%M', filename=logFile, filemode='w')\nconsole = logging.StreamHandler()\nconsole.setLevel(logging.INFO)\nformatter = logging.Formatter('%(levelname)-8s %(message)s')\nconsole.setFormatter(formatter)\nlogging.getLogger('').addHandler(console)\n\ndef sh(cmd, mode='output'):\n    try:\n        if mode == 'output':\n            logging.debug(\"execute command: \" + cmd + \" with output returned\")\n            return subprocess.check_output(cmd, stderr=subprocess.STDOUT, shell=True)\n        else:\n            logging.debug(\"execute command: \" + cmd + \" with returnCode returned\")\n            return subprocess.call(cmd, shell=True)\n    except CalledProcessError as e:\n        logging.error(\"execute returncode: \" + str(e.cmd))\n        logging.error(\"execute returncode: \" + str(e.returncode))\n        logging.error(\"execute output: \" + str(e.output))\n        raise e\n    except Exception as e:\n        logging.error(\"execute shell exception: \" + str(e))\n        raise e\n\ndef loadImageSetFile(filePath):\n    if os.path.exists(filePath):\n        logging.debug(\"Json file \" + filePath + \" will be load.\")\n        with open(filePath, 'r') as json_file:\n            data = json.load(json_file, object_pairs_hook=OrderedDict)\n            logging.debug(json.dumps(data, indent=2))\n            return data\n\ndef generateImageList(imageSetPath):    \n    suiteImagesFileList = []\n    imageSetData = loadImageSetFile(imageSetPath)\n    for item in imageSetData[\"images\"]:\n        if item['image'] is not None:\n            suiteImagesFileList.append(item['image'])\n    return list(dict.fromkeys(suiteImagesFileList))\n\ndef createAWSrepository(region, orgName, imageName):\n    imageNameStr = imageName.split(\":\")\n    logging.info (\"imageNameStr : \" + imageNameStr[0])\n    repositoryName = orgName + \"/\" + imageNameStr[0]\n    rc = sh('aws ecr describe-repositories --region {}  --repository-names {} &gt; /dev/null 2&gt;&amp;1'.format(region, repositoryName), 'call') \n    if rc == 255 or rc == 254:\n        rc2 = sh('aws ecr create-repository --region {}  --repository-name {} &gt;/dev/null 2&gt;&amp;1'.format(region, repositoryName), 'call')\n        if rc2 == 0:\n            logging.info (\"create repository \" + repositoryName + \" done !!!\")\n        else:\n            logging.error (\"create repository \" + repositoryName + \" failed !!!\")\n    else: \n         logging.info (\"repository\" + repositoryName + \" already existed !!!\")\n\ndef main(argv):\n    parser = argparse.ArgumentParser(prog='create aws ecr repository for single image or images listed in image-set file.')\n    group = parser.add_mutually_exclusive_group()\n    group.add_argument('-i', '--imageSetPath', type=str, default='./image-set.json', help='The images set json file path.')\n    group.add_argument('-n', '--imageName', type=str, default='', help='The single image name.')\n    parser.add_argument('-r', '--region', type=str, default='us-west-2', help='The code of the region in which the aws ECR locate, e.g us-west-2.')\n    parser.add_argument('-o', '--orgName', type=str, default='hpeswitomsandbox', help='The hostname of the repository that you want to pull suite images from.')\n\n    parsed = parser.parse_args()\n    try:\n        if parsed.imageName:\n            createAWSrepository(parsed.region, parsed.orgName, parsed.imageName)\n        else:\n            suiteImagesSet = generateImageList(parsed.imageSetPath)\n            for item in suiteImagesSet:\n                createAWSrepository(parsed.region, parsed.orgName, item)\n    except Exception as e:\n        logging.error (\"execute create repository exception.\" + str(e))\n    logging.info (\"create repository done!!!\")\n\nif __name__ == \"__main__\":\n    main(sys.argv[1:])</code></pre>\n</li>\n<li>Optional: You need Python 3 to run the following scripts. Make sure you install Python 3 on the bastion.</li>\n<li>Run the following command on the bastion to create ECR repositories in a preferred region:\n\t<pre>python3 create_aws_repositories.py -r &lt;ecr_region&gt; -o hpeswitom -i &lt;path_to_specified_image_download&gt;/offline-download/image-set.json\n</pre>\n<p>Where, <code>&lt;ecr_region&gt;</code> is the region where you will put your ECR repositories and it can be different from the region you selected to place all the prepared AWS resources. </p>\n<p>You will receive the following message indicating that you have successfully created the repository.</p>\n<pre>INFO     create repository done!!!\n</pre>\n</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}