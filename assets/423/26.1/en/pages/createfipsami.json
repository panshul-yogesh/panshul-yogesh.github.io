{
  "title": "Create a FIPS-enabled AMI",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>Use the following steps to create FIPS-enabled AMI:</p>\n<ol>\n<li>Download the zip file from the <a href=\"https://github.com/awslabs/amazon-eks-ami\">build-ami-for-eks-workernode </a>repository.</li>\n<li>Use the following command to upload the downloaded file to AWS S3 and then download to a linux server set up to connect to the AWS govcloud environment.\n\t<pre>aws s3 cp s3://&lt;bucket_and_folder_path&gt;/build-ami-for-eks-workernode-master.zip .\n</pre>\n</li>\n<li>Use the following command to unzip the package.\n\t<pre>unzip build-ami-for-eks-workernode-master.zip</pre>\n</li>\n<li>Modify the script according to the changes in <a href=\"https://github.com/awslabs/amazon-eks-ami/pull/513/files\">Adding FIPS support to EKS AMI</a>.</li>\n<li>Modify the following parameters in the <strong>eks-worker-al2.json</strong> file.\n\t<pre>\"aws_region\": &lt;Your region&gt; e.g us-gov-west-2,\n\"source_ami_owners\": \"amazon\",  </pre>\n</li>\n<li>Add VPC and subnet filters in the <strong>eks-worker-al2.json</strong> file after the ami_description on line 99. \n\t<pre>\"ami_description\": \"{{ user `ami_description` }}, (k8s: {{ user `kubernetes_version` }}, docker: {{ user `docker_version` }}, containerd: {{ user `containerd_version` }})\",\n      \"vpc_filter\": {\n        \"filters\": {\n          \"tag:Name\": \"smax-autorun-7784-vpc\"\n        }\n      },\n      \"subnet_filter\": {\n        \"filters\": {\n          \"tag:Name\": \"smax-autorun-7784-vpc-PublicSubnet1\"\n        }\n      }\n</pre>\n</li>\n<li>If the linux machine requires a proxy to access the internet, configure a proxy for the machine. For example: \n\t<pre>export http_proxy=http://myproxy.domain.net:8080\nexport https_proxy=http://myproxy.domain.net:8080 </pre>\n</li>\n<li>Copy and save the following script as build-ami.sh: \n\t<pre>#!/bin/bash \nAWS_ACCESS_KEY_ID=\"\"\nAWS_SECRET_ACCESS_KEY=\"\"\nAWS_REGION=\"\"\nEKS_VERSION=\"1.21\"\n\nwhile [ \"$1\" != \"\" ]; do\n    case $1 in\n      -i|--AWS_ACCESS_KEY_ID)\n        AWS_ACCESS_KEY_ID=$2\n        shift 2\n        ;;\n      -k|--AWS_SECRET_ACCESS_KEY)\n        AWS_SECRET_ACCESS_KEY=$2\n        shift 2\n\t\t;;\n\t  -r|--AWS_REGION)\n        AWS_REGION=$2\n        shift 2\n\t\t;;\n\t  -v|--EKS_VERSION)\n        EKS_VERSION=$2\n        shift 2\n        ;;\n      *|-*|-h|--help|/?|help) echo \"Usage: ./build_amis.sh -i AKIAICCGXXXXXXXXX -k ijEJD761vgxBXXXXXXXXXXX/Kt -r us-west-2 -v 1.21 \"\n        echo \"       -i|--AWS_ACCESS_KEY_ID        The access key used to communicate with AWS.\"\n        echo \"       -k|--AWS_SECRET_ACCESS_KEY    The secret key used to communicate with AWS.\"\n\t\techo \"       -r|--AWS_REGION               The region with AWS.\"\n\t\techo \"       -r|--EKS_VERSION               The EKS version\"\n        echo \"       -h|--help                     Show help.\" ; exit 1 ;;\n    esac\ndone\n\n#read -p \"Please input aws access key id:\" AWS_ACCESS_KEY_ID\nif [ -z ${AWS_ACCESS_KEY_ID} ]; then\n    #if [ -z ${AWS_ACCESS_KEY_ID} ]; then\n        echo \"A non-empty value is required for aws access key id.\"\n        echo \" Please add a similar parameter and value '-i LOHFJJFXXXXXXXXXXXCGXC'\"\n        exit 1\n    #fi\nfi\n\n#read -p \"Please input aws secret access key:\" AWS_SECRET_ACCESS_KEY\nif [ -z ${AWS_SECRET_ACCESS_KEY} ]; then\n    #if [ -z ${AWS_SECRET_ACCESS_KEY} ]; then\n        echo \"A non-empty value is required for aws secret access key.\"\n        echo \" Please add a similar parameter and value '-k L5wXXXknSnxxxxxxxxxxxxgxBhXXXXXXXXXXXXX1axc'\"\n        exit 1\n    #fi\nfi\n\nif [ -z ${AWS_REGION} ]; then\n    #if [ -z ${AWS_REGION} ]; then\n        echo \"A non-empty value is required for aws region.\"\n        echo \" Please add a similar parameter and value '-r us-west-2'\"\n        exit 1\n    #fi\nfi\n\n# install awscli\nsudo yum install -y python3\nsudo rm /usr/bin/python\nsudo ln -s /usr/bin/python3 /usr/bin/python\n\ncurl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"awscli-bundle.zip\"\nunzip -o awscli-bundle.zip\nsudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws\nsudo cp /usr/local/bin/aws /usr/bin/aws\nsudo ln -s /usr/local/bin/aws /usr/sbin/aws\n\naws configure set aws_access_key_id ${AWS_ACCESS_KEY_ID}\naws configure set aws_secret_access_key ${AWS_SECRET_ACCESS_KEY}\naws configure set default.region ${AWS_REGION}\n\n# install packer\nPACKER_VERSION=\"1.4.3\" #Update with your desired version\n\ncurl -Os https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip \nunzip -o packer_${PACKER_VERSION}_linux_amd64.zip -d /usr/bin\npv=`/usr/bin/packer --version`\necho \"Your packer version is: $pv\"\n\nmake ${EKS_VERSION} </pre>\n</li>\n<li>Run the following command on the linux machine to copy the build-ami.sh file to build-ami-for-eks-workernode-master:: \n\t<pre>cp build-ami.sh build-ami-for-eks-workernode-master/ </pre>\n</li>\n<li>Run the following commands on the linux machine to build ami: \n\t<pre>cd build-ami-for-eks-workernode-master/\nchmod 755 build-ami.sh \n./build-ami.sh -i &lt;aws_access_key_id&gt; -k &lt;aws_secret_access_key&gt; -r &lt;region&gt; -v &lt;k8s_version&gt; </pre>\n\tWhere:\n\n\t<ul>\n<li><code>&lt;</code>aws_access_key_id<code>&gt;</code>  <code>&lt;</code>aws_secret_access_key<code>&gt;</code> : are the keys you get when you set up your AWS account. If you don't have access to Security Credentials, contact your AWS administrators to check it.</li>\n<li><code>&lt;</code>region<code>&gt;</code> is the region, such as <em>us-gov-west-1</em>.</li>\n<li><code>&lt;</code>k8s_version<code>&gt;</code> is the kubenetes version, such as <em>1.22</em>. See <a href=\"/doc/423/26.1/ekssupportmatrix\">Support matrix for EKS deployment</a>.</li>\n</ul>\n</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}