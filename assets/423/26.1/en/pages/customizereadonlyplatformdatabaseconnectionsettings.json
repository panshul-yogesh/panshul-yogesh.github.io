{
  "title": "Customize read-only platform database connection settings",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>Out of the box, the read-only platform pods connect to the same database instance as the online platform pods do, by using the same database user that has read and write permissions to the databases. However, the read-only platform pods don't require write permission to the databases. For this reason, we highly recommend using a read-only DB user for the read-only platform pods. </p>\n<p>The following sections describe how to use a read-only DB user for the read-only platform pods.</p>\n<h2>Use a read-only DB user for the read-only platform pods</h2>\n<p>Connect to the database server as the DBA user through a client (for example: psql), and then create a new user in the database as follows: </p>\n<ol start=\"1\">\n<li>Create a read-only role by running the following SQL statements：\n\t<pre><code>CREATE ROLE maas_readaccess_role;\n\\c xservices_rms\nGRANT CONNECT ON DATABASE xservices_rms TO maas_readaccess_role;\nGRANT USAGE ON SCHEMA maas_admin TO maas_readaccess_role;\nGRANT SELECT ON ALL TABLES IN SCHEMA maas_admin TO maas_readaccess_role;\nALTER DEFAULT PRIVILEGES IN SCHEMA maas_admin GRANT SELECT ON TABLES TO maas_readaccess_role;\n\\c xservices_ems\nGRANT CONNECT ON DATABASE xservices_ems TO maas_readaccess_role;\nGRANT USAGE ON SCHEMA maas_admin TO maas_readaccess_role;\nGRANT SELECT ON ALL TABLES IN SCHEMA maas_admin TO maas_readaccess_role;\nALTER DEFAULT PRIVILEGES IN SCHEMA maas_admin GRANT SELECT ON TABLES TO maas_readaccess_role;</code></pre>\n</li>\n<li>Create a read-only user by running the following SQL statements:\n\t<pre><code>CREATE USER &lt;maas_readonly_user&gt; WITH PASSWORD &lt;maas_readonly_user_passwd&gt;;\nGRANT maas_readaccess_role TO &lt;maas_readonly_user&gt;;\nALTER ROLE &lt;maas_readonly_user&gt; SET search_path TO maas_admin;</code></pre>\n</li>\n<li>(Optional) Add the following lines to the <pgdata><code>pg_hba.conf</code> file. Ignore this step if you use a managed database.\n\t<pre><code>host xservices_ems &lt;maas_readonly_user&gt; 0.0.0.0/0 scram-sha-256\nhost xservices_rms &lt;maas_readonly_user&gt; 0.0.0.0/0 scram-sha-256</code></pre>\n</pgdata></li>\n<li>Apply the read-only database user to Service Management by running the following shell script.\n\t<pre><code>#!/bin/bash\nns=`kubectl get namespace |grep itsma | cut -f1 -d \" \"`\n\npreCheck()\n{\n   platform_pod_name=`kubectl get pods -n $ns|grep itom-xruntime-platform|grep '2/2'|grep Running|head -n 1|awk -F' ' '{print $1}'`\n   if [ -z $platform_pod_name ]; then\n     echo \"No platform pod is running. You have to run up at least one platform pod to continue.\"\n\t exit 1\n   fi\n}\n\ndbUserInfo()\n{\n  while [ true ] ; do\n      echo -n \"Please enter the read-only db username: \"\n      read db_user\n      if [[ ! -z ${db_user} ]]; then\n        break;\n      fi\n  done\n  \n  while [ true ] ; do\n      echo -n \"Please enter the password for $db_user: \"\n      read -s db_password\n      if [[ ! -z ${db_password} ]]; then\n        break;      \n      fi\n  done\n}\naddReadonlyDBVaultKey()\n{\n  kubectl exec $platform_pod_name -n $ns -c itom-xruntime-platform -- update_secret itom_itsma_db_readonly_password_secret_key $db_password\n  if [ $? -eq 1 ]; then\n     echo \"Add vault key error.\"\n\t exit 1\n  fi\n}\n\nupdateDatabaseConfigmap()\n{\n  kubectl get configmap database-configmap -n $ns -o json | jq --arg db_user \"$db_user\" '.data.xruntime_readonly_db_username = $db_user'| jq '.data.xruntime_readonly_db_password_key = \"{ \\\"itom-xruntime-infra\\\":\\\"itom_itsma_db_readonly_password_secret_key\\\" }\"'|kubectl replace -f -  \n \n  if [ $? -eq 1 ]; then\n     echo \"Update configmap error.\"\n\t exit 1\n  fi\n}\n\npreCheck\ndbUserInfo\naddReadonlyDBVaultKey\nupdateDatabaseConfigmap\nkubectl rollout restart deployment itom-xruntime-platform-readonly -n $ns\n</code></pre>\n</li>\n</ol>\n<h2>(Optional) Switch the read-only platform pods to a replica database instance</h2>\n<p>To prevent your primary database from being overloaded (e.g., the CPU usage ratio of the primary DB server is too high), you can route the read queries issued by the read-only platform pods to the read-only DB replica. To achieve this, you need to first prepare a replica database instance and then apply it. </p>\n<ul>\n<li>If using a managed database service, refer to its product documentation to create a replica. For example: To create an AWS RDS replica, refer to <a href=\"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ReadRepl.html#USER_ReadRepl.Create\" title=\"Create a read replica from a source DB instance\">Create a read replica from a source DB instance</a>.</li>\n<li>If using a single on-premises database, create a read-only replica from an existing DB instance. Refer to <a href=\"/doc/423/26.1/selfmanagedpgbackuprestore#Set_up_a_standby_(read-only)_database_server_without_failover\" title=\"Set up a standby (read-only) database server without failover\">Set up a standby (read-only) database server without failover</a> for details. </li>\n<li>If using a Patroni high availability (HA) database setup, use the HAProxy configuration to expose a port (for example 6000) on HAProxy to connect to the read-only database node. Refer to <a href=\"/doc/423/26.1/hasqlpatroni#PGHAwithPatroni-InstallHAProxy\" title=\"Install HAProxy for Patroni\">Install HAProxy for Patroni</a> for details.</li>\n</ul>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-note-icon\"></div>\n<div class=\"admonition-content admonition-note-content\">Make sure the certificate of the replica DB instance and primary DB instance are issued by the same CA, and that the CA certificates in the chain are trusted by Service Management.</div>\n</div>\n<p>To avoid overloading the primary database, run the following script.</p>\n<p>The script will update the database host and port in Kubernetes configmap <code>database-configmap</code> and perform a rolling restart of the read-only platform pods.</p>\n<pre><code>#!/bin/bash\nns=`kubectl get namespace |grep itsma | cut -f1 -d \" \"`\nreadDBInfo()\n{\n  while [ true ]; do\n      echo -n \"Please enter the read-only db host: \"\n      read db_host\n      if [[ ! -z ${db_host} ]]; then\n        break;\n      fi\n  done\n\n  while [ true ]; do\n      echo -n \"Please enter the read-only db port: \"\n      read  db_port\n      if [[ ! -z ${db_port} ]]; then\n        break;\n      fi\n  done\n}\n\nupdateDatabaseConfigmap()\n{\n  kubectl get configmap database-configmap -n $ns -o json | jq --arg db_host \"$db_host\" '.data.xruntime_readonly_db_host= $db_host'| jq --arg db_port \"$db_port\" '.data.xruntime_readonly_db_port = $db_port'|kubectl replace -f -\n\n  if [ $? -eq 1 ]; then\n     echo \"Update configmap error.\"\n         exit 1\n  fi\n}\n\nreadDBInfo\nupdateDatabaseConfigmap\nkubectl rollout restart deployment itom-xruntime-platform-readonly -n $ns\n</code></pre>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}