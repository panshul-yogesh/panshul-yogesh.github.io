{
  "title": "Scenario 3: Databases are corrupted",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>In this scenario, the database data is corrupted or deleted by accident or mistakenly. You need to restore the databases to the latest backup. Choose the restore procedure according to your deployment platforms.</p>\n<h2 id=\"Prerequisite\">Prerequisites</h2>\n<p>Before you start, make sure:</p>\n<ul>\n<li>You have backed up the databases.</li>\n<li>The Kubernetes cluster is functioning.</li>\n<li>There is no data corruption in the storage.</li>\n</ul>\n<h2>Restore RDS on AWS</h2>\n<p>If your suite is deployed on AWS, follow these steps to restore RDS:</p>\n<ol>\n<li>Run this command on the bastion to stop the system:\n\t<pre>./cdfctl.sh runlevel set -l DOWN -n core,itsma-xxxxx</pre>\n</li>\n<li>If your RDS instance still exists, take note of the database's <b>DB identifier</b> and then delete this old RDS. You will need the DB identifier later.</li>\n<li>Restore RDS by navigating to the <a href=\"http://console.aws.amazon.com/backup\">AWS Backup console</a> and following the official <a href=\"http://docs.aws.amazon.com/aws-backup/latest/devguide/restore-resource.html\">Restore a backup instructions</a>. Make sure you configure the same settings as the old RDS instance:\n\t<ul>\n<li>Under <b>Settings</b>, select the same <b>DB Instance Identifier</b> as the old RDS.</li>\n<li>Under <b>Network &amp; Security</b>, select the same VPC and subnet as the old RDS.</li>\n<li>Leave the remaining settings as is.</li>\n</ul>\n</li>\n<li>Select the RDS instance created in the last step and click <b>Modify</b>. Update the security group to the same as the old RDS.</li>\n<li>After the new RDS instance is created and modified successfully, run this command on the bastion to restart the system:\n\t<pre>./cdfctl.sh runlevel set -l UP -n core,itsma-xxxxx</pre>\n</li>\n<li>Run this command on the bastion to verify the restoration:\n\t<pre>kubectl get pod --all-namespaces|grep -v 1/1|grep -v 2/2|grep -v 3/3|grep -v 4/4|grep -v Completed </pre>\n\tThis command returns a list of abnormal pods. If RabbitMQ isn't ready, see <a href=\"/doc/423/26.1/rabbitmqnotstart\">RabbitMQ isn't ready</a>. When it returns no result, all of the suite pods are ready and you can perform quick tests to make sure the restoration has been completed successfully.</li>\n</ol>\n<h2>Restore databases on Azure</h2>\n<p>If your suite is deployed on Azure and uses Azure flexible servers, refer to <a href=\"https://docs.microsoft.com/en-us/azure/postgresql/flexible-server/how-to-restore-server-portal\">this page</a> to restore the databases.</p>\n<div class=\"Admonition_Note\"><span class=\"autonumber\">Notes</span>\n<ul>\n<li>When you are following the instructions given above, make sure the <strong>Compute + Storage</strong> configurations in the <strong>Server details</strong> section are consistent with your own setup.</li>\n<li>On the <strong>Networking</strong> tab, make sure the <strong>Virtual network</strong>, <strong>Subnet</strong>, and the <strong>Private DNS zone</strong> are consistent with your own setup.</li>\n</ul>\n</div>\n<p>After the database is restored, you need to reconfigure the flexible server in Service Management. </p>\n<h2>Restore databases on GCP</h2>\n<p>If your suite is deployed on GCP, follow these steps to restore Cloud SQL:</p>\n<ol>\n<li>Run this command on the bastion to stop the system:\n\t<pre>./cdfctl.sh runlevel set -l DOWN -n core,itsma-xxxxx</pre>\n</li>\n<li>Restore your Cloud SQL to the same instance using the GCP Cloud SQL native solution: See <a href=\"http://cloud.google.com/sql/docs/mysql/backup-recovery/pitr\">Use point-in-time recovery</a> for instructions.</li>\n<li>After the Cloud SQL instance is restored successfully, run this command on the bastion to restart the system:\n\t<pre>./cdfctl.sh runlevel set -l UP -n core,itsma-xxxxx</pre>\n</li>\n<li>Run this command on the bastion to verify the restoration:\n\t<pre>kubectl get pod --all-namespaces|grep -v 1/1|grep -v 2/2|grep -v 3/3|grep -v 4/4|grep -v Completed </pre>\n\tThis command returns a list of abnormal pods. If RabbitMQ isn't ready, see <a href=\"/doc/423/26.1/rabbitmqnotstart\">RabbitMQ isn't ready</a>. When it returns no result, all of the suite pods are ready and you can perform quick tests to make sure the restoration has been completed successfully.</li>\n</ol>\n<h2>Restore databases on OpenShift</h2>\n<p>If your suite is running on OpenShift, perform the following steps:</p>\n<ol>\n<li>Run this command on the bastion to stop the system:\n\t<pre>./cdfctl.sh runlevel set -l DOWN -n core,itsma-xxxxx</pre>\n</li>\n<li>Restore the databases according to your database documentation. </li>\n<li>After you have restored the databases, run this command on the bastion to restart the system:\n\t<pre>./cdfctl.sh runlevel set -l UP -n core,itsma-xxxxx</pre>\n</li>\n<li>Run this command on the bastion to verify the restoration:\n\t<pre>kubectl get pod --all-namespaces|grep -v 1/1|grep -v 2/2|grep -v 3/3|grep -v 4/4|grep -v Completed </pre>\n\tThis command returns a list of abnormal pods. If RabbitMQ isn't ready, see <a href=\"/doc/423/26.1/rabbitmqnotstart\">RabbitMQ isn't ready</a>. When it returns no result, all of the suite pods are ready and you can perform quick tests to make sure the restoration has been completed successfully.</li>\n</ol>\n<h2>Restore databases on Embedded Kubernetes</h2>\n<p>There are two methods to restore the databases:</p>\n<ul>\n<li>Using the original database server to restore its data.</li>\n<li>Using a new database server. It is important to confirm you have all the previous database data restored on the new database server.</li>\n</ul>\n<h3>Using the original database server</h3>\n<ol>\n<li>Run this command on the control plane node to stop the suite:\n\t<pre>./cdfctl.sh runlevel set -l DOWN -n core,itsma-xxxxx</pre>\n</li>\n<li>Restore the data on the original database server.\n\t<p>You can follow the PostgreSQL documentation to back up and restore the databases. You can also refer to <a href=\"/doc/423/26.1/selfmanagedpgbackuprestore\">Self-managed PostgreSQL backup and restore</a>.</p>\n</li>\n<li>Run this command on the control plane node to restart the suite:\n\t<pre>./cdfctl.sh runlevel set -l UP -n core,itsma-xxxxx</pre>\n</li>\n<li>Run this command on the control plane node to verify the restoration:\n\t<pre>kubectl get pod --all-namespaces|grep -v 1/1|grep -v 2/2|grep -v 3/3|grep -v 4/4|grep -v Completed</pre>\n\tThis command returns a list of abnormal pods. If RabbitMQ isn't ready, see <a href=\"/doc/423/26.1/rabbitmqnotstart\">RabbitMQ isn't ready</a>. When it returns no result, all of the suite pods are ready and you can perform quick tests to make sure the restoration has been completed successfully.</li>\n</ol>\n<h3>Using a new database server</h3>\n<div class=\"Admonition_Important\"><strong>Important: </strong>Before you start this process, ensure that you have restored the database data to the new database server. </div>\n<ol>\n<li>Update the TLS certificates of the database server for OMT. </li>\n<li>Update the database information for Service Management. See <a href=\"/doc/423/26.1/modifyexternaldbconfig\">Modify the configuration information of external databases</a> to update the database server and see <a href=\"/doc/423/26.1/changecertforpostgresql#Replace_the_PostgreSQL_CA_certificate_in_the_suite\">Replace the PostgreSQL CA certificate in the suite</a> to update the certificate.</li>\n<li>Run this command on the control plane node to verify the restoration:\n\t<pre>kubectl get pod --all-namespaces|grep -v 1/1|grep -v 2/2|grep -v 3/3|grep -v 4/4|grep -v Completed</pre>\n\tThis command returns a list of abnormal pods. If RabbitMQ isn't ready, see <a href=\"/doc/423/26.1/rabbitmqnotstart\">RabbitMQ isn't ready</a>. When it returns no result, all of the suite pods are ready and you can perform quick tests to make sure the restoration has been completed successfully.</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}