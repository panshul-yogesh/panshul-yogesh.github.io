{
  "title": "Restore Design and Deploy (DND)",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>After the suite is restored, perform the following steps to restore Design and Deploy (DND) if your source environment has DND deployed.</p>\n<h2>Manually redeploy DND after restoring the suite</h2>\n<p>After the suite is restored, for the tenants where DND was deployed previously, you need to manually redeploy DND with these steps:</p>\n<div class=\"Admonition_Note\"><span class=\"autonumber\">Note</span>  If your suite instance has multiple tenants in which DND was deployed, repeat these steps for each of them. You need to redeploy DND for the tenants where DND is listed on the <strong>Capability settings</strong> tab (<strong>Suite Administration</strong> &gt; <strong>TENANTS</strong> &gt; select the target tenant &gt; <strong>Capability settings</strong>) and the deployment <strong>Status</strong> is <strong>Done</strong>. </div>\n<ol>\n<li>Log in to a control plane node or worker node (embedded Kubernetes environment) or the bastion node (managed Kubernetes environment) and save the script below as <code>redeploy.sh</code>:\n\n\t<pre>#!/usr/bin/env sh\n##\n# This script will trigger force DND redeploy, typically for disaster recovery(DR) use.\n##\n\nITSMA_NAMESPACE=$(kubectl get ns | grep -e \"^itsma-\" | tr -s \" \" | cut -d\" \" -f1)\n# Figure out the internal IP of itom-bo-ats-svc.\nATS_SVC=$(kubectl get svc itom-bo-ats-svc -n ${ITSMA_NAMESPACE} -o=jsonpath='{.spec.clusterIP}')\n\ncurl -X PUT http://${ATS_SVC}:31027/tenants/${TENANT_ID}/capabilities/redeploy \\\n-H \"Content-type: application/json\" \\\n-H \"Cookie:LWSSO_COOKIE_KEY=${LWSSO_COOKIE_KEY}\" \\\n-d \"{\n  \\\"tenantId\\\": \\\"${TENANT_ID}\\\",\n  \\\"type\\\": \\\"DND\\\",\n  \\\"recovery\\\": true,\n  \\\"properties\\\": {\n    \\\"dndAdminUserId\\\": \\\"${DND_ADMIN_USER_ID}\\\",\n    \\\"dndAdminPassword\\\": \\\"${DND_ADMIN_PASSWORD}\\\",\n    \\\"dndTransportUserId\\\": \\\"${DND_TRANSPORT_USER_ID}\\\",\n    \\\"dndTransportUserPassword\\\": \\\"${DND_TRANSPORT_PASSWORD}\\\"\n  }\n}\" \\\n-v\n</pre>\n\tIn this script, you need to replace the following variables:\n\n\t<ul>\n<li><code>${LWSSO_COOKIE_KEY}</code>: Find the cookie key in the browser cookies after logging into the <strong>Suite Administration </strong>as <b>suite admin</b>. </li>\n<li><code>${TENANT_ID}</code>: Get the tenant ID by navigating to <strong>Suite Administration</strong> &gt; <strong>TENANTS</strong>.</li>\n<li><code>${DND_ADMIN_USER_ID}</code>/<code>${DND_TRANSPORT_USER_ID}</code>: Get the user IDs of the DND admin and DND transport users by navigating to <strong>Suite Administration</strong> &gt; <strong>TENANTS</strong> &gt; select the target tenant &gt; <strong>Capability settings</strong>. Or you can specify new users here. For example, '1000013'.</li>\n<li><code>${DND_ADMIN_PASSWORD}</code>/<code>${DND_TRANSPORT_PASSWORD}</code>: Replace them with the passwords of the users specified in the <code>${xxx_USER_ID}</code> variables.</li>\n</ul>\n</li>\n<li>Run the <code>redeploy.sh</code> script with the command below:\n\t<pre>sh redeploy.sh</pre>\n</li>\n<li>If the DND deploy controller is triggered successfully, the response payload should look as follows:\n\t<pre>{\n  \"name\": null,\n  \"description\": null,\n  \"displayLabel\": null,\n  \"links\": [],\n  \"id\": 10007,\n  \"createdBy\": \"1000005\",\n  \"createdAt\": \"2020-04-29T13:44:53.185\",\n  \"lastUpdatedBy\": \"1000005\",\n  \"lastUpdatedAt\": \"2020-04-30T06:00:53.327\",\n  \"owner\": null,\n  \"code\": null,\n  \"deleted\": false,\n  \"sysData\": false,\n  \"type\": \"DND\",\n  \"tenantId\": 192206027,\n  \"status\": \"NONE\",\n  \"enabled\": true,\n  \"operationHistoryId\": 10040,\n  \"properties\": {\n    \"appRoleId\": \"7a33411b-4985-3462-2887-f8ed49b0ebe5\",\n                ...\n  },\n  \"recovery\": true\n}\n</pre>\n</li>\n<li>Or else, if it fails, do further troubleshooting based on the returned HTTP status code: \n\t<table border=\"1\" cellpadding=\"1\" cellspacing=\"1\" style=\"width: 700px;\">\n<thead>\n<tr>\n<th scope=\"col\">Error code</th>\n<th scope=\"col\">Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>401</td>\n<td>The <code>{LWSSO_COOKIE_KEY}</code> is invalid.</td>\n</tr>\n<tr>\n<td>400</td>\n<td>See the \"reason\" field in the response payload for details.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>The URL following <code>curl</code> is invalid. For example, <code>{TENANT_ID}</code> is incorrect.</td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>The deploy controller can't deploy DND simultaneously for multiple tenants. Wait until the current deployment finishes and then you can initialize deployment for the next tenant. You can monitor the current deployment's status with the following script:\n\t<pre>#!/usr/bin/env sh\n##\n# This script monitors the status of DND deploy controller.\n##\n\nITSMA_NAMESPACE=$(kubectl get ns | grep -e \"^itsma-\" | tr -s \" \" | cut -d\" \" -f1)\n# Figure out the internal IP of itom-dnd-deploy-controller-svc.\nDND_DEPLOY_CONTROLLER_SVC=$(kubectl get svc itom-dnd-deploy-controller-svc -n ${ITSMA_NAMESPACE} -o=jsonpath='{.spec.clusterIP}')\n\nwatch -n 30 curl http://${DND_DEPLOY_CONTROLLER_SVC}:8080/v1/deployments/status\n</pre>\n\tIf the returned results look as follows, the deployment is still in progress.\n\n\t<pre>{\"status\":\"INSTALLING\",\"detail\":...</pre>\n\tOnce the <code>\"status\"</code> becomes <strong>\"INSTALL_FINISHED</strong>,<strong>\"</strong> <strong>\"FAILED</strong>,<strong>\"</strong> or <strong>\"IDLE</strong>,<strong>\"</strong> exit the monitoring process and you can redeploy DND for the next tenant.\n\n\t<div class=\"Admonition_Note\"><span class=\"autonumber\">Note</span>  When DND is redeployed, the DND force deployment process doesn't check whether the DND reporting user (dndReportingUser_&lt;tenant_id&gt;) already exist. Instead, these users are created directly with the following details:\n\n\t<table>\n<tbody>\n<tr>\n<th>User</th>\n<th>User name</th>\n<th>Email address</th>\n<th>Vault role name</th>\n<th>User password vault key</th>\n</tr>\n<tr>\n<td>DND reporting user</td>\n<td>dndReportingUser_&lt;tenant_id&gt;_&lt;N&gt;</td>\n<td>&lt;user_name&gt;@dummy.com</td>\n<td>dnd_app_role_&lt;tenant_id&gt;</td>\n<td>dnd_reporting_password_secret_key</td>\n</tr>\n</tbody>\n</table>\n</div>\n</li>\n</ol>\n<h2>Update aggregation provider settings</h2>\n<p><strong>Note</strong>: Make sure that you have already restored the tenant key chain.</p>\n<p>Replace the URLs in the aggregation provider settings to point to the target environment:</p>\n<ol>\n<li><span style=\"font-size:12pt\"><span style=\"font-family:SimSun\"><span style=\"font-size:11.5pt\"><span style='font-family:\"Segoe UI\",sans-serif'><span style=\"color:#212529\">In the agent interface, select <b>Administration </b>&gt; <b>Utilities </b>&gt; <b>Providers</b>.</span></span></span></span></span></li>\n<li><span style=\"font-size:12pt\"><span style=\"font-family:SimSun\"><span style=\"font-size:11.5pt\"><span style='font-family:\"Segoe UI\",sans-serif'><span style=\"color:#212529\">In the <b>AGGREGATION PROVIDER</b> view, click the provider in the ID column to display the selected provider.</span></span></span></span></span></li>\n<li><span style=\"font-size:12pt\"><span style=\"font-family:SimSun\"><span style=\"font-size:11.5pt\"><span style='font-family:\"Segoe UI\",sans-serif'><span style=\"color:#212529\">In the URL field, enter the new value for the target environment</span></span></span><span style=\"font-size:11.5pt\"><span style='font-family:\"Segoe UI\",sans-serif'><span style=\"color:#212529\">.</span></span></span></span></span></li>\n<li><span style=\"font-size:12pt\"><span style=\"font-family:SimSun\"><span style=\"font-size:11.5pt\"><span style='font-family:\"Segoe UI\",sans-serif'><span style=\"color:#212529\">Click <b>Save</b>.</span></span></span></span></span>\n<ol>\n</ol>\n</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}