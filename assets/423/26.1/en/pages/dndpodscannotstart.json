{
  "title": "DND pods cannot start after you enable PG SSL or change PG certificate (helm)",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\"></p><div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>After you enable SSL connections to external PostgreSQL or replace the external PostgreSQL certificate, the <code>itom-cmp-scheduler</code> pod crashes. If you run the <code>kubectl logs itom-cmp-scheduler-xxx -n &lt;itsma_namespace&gt; -c itom-cmp-scheduler</code> command, you see the following log:</p>\n<pre><code>Caused</code><code> by: sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target\n        at java.base/sun.security.validator.PKIXValidator.doBuild(PKIXValidator.java:439)\n        at java.base/sun.security.validator.PKIXValidator.engineValidate(PKIXValidator.java:306)\n        at java.base/sun.security.validator.Validator.validate(Validator.java:264)\n        at java.base/sun.security.ssl.X509TrustManagerImpl.checkTrusted(X509TrustManagerImpl.java:231)\n        at java.base/sun.security.ssl.X509TrustManagerImpl.checkServerTrusted(X509TrustManagerImpl.java:132)\n        at java.base/sun.security.ssl.CertificateMessage$T13CertificateConsumer.checkServerCerts(CertificateMessage.java:1335)</code></pre>\n<p>This issue occurs only in a helm deployment. </p>\n<h2>Cause</h2>\n<p>This issue occurs because the system uses an incorrect database certificate path. </p>\n<h2>Solution</h2>\n<p>Perform the following steps.</p>\n<ol>\n<li>If you don't remember the path of your custom <strong>my-values.yaml</strong> file, run the following command to get your yaml file.\n\n\t<pre>helm get values &lt;ESM_RELEASE_NAME&gt; -n &lt;ESM_NAMESPACE&gt; &gt; my-values.yaml</pre>\n<p>Where:</p>\n<ul>\n<li><code>&lt;ESM_RELEASE_NAME&gt;</code> is the release name, which you can obtain by using the following command:\n\n\t\t<pre>helm list -n &lt;ESM_NAMESPACE&gt; | awk '{print $1}'</pre>\n</li>\n<li><code>&lt;ESM_NAMESPACE&gt;</code> is the unique namespace of the ESM chart deployment.</li>\n</ul>\n</li>\n<li>Edit the <strong>my-values.yaml</strong> file, enable SSL connection by setting <code>tlsEnabled</code> to <code>true</code>. Your single certificate or certificate chain should be in one file. Then you can choose to paste the PEM content directly or encrypt the contents inside the certificate PEM file using the Base64 encryption method (for example, <code>cat &lt;certFile&gt; | base64</code>).  <br/>\n<br/>\n\tExample: \n\t<pre>global:\n  database:\n    tlsEnabled: true\n    tlsMode: verify-full    # or use verify-ca\n\n... ...\ndnd:   \n  caCertificates:\n    pg_ca.crt: &lt;cert-file-base64-encoded&gt; or PEM\n</pre>\n</li>\n<li>Run the following command to clean up unused jobs before applying the changes. \n\t<pre>kubectl get job -n &lt;ESM_NAMESPACE&gt;|grep -v NAME | awk '{print $1}'|xargs kubectl delete job -n &lt;ESM_NAMESPACE&gt;</pre>\n</li>\n<li>Run the following command to apply the database setting change. \n\t<pre>helm upgrade &lt;ESM_RELEASE_NAME&gt; &lt;ESM_HELM_CHART_PATH&gt; -n &lt;ESM_NAMESPACE&gt; -f my-values.yaml</pre>\n<p>Where <code>&lt;ESM_HELM_CHART_PATH&gt;</code> is the tar file in the extracted patch package containing the installation file. This file is located in the <em>charts </em>folder.</p>\n<p>Example:</p>\n<pre>helm upgrade sma ESM_Helm_Chart-2x.x/charts/esm-1.0.0+2x.x-xxx.tgz -n itsma -f my-values.yaml</pre>\n</li>\n<li>\n<p> Upload the PostgreSQL CA (with file extension <code>.crt</code>) to the NFS folder <code>&lt;config-volume&gt;/certificate/cmp/source</code> manually. Change the file ownership with the correct UID and GID. For example, run the following command: <br/>\n<code class=\"hljs\">chown 1999:1999 *.crt</code> </p>\n</li>\n<li>To avoid system downtime, you may download the <a href=\"https://marketplace.opentext.com/itom/content/service-management-automation-operation-toolkit\" title=\"SMA Operation Toolkit\">SMA Operation Toolkit</a> package (SMA-operation-toolkit-xxxx.xx.tar.gz and SMA-operation-toolkit-xxxx.xx.tar.gz.sig) and upload it to a control plane node (in an embedded Kubernetes environment) or to the bastion node (in a managed Kubernetes environment). Extract the package by running the command <code>tar zxvf SMA-operation-toolkit-xxxx.xx.tar.gz</code>. Then, you can use the <code>helm-restart-db-pods.sh </code> script to perform a rolling restart of the cmp pods.</li>\n<li>Run the following command to restart the cmp, dnd, and cgro pods:\n\t<pre>helm-<code>restart-db-pods.sh </code>CMP <code>helm-restart-db-pods.sh </code>DND<code>  helm-restart-db-pods.sh </code>CMPFinOps</pre>\n</li>\n<li>Run the following command to verify that all pods are up and running:\n\t<pre>kubectl get pod -n &lt;<em>ESM_NAMESPACE</em>&gt; |grep -v 1/1|grep -v 2/2|grep -v 3/3|grep -v 4/4|grep -v Completed</pre>\n</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}