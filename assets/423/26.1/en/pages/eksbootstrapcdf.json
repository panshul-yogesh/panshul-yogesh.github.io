{
  "title": "Configure an Application Load Balancer",
  "content": "<div class=\"mw-parser-output\">\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Suite administrator</td>\n<td>Bastion node</td>\n</tr>\n</tbody>\n</table>\n<p>Before you start the installation, you need to allocate an external access host (<span class=\"nanospell-typo\">FQDN</span>) for the suite if you don't have one. For example, via <span class=\"nanospell-typo\">AWS</span> route 53 services by following the <a href=\"https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resource-record-sets-creating.html\" title=\"Creating records by using the Amazon Route 53 console\"><span class=\"nanospell-typo\">AWS</span> document</a>.</p>\n<h2><a id=\"Configure_Application_Load_Balancer\" name=\"Configure_Application_Load_Balancer\" title=\"Configure Application Load Balancer\"></a>Configure Application Load <span class=\"nanospell-typo\">Balancer</span></h2>\n<p>The <span class=\"nanospell-typo\">SMA</span> suite leverages an <strong><span class=\"nanospell-typo\">AWS</span> Application Load <span class=\"nanospell-typo\">Balancer</span> (ALB)</strong> to distribute the incoming traffic across different targets. This section describes steps to prepare and configure your ALB.</p>\n<h3><a id=\"Create_an_Application_Load_Balancer\" name=\"Create_an_Application_Load_Balancer\" title=\"Create an Application Load Balancer\"></a>Create an Application Load <span class=\"nanospell-typo\">Balancer</span></h3>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-important-icon\"></div><div class=\"admonition-content admonition-important-content\"><div>The Application Load <span class=\"nanospell-typo\">Balancer</span> (ALB) you will create will be provisioned automatically and managed by <span class=\"nanospell-typo\">EKS</span>. Please do not configure anything on the ALB manually.</div></div></div>\n<div><a class=\"image\" href=\"\"> <img alt=\"SMA-X on AWS 2019.11-BYOK2-5.png\" data-file-height=\"972\" data-file-width=\"921\" src=\"../../../images/SMA-X_on_AWS_2019.11-BYOK2-5_f45e505e.png\" style=\"width: 921px; height: 972px;\"/> </a></div>\n<p>You first need to create an <strong><span class=\"nanospell-typo\">AWS</span> Load <span class=\"nanospell-typo\">Balancer</span> Controller</strong>. It will automatically provision an ALB when you create an Ingress for ports 443 and 5443 respectively, which are bound to the same ALB.</p>\n<p id=\"To_use_the_suite,_usually_you_need_to_configure three_listeners_for_ports 3000,_5443,_and_443:\">These three ports are used for the following purposes:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 28px; position: relative;\">Port 5443: used to access the <span class=\"nanospell-typo\">OMT</span> management portal</li><li style=\"margin-left: 28px; position: relative;\">Port 443: used to access the suite</li></ul>\n<h4><a id=\"Step_1_Create_AWS_Load_Balancer_Controller\" name=\"Step_1_Create_AWS_Load_Balancer_Controller\" title=\"Step 1: Create AWS Load Balancer Controller\"></a>Step 1: Create <span class=\"nanospell-typo\">AWS</span> Load <span class=\"nanospell-typo\">Balancer</span> Controller</h4>\n<p>The <span class=\"nanospell-typo\">AWS</span> load <span class=\"nanospell-typo\">balancer</span> controller helps to manage load <span class=\"nanospell-typo\">balancers</span> for a <span class=\"nanospell-typo\">Kubernetes</span> cluster. It will provision a load <span class=\"nanospell-typo\">balancer</span> for you when you create an Ingress.</p>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-important-icon\"></div><div class=\"admonition-content admonition-important-content\"><div>Ensure you have <span class=\"nanospell-typo\">kubectl</span>, <span class=\"nanospell-typo\">aws</span>, <span class=\"nanospell-typo\">eksctl</span> and helm command line tools installed on the machine you intend to use. If not, manually install them before proceeding.</div></div></div>\n<p>Save the script below as <code><strong><span class=\"nanospell-typo\">createALBcontroller</span>.sh</strong></code> and use it to create an <span class=\"nanospell-typo\">AWS</span> load <span class=\"nanospell-typo\">balancer</span> controller. This script performs steps listed in the official <a href=\"http://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html\" title=\"Installing the AWS Load Balancer Controller add-on\"><span class=\"nanospell-typo\">AWS</span> load <span class=\"nanospell-typo\">balancer</span> guide</a>.</p>\n<pre>#!/bin/sh\n#set -x\n\nfunction usage(){\ncat &lt;&lt;<span class=\"nanospell-typo\">EOF</span>\n*********************************************************************************************\nName:\n    $0 - This script is to help you create <span class=\"nanospell-typo\">AWS</span> <span class=\"nanospell-typo\">LoadBalaner</span> Controller.\nSynopsis:\n    $0 [options]\nOptions:\n  -r|--region. The region that same as your <span class=\"nanospell-typo\">EKS</span> cluster.\n  -c|--cluster. The name of your <span class=\"nanospell-typo\">EKS</span> cluster.\n  -h|--help              Show help.\nExample:\n    $0  [-r|--region &lt;<span class=\"nanospell-typo\">awsRegion</span>&gt;] [-c|--cluster &lt;<span class=\"nanospell-typo\">clusterName</span>&gt;]\n*********************************************************************************************\n<span class=\"nanospell-typo\">EOF</span>\n}\n\nif [[ $# &lt; 4 ]]; then\n    usage\n    exit 1\nfi\n\nwhile [[ $# &gt; 1 ]] ; do\n  key=\"$1\"\n  case $key in\n        -r|--region)\n          if [[ -z $2 ]] ; then echo \"-r|--region.The region that same as your <span class=\"nanospell-typo\">EKS</span> cluster.\" ; exit 1 ; fi ; REGION=$2 ; shift ;;\n        -c|--cluster)\n          if [[ -z $2 ]] ; then echo \"-c|--cluster.The name of your <span class=\"nanospell-typo\">EKS</span> cluster.\" ; exit 1 ; fi ; CLUSTER_NAME=$2 ; shift  ;;\n        *|-*|-h|--help|/?|help) usage ;exit 1 ;;\n  <span class=\"nanospell-typo\">esac</span>\n  shift\ndone\n\n\necho \"region is $REGION\"\necho \"cluster is $CLUSTER_NAME\"\n#parameters\n#identify=\"$RANDOM\"\nidentify=\"<span class=\"nanospell-typo\">autoalb</span>\"\npolicy_<span class=\"nanospell-typo\">arn</span>=\"\"\npolicy_name=\"${CLUSTER_NAME}-<span class=\"nanospell-typo\">lbc</span>-policy${identify}\"\nrole_name=\"${CLUSTER_NAME}-role${identify}\"\n#<span class=\"nanospell-typo\">iamsa</span>_name=\"${CLUSTER_NAME}-sa${identify}\"\n<span class=\"nanospell-typo\">iamsa</span>_name=\"<span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller\"\n\nfunction <span class=\"nanospell-typo\">isInstalled</span>(){\n  tool=$1\n  <span class=\"nanospell-typo\">res</span>=$(command -v $tool)\n  if [ \"$<span class=\"nanospell-typo\">res</span>\" == \"\" ];then\n    return 1;\n  else\n    return 0;\n  fi\n}\n\nfunction <span class=\"nanospell-typo\">checkPreTools</span>(){\n  <span class=\"nanospell-typo\">toolArra</span>=(<span class=\"nanospell-typo\">kubectl</span> <span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">eksctl</span> helm)\n  for t in ${<span class=\"nanospell-typo\">toolArra</span>[@]};do\n    <span class=\"nanospell-typo\">isInstalled</span> $t\n    re=$?\n    if [ \"$re\" == \"1\" ];then\n      echo \"No $t installed, please to install it before run the script.\"\n      exit 1;\n    fi\n  done;\n  return 0;\n}\n\nfunction cleanup(){\n  echo \"cleaning up old resources\"\n  helm <span class=\"nanospell-typo\">uninstall</span> -n <span class=\"nanospell-typo\">kube</span>-system <span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller &gt;/<span class=\"nanospell-typo\">dev</span>/null 2&gt;&amp;1\n  <span class=\"nanospell-typo\">kubectl</span> delete <span class=\"nanospell-typo\">serviceaccount</span> -n <span class=\"nanospell-typo\">kube</span>-system <span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller &gt;/<span class=\"nanospell-typo\">dev</span>/null 2&gt;&amp;1\n  policy_info=$(<span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">iam</span> list-policies --scope Local | jq \".Policies[] | select(.<span class=\"nanospell-typo\">PolicyName</span>==\\\"$policy_name\\\")\")\n  if [ \"$policy_info\"!= \"\"];then\n    policy_<span class=\"nanospell-typo\">arn</span>=$(echo $policy_info | jq -r .<span class=\"nanospell-typo\">Arn</span>)\n    <span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">iam</span> delete-policy --policy-<span class=\"nanospell-typo\">arn</span> $policy_<span class=\"nanospell-typo\">arn</span> &gt;/<span class=\"nanospell-typo\">dev</span>/null 2&gt;&amp;1\n  fi\n  <span class=\"nanospell-typo\">eksctl</span> delete <span class=\"nanospell-typo\">iamserviceaccount</span> --cluster=$CLUSTER_NAME --<span class=\"nanospell-typo\">namespace</span>=<span class=\"nanospell-typo\">kube</span>-system --name=${<span class=\"nanospell-typo\">iamsa</span>_name} -r $REGION &gt;/<span class=\"nanospell-typo\">dev</span>/null 2&gt;&amp;1\n  <span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">cloudformation</span> delete-stack --stack-name \"<span class=\"nanospell-typo\">eksctl</span>-${CLUSTER_NAME}-<span class=\"nanospell-typo\">addon</span>-<span class=\"nanospell-typo\">iamserviceaccount</span>-<span class=\"nanospell-typo\">kube</span>-system-${<span class=\"nanospell-typo\">iamsa</span>_name}\" --region $REGION &gt;/<span class=\"nanospell-typo\">dev</span>/null 2&gt;&amp;1\n  #<span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">iam</span> detach-role-policy --role-name ${role_name} --policy-<span class=\"nanospell-typo\">arn</span> $policy_<span class=\"nanospell-typo\">arn</span>\n  <span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">iam</span> delete-role --role-name ${role_name} &gt;/<span class=\"nanospell-typo\">dev</span>/null 2&gt;&amp;1\n  #sleep 3000\n  sleep 10s\n}\n\nerr() {\n  echo \"[$(date +'%Y-%m-%dT%H:%M:%S%z')]: $*\" &gt;&amp;2\n}\nfunction <span class=\"nanospell-typo\">preparePolicy</span>(){\n  echo \"Prepare policy...\"\n  if [[ $REGION =~ \"us-<span class=\"nanospell-typo\">gov</span>\" ]];then\n    policy_<span class=\"nanospell-typo\">url</span>=\"<a href=\"https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.14.1/docs/install/iam_policy_us-gov.json\" title=\"https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.14.1/docs/install/iam_policy_us-gov.json\">https://raw.githubusercontent.com/kubernetes-<span class=\"nanospell-typo\">sigs</span>/<span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller/v2.14.1/docs/install/<span class=\"nanospell-typo\">iam</span>_policy_us-<span class=\"nanospell-typo\">gov</span>.<span class=\"nanospell-typo\">json</span></a>\"\n    <span class=\"nanospell-typo\">arn</span>_location=\"<span class=\"nanospell-typo\">arn</span>:<span class=\"nanospell-typo\">aws</span>-us-<span class=\"nanospell-typo\">gov</span>\"\n  else\n    policy_<span class=\"nanospell-typo\">url</span>=\"<a href=\"https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.14.1/docs/install/iam_policy.json\" title=\"https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.14.1/docs/install/iam_policy.json\">https://raw.githubusercontent.com/kubernetes-<span class=\"nanospell-typo\">sigs</span>/<span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller/v2.14.1/docs/install/<span class=\"nanospell-typo\">iam</span>_policy.<span class=\"nanospell-typo\">json</span></a>\"\n  fi\n  code=$(curl -o <span class=\"nanospell-typo\">iam</span>_policy.<span class=\"nanospell-typo\">json</span> -w %{<span class=\"nanospell-typo\">http</span>_code} $policy_<span class=\"nanospell-typo\">url</span>)\n\n  if [ \"200\" != \"$code\" ];then\n    err \"Failed to get $policy_<span class=\"nanospell-typo\">url</span> from $policy_<span class=\"nanospell-typo\">url</span>\"\n    exit 1\n  fi\n\n  policy_info=$(<span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">iam</span> create-policy --policy-name $policy_name --policy-document file://<span class=\"nanospell-typo\">iam</span>_policy.<span class=\"nanospell-typo\">json</span>)\n  if [ \"$policy_info\" = \"\" ];then\n    policy_info=$(<span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">iam</span> list-policies --scope Local | jq \".Policies[] | select(.<span class=\"nanospell-typo\">PolicyName</span>==\\\"$policy_name\\\")\")\n    policy_<span class=\"nanospell-typo\">arn</span>=$(echo $policy_info | jq -r .<span class=\"nanospell-typo\">Arn</span>)\n  else\n    policy_<span class=\"nanospell-typo\">arn</span>=$(echo $policy_info | jq -r .Policy.<span class=\"nanospell-typo\">Arn</span>)\n  fi\n}\n\nfunction <span class=\"nanospell-typo\">prepareOIDC</span>(){\n  echo \"Prepare <span class=\"nanospell-typo\">oidc</span>...\"\n  <span class=\"nanospell-typo\">oidc</span>_id=$(<span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">eks</span> describe-cluster --name $CLUSTER_NAME --region $REGION --query \"cluster.identity.<span class=\"nanospell-typo\">oidc</span>.issuer\" --output text | cut -d '/' -f 5)\n  <span class=\"nanospell-typo\">oidc</span>=$(<span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">iam</span> list-open-id-connect-providers | <span class=\"nanospell-typo\">grep</span> $<span class=\"nanospell-typo\">oidc</span>_id)\n  if [ \"$<span class=\"nanospell-typo\">oidc</span>\" == \"\" ];then\n    <span class=\"nanospell-typo\">eksctl</span> <span class=\"nanospell-typo\">utils</span> associate-<span class=\"nanospell-typo\">iam</span>-<span class=\"nanospell-typo\">oidc</span>-provider --region=$REGION --cluster=$CLUSTER_NAME --approve\n  fi\n  re=$?\n  if [ \"$re\" == \"1\" ];then\n    err \"Failed to prepare <span class=\"nanospell-typo\">OIDC</span>.\"\n    exit 1\n  fi\n}\n\nfunction <span class=\"nanospell-typo\">createServiceAccount</span>(){\n  echo \"Prepare <span class=\"nanospell-typo\">iam</span> <span class=\"nanospell-typo\">serevice</span> account...\"\n  <span class=\"nanospell-typo\">eksctl</span> create <span class=\"nanospell-typo\">iamserviceaccount</span> \\\n  --cluster=$CLUSTER_NAME \\\n  --<span class=\"nanospell-typo\">namespace</span>=<span class=\"nanospell-typo\">kube</span>-system \\\n  --name=${<span class=\"nanospell-typo\">iamsa</span>_name} \\\n  --role-name=\"${role_name}\" \\\n  --attach-policy-<span class=\"nanospell-typo\">arn</span>=$policy_<span class=\"nanospell-typo\">arn</span> \\\n  --override-existing-<span class=\"nanospell-typo\">serviceaccounts</span> \\\n  -r $REGION \\\n  --approve\n  re=$?\n  if [ \"$re\" == \"1\" ];then\n    err \"Failed to create <span class=\"nanospell-typo\">iamserviceaccount</span>,check your <span class=\"nanospell-typo\">cloudformation</span> stack to see the reason.\"\n    exit 1\n  fi\n\n}\n\nfunction <span class=\"nanospell-typo\">createALBcontroller</span>(){\n  echo \"Start to install ALB controller\"\n  <span class=\"nanospell-typo\">kubectl</span> apply -k \"<span class=\"nanospell-typo\">github</span>.com/<span class=\"nanospell-typo\">aws</span>/<span class=\"nanospell-typo\">eks</span>-charts/stable/<span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller/<span class=\"nanospell-typo\">crds</span>?ref=master\"\n  helm <span class=\"nanospell-typo\">repo</span> add <span class=\"nanospell-typo\">eks</span> https://aws.github.io/eks-charts\n  helm <span class=\"nanospell-typo\">repo</span> update\n\n  helm install <span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller <span class=\"nanospell-typo\">eks</span>/<span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller \\\n  --set <span class=\"nanospell-typo\">clusterName</span>=$CLUSTER_NAME \\\n  --set <span class=\"nanospell-typo\">serviceAccount</span>.create=false \\\n  --set <span class=\"nanospell-typo\">serviceAccount</span>.name=<span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller \\\n  -n <span class=\"nanospell-typo\">kube</span>-system\n  re=$?\n  if [ \"$re\" == \"1\" ];then\n    err \"Failed to install ALB controller chart.\"\n    exit 1\n  fi\n  echo \"Wait <span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">loadbalancer</span> controller to be ready...\"\n  lb_controller_status=\"\"\n  n=0\n  while [ \"$lb_controller_status\" != \"2/2\" ];do\n    n=$((n+1))\n    lb_controller_status=$(<span class=\"nanospell-typo\">kubectl</span> get deployment -n <span class=\"nanospell-typo\">kube</span>-system <span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller --no-headers | <span class=\"nanospell-typo\">awk</span> '{print $2}')\n    if [ $n -gt 60 ];then\n      echo \"Timeout - failed to get <span class=\"nanospell-typo\">aws</span> <span class=\"nanospell-typo\">loadbalancer</span> controller ready.\"\n      exit 1\n    fi\n    sleep 10\n  done\n  <span class=\"nanospell-typo\">kubectl</span> get deployment -n <span class=\"nanospell-typo\">kube</span>-system <span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller\n\n}\n\nmain(){\n  <span class=\"nanospell-typo\">checkPreTools</span>\n  cleanup\n  <span class=\"nanospell-typo\">preparePolicy</span>\n  <span class=\"nanospell-typo\">prepareOIDC</span>\n  <span class=\"nanospell-typo\">createServiceAccount</span>\n  <span class=\"nanospell-typo\">createALBcontroller</span>\n}\nmain\n</pre>\n<p>After saving the above script, run the following commands to create the load <span class=\"nanospell-typo\">balancer</span> controller.  </p>\n<pre><code>chmod +x createALBcontroller.sh \n./createALBcontroller.sh   [-r|--region &lt;awsRegion&gt;] [-c|--cluster &lt;clusterName&gt;]</code></pre>\n<p>Where:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 28px; position: relative;\">\n<p><code>-r|--region</code>: Represents the region that same as your <span class=\"nanospell-typo\">EKS</span> cluster.</p>\n</li><li style=\"margin-left: 28px; position: relative;\">\n<p><code>-c|--cluster</code>: Represents the name of your <span class=\"nanospell-typo\">EKS</span> cluster. </p>\n</li></ul>\n<h4 id=\"Apply_a_new_certificate_for_Load_Balancer\"><a id=\"Step_2_Prepare_a_certificate_for_Application_Load_Balancer\" name=\"Step_2_Prepare_a_certificate_for_Application_Load_Balancer\" title=\"Step 2: Prepare a certificate for Application Load Balancer\"></a>Step 2: Prepare a certificate for Application Load <span class=\"nanospell-typo\">Balancer</span></h4>\n<p>Before creating an ALB, you need to allocate an <span class=\"nanospell-typo\">FQDN</span> for the suite (for example, via <span class=\"nanospell-typo\">AWS</span> route 53 services by following the <a href=\"https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resource-record-sets-creating.html\" title=\"Creating records by using the Amazon Route 53 console\"><span class=\"nanospell-typo\">AWS</span> document</a>) if you don't have one. You also need to prepare a certificate for the ALB using <strong>one of</strong> the following methods. Or else, unexpected errors may occur at later steps.</p>\n<h5 id=\"Request_a_certificate\"><a id=\"Request_a_certificate\" name=\"Request_a_certificate\" title=\"Request a certificate\"></a>Request a certificate</h5>\n<p>If you want to request a new certificate, follow these steps:</p>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Log in to the <span class=\"nanospell-typo\">AWS</span> Management Console in your target region.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Navigate to <b>All services</b> &gt; <strong>Security, Identity, &amp; Compliance</strong> &gt; <b>Certificate Manager</b>.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">If the <code><span class=\"nanospell-typo\">firstrun</span></code> page is displayed, click <b>Get Started</b>.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Click <b>Request a certificate</b>.</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Select <b>Request a public certificate</b> and click <b>Next</b>.</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Specify your target domain name. Use an asterisk (*) to request a <span class=\"nanospell-typo\">wildcard</span> certificate to protect several sites in the same domain. For example, <em>*.<span class=\"nanospell-typo\">testsma</span>-ng.org</em><b>.</b></li><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Select <b><span class=\"nanospell-typo\">DNS</span> validation</b> or <b>Email validation</b> according to your permission.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Click <b>Request</b>.</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Click <b>View Certificate</b> and then click <b>Create records in Route 53</b>.</li><li style=\"--number-width: 19px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Finish the certificate validation based on the method you just selected. For more information, see <a href=\"https://docs.aws.amazon.com/console/acm/validation\" rel=\"nofollow\" target=\"1\" title=\"DNS validation\"><span class=\"nanospell-typo\">AWS</span> <span class=\"nanospell-typo\">DNS</span> validation <span class=\"nanospell-typo\">doumentation</span></a>.</li></ol>\n<h5 id=\"Import_a_certificate\"><a id=\"Import_a_certificate\" name=\"Import_a_certificate\" title=\"Import a certificate\"></a>Import a certificate</h5>\n<p>If you want to use a customized certificate, follow these steps:</p>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Log in to the <span class=\"nanospell-typo\">AWS</span> Management Console in your target region.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Navigate to <b>All services</b> &gt; <strong>Security, Identity, &amp; Compliance</strong> &gt; <b>Certificate Manager</b>.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">If the <code><span class=\"nanospell-typo\">firstrun</span></code> page is displayed, click <b>Get Started</b>.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Click <b>Import</b>.</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">For <b>Certificate body</b>, paste the <span class=\"nanospell-typo\">PEM</span>-encoded certificate to import.</li><li style=\"--number-width: 12px; --number-spacing: 24px; margin-left: 36px; position: relative;\">For <b>Certificate private key</b>, paste the <span class=\"nanospell-typo\">PEM</span>-encoded unencrypted private key that matches the certificate's public key. <b>Important:</b> Currently, services integrated with <span class=\"nanospell-typo\">AWS</span> Certificate Manager support only the <code><span class=\"nanospell-typo\">RSA</span>_1024</code> and <code><span class=\"nanospell-typo\">RSA</span>_2048</code> algorithms.</li><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">(Optional) For <b>Certificate chain</b>, paste the <span class=\"nanospell-typo\">PEM</span>-encoded certificate chain.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Click <b>Next &gt; Review and import &gt; Import.</b></li></ol>\n<p>After preparing the certificate, ensure the status are marked as issued by <span class=\"nanospell-typo\">AWS</span>.</p>\n<h4 id=\"&lt;strong&gt;Step_3:_Create_an_Ingress_for_the_installation_portal&lt;/strong&gt;\"><a id=\"Step_3_Create_an_Ingress\" name=\"Step_3_Create_an_Ingress\" title=\"Step 3: Create an Ingress\"></a>Step 3: Create an Ingress</h4>\n<p>The final step to create your ALB is to create an ingress. You will need to create an Ingress for both the <span class=\"nanospell-typo\">OMT</span> management portal (if your deployment requires <span class=\"nanospell-typo\">OMT</span> <span class=\"nanospell-typo\">AppHub</span>) and the Suite.</p>\n<p>If your deployment requires <span class=\"nanospell-typo\">OMT</span> <span class=\"nanospell-typo\">AppHub</span>, you first need to create the ingress for <span class=\"nanospell-typo\">OMT</span> management portal before you install the Suite. If you don't wish to use <span class=\"nanospell-typo\">OMT</span> <span class=\"nanospell-typo\">AppHub</span> in your deployment, you will create an ingress for the suite in a later step. </p>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-note-icon\"></div><div class=\"admonition-content admonition-note-content\"><div>Perform the steps in this section only if you wish to use <span class=\"nanospell-typo\">OMT</span> <span class=\"nanospell-typo\">AppHub</span> for your deployment.</div></div></div>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Save the content below as <code>management-portal-ingress.<span class=\"nanospell-typo\">yaml</span></code>:\n\n\t<pre><span class=\"nanospell-typo\">apiVersion</span>: networking.k8s.io/v1\nkind: Ingress\n<span class=\"nanospell-typo\">metadata</span>:\n  name: \"<span class=\"nanospell-typo\">mng</span>-ingress\"\n  <span class=\"nanospell-typo\">namespace</span>: \"core\"\n  annotations:\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/scheme: <span class=\"nanospell-typo\">internet</span>-facing\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/group.name: &lt;application_<span class=\"nanospell-typo\">loadbalancer</span>_name&gt;\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/listen-ports: '[{\"<span class=\"nanospell-typo\">HTTPS</span>\": 5443}]'\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/<span class=\"nanospell-typo\">backend</span>-protocol: <span class=\"nanospell-typo\">HTTPS</span>\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/<span class=\"nanospell-typo\">healthcheck</span>-protocol: <span class=\"nanospell-typo\">HTTPS</span>\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/<span class=\"nanospell-typo\">healthcheck</span>-port: traffic-port\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/<span class=\"nanospell-typo\">healthcheck</span>-path: /\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/success-codes: 200-399\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/target-type: instance\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/certificate-<span class=\"nanospell-typo\">arn</span>: &lt;certificate_<span class=\"nanospell-typo\">arn</span>&gt;\n    alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/<span class=\"nanospell-typo\">ssl</span>-policy: <span class=\"nanospell-typo\">ELBSecurityPolicy</span>-TLS13-1-2-<span class=\"nanospell-typo\">Res</span>-2021-06\n    <span class=\"nanospell-typo\">kubernetes</span>.io/ingress.class: alb\n  labels:\n    app: <span class=\"nanospell-typo\">mng</span>-<span class=\"nanospell-typo\">nginx</span>-ingress\nspec:\n  <span class=\"nanospell-typo\">ingressClassName</span>: alb\n  <span class=\"nanospell-typo\">tls</span>:\n  - hosts:\n    - &lt;external_access_host&gt;\n  rules:\n    - host: \n      <span class=\"nanospell-typo\">http</span>:\n        paths:\n          - <span class=\"nanospell-typo\">backend</span>:\n              service: \n                name: \"portal-ingress-controller-<span class=\"nanospell-typo\">svc</span>\"\n                port: \n                  number: 5443\n            path: /*\n            <span class=\"nanospell-typo\">pathType</span>: <span class=\"nanospell-typo\">ImplementationSpecific</span></pre>\n<p>Replace the following with the actual values:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><code>&lt;application_<span class=\"nanospell-typo\">loadbalancer</span>_name&gt;</code>: the group name for the ALB to be created.\n\n\t\t<div class=\"admonition\"><div class=\"admonition-icon admonition-important-icon\"></div><div class=\"admonition-content admonition-important-content\"><div>The ALB group name must begin and end with an alphanumeric character, should contain no space and can contain only alphanumeric characters and hyphens. For example, <em>main-alb</em>. You need to use the same value when you create another Ingress resources.</div></div></div>\n</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;certificate_<span class=\"nanospell-typo\">arn</span>&gt;</code>: the<a href=\"https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html\" title=\"Amazon Resource Names (ARNs)\"> resource name</a> of the prepared certificate. For example, <em><span class=\"nanospell-typo\">arn</span>:<span class=\"nanospell-typo\">aws</span>:<span class=\"nanospell-typo\">acm</span>:region:123456789012:certificate/12345678-1234-1234-1234-123456789012</em>.</li><li style=\"margin-left: 40px; position: relative;\"><code>&lt;external_access_host&gt;</code>: the <span class=\"nanospell-typo\">FQDN</span> you've allocated for the suite. For example, <em>www.example.com</em>.</li><li style=\"margin-left: 40px; position: relative;\">(<span class=\"nanospell-typo\">FIPS</span> mode only): <code>alb.ingress.<span class=\"nanospell-typo\">kubernetes</span>.io/<span class=\"nanospell-typo\">ssl</span>-policy</code>: replace this parameter value with <code><span class=\"nanospell-typo\">ELBSecurityPolicy</span>-TLS13-1-2-<span class=\"nanospell-typo\">FIPS</span>-2023-04</code>.</li></ul>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\"> Run the following command to apply the saved <span class=\"nanospell-typo\">YAML</span> file:\n\t<pre><span class=\"nanospell-typo\">kubectl</span> create -f management-portal-ingress.<span class=\"nanospell-typo\">yaml</span>\n</pre>\n<p>To check the ingress status, run the command below.</p>\n<pre><span class=\"nanospell-typo\">kubectl</span> get ingress -n core <span class=\"nanospell-typo\">mng</span>-ingress </pre>\n<p>The output should be as below and should contain the <strong><span class=\"nanospell-typo\">elb</span></strong> address.</p>\n<pre>NAME             CLASS    HOSTS   ADDRESS         PORTS     AGE\n<span class=\"nanospell-typo\">mng</span>-ingress    &lt;none&gt;<none>   *         xxx.xxx.<span class=\"nanospell-typo\">elb</span>.<span class=\"nanospell-typo\">amazonaws</span>.com   80, 443   147m </none></pre>\n<p>Now an ALB is created and the Ingress for port 5443 is bound to this ALB automatically.</p>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-note-icon\"></div><div class=\"admonition-content admonition-note-content\"><div>  If the above command fails to get the <span class=\"nanospell-typo\">elb</span> address, use the commands below to troubleshoot. You can then refer to <a href=\"https://aws.amazon.com/premiumsupport/knowledge-center/load-balancer-troubleshoot-creating/\" title=\"AWS load balancer troubleshooting page\"><span class=\"nanospell-typo\">AWS</span> load <span class=\"nanospell-typo\">balancer</span> troubleshooting page</a> and visit error recreating load <span class=\"nanospell-typo\">balancer</span> for possible solutions.\n\n\t<pre><span class=\"nanospell-typo\">kubectl</span> describe ingress -n core <span class=\"nanospell-typo\">mng</span>-ingress \n<span class=\"nanospell-typo\">kubectl</span> logs -n <span class=\"nanospell-typo\">kube</span>-system deployment.<span class=\"nanospell-typo\">apps</span>/<span class=\"nanospell-typo\">aws</span>-load-<span class=\"nanospell-typo\">balancer</span>-controller </pre>\n</div></div></div>\n</li></ol>\n<p>Now you can access the <span class=\"nanospell-typo\">OMT</span> Management Portal via <code><span class=\"nanospell-typo\">https</span>://&lt;external_access_host&gt;:5443</code>.</p>\n<h3 id=\"Bind_an_FQDN_with_Application_Load_Balancer\"><a id=\"Bind_an_FQDN_with_Application_Load_Balancer\" name=\"Bind_an_FQDN_with_Application_Load_Balancer\" title=\"Bind an FQDN with Application Load Balancer\"></a>Bind an <span class=\"nanospell-typo\">FQDN</span> with Application Load <span class=\"nanospell-typo\">Balancer</span></h3>\n<p>After creating an ingress, you will need to bind your <span class=\"nanospell-typo\">FQDN</span> with the ALB you created. If your deployment doesn't use <span class=\"nanospell-typo\">OMT</span> <span class=\"nanospell-typo\">AppHub</span>, perform this step after you have installed the suite and configured an ingress for the suite.</p>\n<p>Amazon Route 53 is a highly available and scalable cloud Domain Name System (<span class=\"nanospell-typo\">DNS</span>) web service. In this installation procedure example, Amazon Route 53 is used to bind an <span class=\"nanospell-typo\">FQDN</span> (&lt;external_access_host&gt;) such as www.example.com to ALB so that end users can easily access the suite from web browsers.</p>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-note-icon\"></div><div class=\"admonition-content admonition-note-content\"><div>Amazon Route 53 isn't the only option. If your domain name isn't provided by Route 53, you may contact your domain name provider to bind the domain name to the Application Load <span class=\"nanospell-typo\">Balancer</span> <span class=\"nanospell-typo\">DNS</span> name.</div></div></div>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Save the following file as <strong><span class=\"nanospell-typo\">createRecord</span>.<span class=\"nanospell-typo\">json</span></strong>:\n\n\t<pre>{\n    \"Comment\": \"Create Alias resource record sets in Route 53\",\n    \"Changes\": [\n        {\n            \"Action\": \"CREATE\",\n            \"<span class=\"nanospell-typo\">ResourceRecordSet</span>\": {\n                \"Name\": \"{{resource_record_set_name}}\",\n                \"Type\": \"A\",\n                \"<span class=\"nanospell-typo\">AliasTarget</span>\": {\n                    \"<span class=\"nanospell-typo\">HostedZoneId</span>\": \"{{alb_hosted_zone_id}}\",\n                    \"<span class=\"nanospell-typo\">DNSName</span>\": \"{{alb_<span class=\"nanospell-typo\">dns</span>_name}}\",\n                    \"<span class=\"nanospell-typo\">EvaluateTargetHealth</span>\": false\n                }\n            }\n        }\n    ]\n}\n</pre>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following commands to specify your own values for the alias record set:\n\t<pre><span class=\"nanospell-typo\">sed</span> -i -e s@{{resource_record_set_name}}@${EXTERNAL_ACCESS_HOST}@g ./<span class=\"nanospell-typo\">createRecord</span>.<span class=\"nanospell-typo\">json</span>\n<span class=\"nanospell-typo\">sed</span> -i -e s@{{alb_<span class=\"nanospell-typo\">dns</span>_name}}@${ALB_<span class=\"nanospell-typo\">DNS</span>}@g ./<span class=\"nanospell-typo\">createRecord</span>.<span class=\"nanospell-typo\">json</span>\n<span class=\"nanospell-typo\">sed</span> -i -e s@{{alb_hosted_zone_id}}@${ALB_HOSTED_ZONE_ID}@g ./<span class=\"nanospell-typo\">createRecord</span>.<span class=\"nanospell-typo\">json</span>\n</pre>\n<p>where:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><strong>{EXTERNAL_ACCESS_HOST}</strong> is the <span class=\"nanospell-typo\">FQDN</span> prepared for the Application Load <span class=\"nanospell-typo\">Balancer</span>.</li><li style=\"margin-left: 40px; position: relative;\"><strong>{ALB_<span class=\"nanospell-typo\">DNS</span>}</strong> is the <span class=\"nanospell-typo\">DNS</span> name of the created Application Load <span class=\"nanospell-typo\">Balancer</span>. You can find the <span class=\"nanospell-typo\">DNS</span> name of the ALB on its <b>Details</b> section.</li><li style=\"margin-left: 40px; position: relative;\"><strong>{ALB_HOSTED_ZONE_ID}</strong> is the hosted zone ID of the created ALB. For example, <em>Z1H1FL5HABSF5</em>. You can find your <span class=\"nanospell-typo\">ALB's</span> hosted zone ID by running the following command. Replace <code>{ALB_<span class=\"nanospell-typo\">DNS</span>_Name}</code> with your actual value.\n\t\t<pre><span class=\"nanospell-typo\">aws</span> elbv2 describe-load-<span class=\"nanospell-typo\">balancers</span> --query \"<span class=\"nanospell-typo\">LoadBalancers</span>[?<span class=\"nanospell-typo\">DNSName</span>==\\`${ALB_<span class=\"nanospell-typo\">DNS</span>_Name}\\`].<span class=\"nanospell-typo\">CanonicalHostedZoneId</span>\" --output text</pre>\n</li></ul>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Update the <span class=\"nanospell-typo\">AWS</span> <span class=\"nanospell-typo\">CLI</span> by following the steps described in the <a href=\"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html\" title=\"Install or update the latest version of the AWS CLI\"><span class=\"nanospell-typo\">AWS</span> <span class=\"nanospell-typo\">CLI</span> documentation</a>.</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the command below to create the Route 53 record set:\n\t<pre>route53_hosted_zone_id=$(<span class=\"nanospell-typo\">aws</span> route53 list-hosted-zones-by-name --query \"<span class=\"nanospell-typo\">HostedZones</span>[?Name==\\`${domain_name}.\\`].Id\" --output text | <span class=\"nanospell-typo\">sed</span> s@/<span class=\"nanospell-typo\">hostedzone</span>/@@g)\n<span class=\"nanospell-typo\">aws</span> route53 change-resource-record-sets --hosted-zone-id ${route53_hosted_zone_id} --change-batch file://./<span class=\"nanospell-typo\">createRecord</span>.<span class=\"nanospell-typo\">json</span></pre>\n<p>Replace <code><b>${domain_name}</b></code> with your actual value.</p>\n</li></ol>\n<p>Now, you can access the portal via <code><span class=\"nanospell-typo\">https</span>://&lt;external_access_host&gt;.</code> </p>\n<h2><a id=\"External_references\" name=\"External_references\" title=\"External references\"></a>External references</h2>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 28px; position: relative;\">For more information about Application Load <span class=\"nanospell-typo\">Balancers</span>, see <a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html\" title=\"What is an Application Load Balancer?\"><span class=\"nanospell-typo\">AWS</span> What is an Application Load <span class=\"nanospell-typo\">Balancer</span>?</a>.</li><li style=\"margin-left: 28px; position: relative;\">For more details on <span class=\"nanospell-typo\">AWS</span> Load <span class=\"nanospell-typo\">Balancer</span> Controller, see <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html\" title=\"Installing the AWS Load Balancer Controller add-on\"><span class=\"nanospell-typo\">AWS</span> Load <span class=\"nanospell-typo\">Balancer</span> documentation</a>.</li><li style=\"margin-left: 28px; position: relative;\">If you experience common Application Load <span class=\"nanospell-typo\">Balancer</span> issues, see <a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html\" rel=\"nofollow\" target=\"1\" title=\"What is an Application Load Balancer?\"><span class=\"nanospell-typo\">AWS</span> Load <span class=\"nanospell-typo\">Balancer</span> documentation</a>.</li><li style=\"margin-left: 28px; position: relative;\">For more details on how to create alias record set in Route 53, see <a href=\"https://aws.amazon.com/premiumsupport/knowledge-center/alias-resource-record-set-route53-cli/\" title=\"How do I create alias resource record sets in Route 53 using the AWS CLI?\"><span class=\"nanospell-typo\">AWS</span> Load <span class=\"nanospell-typo\">Balancer</span> documentation</a>.</li></ul>\n</div>",
  "modifiedon": "2025-11-03 05:16:53"
}