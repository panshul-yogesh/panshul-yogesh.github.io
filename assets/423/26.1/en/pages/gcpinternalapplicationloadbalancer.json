{
  "title": "Configure GCP internal application load balancer",
  "content": "<div class=\"mw-parser-output\"><br/><div>If you have installed and enabled one or more Suite capabilities, you should also deploy an internal load balancer (LB) for each capability for the ESM integration.</div>\n<h2>Prerequisite</h2>\n<div>Before you deploy the internal LB, make sure the following requirements are satisfied:</div>\n<ul>\n<li>You are able to run <code>gcloud </code>and <code>kubectl </code>commands on the bastion node.</li>\n<li>You have deployed the Suite successfully.</li>\n<li>A private cloud DNS zone is available.</li>\n<li>You have followed the instructions in the <strong>Configure GCP external application load balancer </strong>topic to configure the external LB.</li>\n</ul>\n<h2>Deploy a GCP Internal LB</h2>\n<ol>\n<li>1. Set up the Proxy-Only subnet. For more details, see the official documenation on the topic <a href=\"https://cloud.google.com/load-balancing/docs/l7-internal/setting-up-l7-internal#configuring_the_proxy-only_subnet.\" title=\"Set up a regional internal Application Load Balancer with VM instance group backends\">Set up a regional internal Application Load Balancer with VM instance group backends</a>.\n\n\t<pre><code class=\"language-bash\">gcloud compute networks subnets create proxy-only-subnet \\\n  --purpose=REGIONAL_MANAGED_PROXY \\\n  --role=ACTIVE \\\n  --region=&lt;region name, e.g. us-west1&gt; \\\n  --network=&lt;vpc name&gt; \\\n  --range=&lt;IP CIDR, e.g. 10.129.0.0/24&gt;\n</code></pre>\n</li>\n<li>Set up a private subnet for the internal LB. You will use this subnet to allocate IP address for all internal LBs.\n\t<pre><code class=\"language-bash\">gcloud compute networks subnets create esm-internal-lb-subnet \\\n    --network=NETWORK \\\n    --range=&lt;IP CIDR, e.g. 10.129.1.0/24&gt; \\\n    --region=&lt;region name, e.g. us-west1&gt;</code></pre>\n</li>\n<li>Reserve a static internal IP address for the internal LB from the private subnet. Run the following command on the bastion node:\n\t<pre><code class=\"language-bash\">gcloud compute addresses create smax-internal-lb \\\n--region &lt;region name, e.g. us-west1&gt; \\\n--subnet esm-internal-lb-subnet \\\n--addresses &lt;IP address, e.g. 10.129.1.2&gt;\n</code></pre>\n</li>\n<li>Bind the IP address of the internal LB with a private DNS record.</li>\n<li>Copy the following content to a file named <strong>smax-internal-lb-svc.yaml </strong>on the bastion node. \n\t<pre><code class=\"language-yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    cloud.google.com/neg: '{\"ingress\": true}'\n    cloud.google.com/backend-config: '{\"ports\": {\"8443\":\"smax-lb-backendconfig\"}}'\n    cloud.google.com/app-protocols: '{\"https-port\":\"HTTPS\"}'\n\n  name: smax-internal-lb-svc\nspec:\n  ports:\n  - name: https-port\n    port: 8443\n    protocol: TCP\n    targetPort: 8443\n  selector:\n    app: itom-nginx-ingress\n    app.kubernetes.io/instance: sma\n    app.kubernetes.io/name: nginx\n  sessionAffinity: None\n  type: ClusterIP</code></pre>\n</li>\n<li>Create the <code>smax-internal-lb-svc</code> service resource:\n\t<pre><code>kubectl create -f smax-internal-lb-svc.yaml -n &lt;smax-namespace&gt;</code></pre>\n</li>\n<li>Copy the following content to a file named <strong>smax-integration-cert-secret.yaml</strong> on the bastion node.\n\t<pre><code class=\"language-yaml\">apiVersion: v1\ndata:\n  tls.crt: &lt;Base64 encoded server.crt&gt;\n  tls.key: &lt;Base64 encoded server.key&gt;\nkind: Secret\nmetadata:\n  name: smax-integration-cert-secret\ntype: Opaque</code></pre>\n</li>\n<li>Create the <code>smax-integration-cert-secret</code> secret resource:\n\t<pre><code>kubectl create -f smax-integration-cert-secret.yaml -n &lt;smax-namespace&gt;</code></pre>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-note-icon\"></div>\n<div class=\"admonition-content admonition-note-content\">The &lt;Base64 encoded server.crt&gt; certificate is for the internal LB's FQDN. This can be a self-signed certificate.</div>\n</div>\n</li>\n<li>Copy the following content to a file named <strong>smax-internal-lb-ingress.yaml </strong>on the bastion node.\n\t<pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: \"smax-internal-lb-ing\"\n  annotations:\n    kubernetes.io/ingress.class: gce-internal\n    kubernetes.io/ingress.regional-static-ip-name: \"smax-internal-lb\"\n    kubernetes.io/ingress.allow-http: \"false\"\nspec:\n  tls:\n    - secretName: smax-integration-cert-secret\n  rules:\n    - http:\n        paths:\n          - backend:\n              service: \n                name: \"smax-internal-lb-svc\"\n                port: \n                  number: 8443\n            path: /*\n            pathType: ImplementationSpecific</code></pre>\n</li>\n<li>Create the <strong>smax-internal-lb-ing</strong> ingress resource.\n\t<pre><code>kubectl create -f smax-internal-lb-ingress.yaml -n &lt;smax-namespace&gt;</code></pre>\n</li>\n</ol>\n</div>",
  "modifiedon": "2025-10-24 08:51:12"
}