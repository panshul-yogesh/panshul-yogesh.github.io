{
  "title": "Failed to pull images during upgrade when McAfee on-access scan is enabled",
  "content": "<div class=\"mw-parser-output\"><span class=\"snippet-start\" data-sname=\"423-25.4-423-25.3-ImagePullFailsUpgrade||N\"></span><p class=\"mw-empty-elt\">\n</p><p>When you try to upgrade OMT when McAfee on access scan is enabled, the upgrade process fails to pull images and the upgrade fails. If you check the pod log when this issue occurs, you see entries that resemble the following:</p>\n<pre><code>failed to extract layer sha256:18c2069f7a9897b09047aa2ed5cae1ef0476729180af5053560a8d18e2b31dac: failed to unmount /opt/cdf/data/containerd/root/tmpmounts/containerd-mount4146036970: failed to unmount target /opt/cdf/data/containerd/root/tmpmounts/containerd-mount4146036970: device or resource busy: unknown.</code></pre>\n<div class=\"Admonition_Note\"><strong>Note:</strong> You may experience issues such as memory leaks in OMT if you run a version of McAfee earlier than 10.7.  We strongly recommend that you run McAfee 10.7 or a later version.</div>\n<h2>Cause</h2>\n<p>This issue occurs because McAfee hasn't finished scanning when Containerd tries to load the image and then unmount the temporary directory.</p>\n<h2>Solution</h2>\n<p>You must exclude the following directories on the first control plane node from the on access scan during the upgrade. You can remove these exclusions afterward, although you may have to reinstate them when you next upgrade OMT.</p>\n<ul>\n<li><code>&lt;RUNTIME_CDFDATA_HOME&gt;</code>. The Kubernetes infrastructure runtime data directory. The default directory is <code>opt/cdf/data</code>. </li>\n<li>The temporary installation directory. By default, this is <code>/tmp</code>, unless you defined a different value during installation.</li>\n<li><code>/var/opt/cdf/offline/</code>. This is the default directory to which OMT downloads images.</li>\n</ul>\n<p>To exclude the directories, follow these steps:</p>\n<ol>\n<li>Run the following command on the first control plane node:\n\t<pre><code>cd /opt/McAfee/ens/tp/bin</code></pre>\n</li>\n<li>Run the following commands to add the exclusions:\n\t<pre><code>./mfetpcli --setoasprofileconfig --profile standard --addexclusionrw --excludepaths &lt;directories&gt; --excludesubfolder\n./mfetpcli --setoasprofileconfig --profile lowrisk --addexclusionrw --excludepaths &lt;directories&gt; --excludesubfolder\n./mfetpcli --setoasprofileconfig --profile highrisk --addexclusionrw --excludepaths &lt;directories&gt; --excludesubfolder</code></pre>\n<p> <br/>\n</p>\n\tIn these commands, <code>&lt;directories&gt;</code> is a placeholder for the paths to the three directories. Separate each path with a comma. The path to each directory must end with a \"/\" character. For example, the value of <code>&lt;directories&gt;</code> might be: <code>/opt/cdf/data/,/tmp/,/var/opt/cdf/offline/</code>.</li>\n<li>Run the following commands to check that the directories are successfully excluded:\n\t<pre><code>./mfetpcli --getoasconfig --exclusionlist --profile standard | grep &lt;directories&gt;\n./mfetpcli --getoasconfig --exclusionlist --profile lowrisk | grep &lt;directories&gt;\n./mfetpcli --getoasconfig --exclusionlist --profile highrisk | grep &lt;directories&gt;</code></pre>\n</li>\n<li>Run the following command to restart <code>mfetpd</code>:\n\t<pre><code>systemctl restart mfetpd</code></pre>\n</li>\n<li>Resume the upgrade.</li>\n</ol>\n<p><br/>\n</p>\n<p class=\"mw-empty-elt\"></p><span class=\"snippet-end\" data-sname=\"423-25.4-423-25.3-ImagePullFailsUpgrade||N\"></span></div>",
  "modifiedon": "2025-10-24 08:51:12"
}