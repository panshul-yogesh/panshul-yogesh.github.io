{
  "title": "Jobs don't run after an OMT upgrade",
  "content": "<div class=\"mw-parser-output\"><span class=\"snippet-start\" data-sname=\"423-25.4-423-25.3-JobsNotUpdatedUpgrade||N\"></span><p class=\"mw-empty-elt\">\n</p><p>Jobs no longer run after you successfully upgrade OMT.</p>\n<h2 class=\"mw-headline\" id=\"Cause\">Cause</h2>\n<p>This issue occurs because images used as Init Containers or containers aren't updated to the new version in the jobs, even though the images are updated in the deployment.<br/>\n<br/>\nTo confirm that you are experiencing this issue, follow these steps:</p>\n<ol>\n<li>Run the following command to identify the suite namespace. Replace <code>&lt;suite_name&gt;</code> with the name of the ITOM product that's deployed on top of OMT.<br/>\n<br/>\n<code>kubectl get ns|grep &lt;suite_name&gt;</code></li>\n<li>Run the following command to confirm whether an image was updated in the jobs. Replace <code>&lt;suite_namespace&gt;</code> with the value returned by the previous command. Replace <code>&lt;old_image_version&gt;</code> with the path to the image that you want to check. This value must be the full path to the image, including the registry URL and the organization name. For example, <code>localhost:5000/hpeswitom/itom-suite-content:1.12.0.46</code><br/>\n<br/>\n<code>kubectl get job -n &lt;suite_namespace&gt; -o json| jq '.items[]| select(.spec.template.spec.containers[].image==\"&lt;old_image_version&gt;\" or .spec.template.spec.initContainers[].image==\"&lt;old_image_version&gt;\")| .metadata.name' -r</code><br/>\n<br/>\n\tIf the command returns a value, the image wasn't updated in the jobs.</li>\n</ol>\n<h2 class=\"mw-headline\" id=\"Solution\">Solution</h2>\n<h3 class=\"mw-headline\" id=\"Step_1:_Identify_the_old_image_version_and_new_image_version\">Step 1: Identify the old image version and new image version</h3>\n<ol>\n<li>Run the following commands to enter the cdfapiserver-db pod in the $CDF_NAMESPACE namespace:<br/>\n<br/>\n<code>suitedb_name=$(kubectl get pods -n $CDF_NAMESPACE |grep cdfapiserver-postgresql|awk '{print $1}')</code><br/>\n<code>kubectl exec -it $suitedb_name -n $CDF_NAMESPACE bash</code></li>\n<li>Run the following command to identify the cdfapiserver-db database password:<br/>\n<br/>\n<code>get_secret ITOM_DB_API_PASSWD_KEY</code></li>\n<li>Run the following command to connect to the cdfapiserver-db database. When prompted, enter the password that you identified in the previous step.<br/>\n<br/>\n<code>psql -h127.0.0.1 -Ucdfapiserver -dcdfapiserverdb</code></li>\n<li>Run the following command to identify the old image version and the new image version:<br/>\n<br/>\n<code>select sui.controller_name job_name,sui.from_imagename||sui.from_imagetags old_image_version,sui.from_imagename||sui.to_imagetags new_image_version from deployment d,suite_upgrades su,suite_upgrade_images sui where d.deployment_status = 'INSTALL_FINISHED' and d.deployment_type='PRIMARY' and d.id=su.deployment_id and d.suite_version=su.upgrades_version and su.id =sui.transaction_id and sui.controller_type like '<b>job%</b>' and su.upgrades_order in (select max(su.upgrades_order) from deployment d,suite_upgrades su where d.deployment_status = 'INSTALL_FINISHED' and d.deployment_type='PRIMARY' and d.id=su.deployment_id and d.suite_version=su.upgrades_version);</code></li>\n</ol>\n<h3 id=\"Step_2:_Update_the_job's_JSON_file\"><span class=\"mw-headline\" id=\"Step_2:_Update_the_job.27s_JSON_file\">Step 2: Update the job's JSON file</span></h3>\n<ol>\n<li>Run the following command to identify the suite namespace. Replace <code>&lt;suite_name&gt;</code> with the application name that's deployed on top of OMT.<br/>\n<br/>\n<code>kubectl get ns|grep &lt;suite_name&gt;</code></li>\n<li>Run the following command to identify the affected job name. Replace <code>&lt;suite_namespace&gt;</code> with the value returned by the previous command. Replace <code>&lt;old_image_version&gt;</code> with the path to the image that wasn't updated. This value must be the full path to the image, including the registry URL and the organization name. For example, <code>localhost:5000/hpeswitom/itom-suite-content:1.12.0.46</code><br/>\n<br/>\n<code>kubectl get job -n &lt;suite_namespace&gt; -o json| jq '.items[]| select(.spec.template.spec.containers[].image==\"&lt;old_image_version&gt;\" or .spec.template.spec.initContainers[].image==\"&lt;old_image_version&gt;\")| .metadata.name' -r</code></li>\n<li>Run the following command to start editing the job's JSON file. Replace <code>&lt;suite_namespace&gt;</code> with the value that you identified earlier. Replace <code>&lt;job_name&gt;</code> with the value that you identified in the previous step.<br/>\n<br/>\n<code>kubectl edit job -n &lt;suite_namespace&gt; &lt;job_name&gt;</code></li>\n<li>Locate the <code>image</code> node in the file, and update the image version to the correct one.</li>\n<li>Run the following commands to identify the job's YAML file. Replace <code>&lt;suite_namespace&gt;</code> and <code>&lt;job_name&gt;</code> with the values that you identified earlier.\n\t<pre>kubectl get job -n &lt;suite_namespace&gt; &lt;job_name&gt; &gt;&lt;job_name&gt;.yaml\n</pre>\n</li>\n<li>Run the following command to start editing the job's YAML file. Replace <code>&lt;job_name&gt;</code> with the value that you identified earlier.<br/>\n<br/>\n<code>vi &lt;job_name&gt;.yaml</code></li>\n<li>Locate the <code>controller-uid</code> node in the file, and then delete it.</li>\n<li>Run the following commands to apply the job's YAML file. Replace <code>&lt;job_name&gt;</code> with the value that you identified earlier.\n\t<pre>kubectl delete -f &lt;job_name&gt;.yaml \nkubectl create -f &lt;job_name&gt;.yaml\n</pre>\n</li>\n</ol>\n<p><br/>\n</p>\n<p class=\"mw-empty-elt\"></p><span class=\"snippet-end\" data-sname=\"423-25.4-423-25.3-JobsNotUpdatedUpgrade||N\"></span></div>",
  "modifiedon": "2025-10-24 08:51:12"
}