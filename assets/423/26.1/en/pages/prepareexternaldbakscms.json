{
  "title": "Prepare external databases for UD/UCMDB (AKS)",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\"></p><div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>UD/UCMDB contains an internal (embedded) PostgreSQL database instance, which should be used for demonstration purposes only. You must use external databases in a production environment. In addition, you must use separate PostgreSQL databases instances for Service Management and the containerized UD/UCMDB.</p>\n<p>For the UD/UCMDB deployed on Azure, you need to set up an Azure flexible server as the database engine. This flexible server instance will be used as the external databases for the following UD/UCMDB components:</p>\n<ul type=\"disc\">\n<li>UCMDB Server</li>\n<li>AutoPass License Service (APLS)</li>\n</ul>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-important-icon\"></div>\n<div class=\"admonition-content admonition-important-content\">This release no longer supports the method of installing PostgreSQL on a virtual machine on Azure. You must <a href=\"/doc/423/26.1/migrateselfhostedpg2azureserver\" title=\"Migrate from self-hosted PostgreSQL to Azure Flexible Server\">Migrate from self-hosted PostgreSQL to Azure Flexible Server</a>. </div>\n</div>\n<h2>Set up an Azure flexible server</h2>\n<p>To set up an Azure flexible server, follow these steps.</p>\n<ol>\n<li>Go to the Azure portal (<a href=\"https://portal.azure.com\" title=\"https://portal.azure.com\">https://portal.azure.com</a>).</li>\n<li>Search for \"Azure Database for PostgreSQL flexible servers\" and open it.</li>\n<li>Click <strong>Create</strong>.</li>\n<li>On the creation page, enter the following information.\n\t<ul>\n<li><strong>Project details</strong>\n<ul>\n<li><strong>Subscriptions</strong>: Enter your subscription ID. You can get it from the <strong>Azure portal Home page</strong> &gt; <strong>Subscriptions</strong>.</li>\n<li><strong>Resource group</strong>: Enter the name of the resource group created in the prerequisite tasks. For example, myResourceGroup.</li>\n</ul>\n</li>\n<li><strong>Server details</strong>\n<ul>\n<li><strong>Server name</strong>: Enter a name for the flexible server. For example: <strong>cmspghost</strong>.</li>\n<li><strong>Region</strong>: Choose a region. Ideally, your database should be in the same region as your production environment.</li>\n<li><strong>Workload type:</strong> Select a workload type according to your needs.</li>\n<li><strong>Compute + storage</strong>: Click <strong>Configure server</strong>, then choose the compute size according to the <a href=\"/doc/423/26.1/akssizing#Additional_hardware_requirements_for_CMS\" title=\"Sizing considerations for Azure deployment\">Sizing considerations for Azure deployment</a>. Click <strong>Save</strong>.</li>\n<li><strong>Availability Zone</strong>: No preference.</li>\n</ul>\n</li>\n<li><strong>High availability</strong>  \n\t\t<ul>\n<li>Configure the <b>High availability</b> setting as needed.</li>\n</ul>\n</li>\n<li><strong>PostgreSQL Version</strong>: Choose the PostgreSQL version. For details about supported PostgreSQL versions, see <a href=\"/doc/423/26.1/akssupportmatrix#CMS\" title=\"Support matrix for Azure deployment\">Support matrix for Azure deployment</a>.</li>\n<li><strong>Administrator account</strong>\n<ul>\n<li><strong>Admin username</strong>: Name your database administrator. </li>\n<li><strong>Password</strong>: Set the password for the admin.</li>\n<li><strong>Confirm password</strong>: Confirm the password.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Click <strong>Next: Networking</strong>. Enter the following information.\n\t<ul>\n<li><strong>Connectivity method</strong>: Select <strong>Private access(Vnet Integration) </strong>&gt;<strong> Virtual network</strong>.</li>\n<li><strong>Subscription: </strong>Enter your subscription ID. You can get it from the <strong>Azure portal Home page</strong> &gt; <strong>Subscriptions</strong>.</li>\n<li><strong>Virtual network:</strong> Select the Vnet you created for the UD/UCMDB production environment.</li>\n<li><strong>Subnet:</strong> Select a subnet different from the one you prepared for UD/UCMDB. Or, enter a nonexistent subnet name and let the system create it. Please be aware that this subnet must be independent and can't be shared with other objects.</li>\n</ul>\n</li>\n<li>Click <strong>Review + create</strong>.</li>\n<li>Download the root CA. To do this, follow the instructions on the Azure portal.<br/>\n\tYou will need to select the <b>Use SSL connection</b> option and add this certificate to the <strong>caCertificates </strong>section when you <a href=\"/doc/423/26.1/createvaluesyamlakscms\" title=\"Create my-values.yaml (AKS)\">Create my-values.yaml (AKS)</a> during the UD/UCMDB installation.  </li>\n<li>Check and validate if the database is ready. You can either:\n\t<ul>\n<li>After installing the PostgreSQL client on the bastion, run the following command to check the database:\n\t\t<pre>psql \"host=&lt;fqdn of flexible server&gt; port=5432 dbname=postgres user=&lt;postgres_admin&gt; password=&lt;password for admin&gt; sslmode=verify-full sslrootcert=&lt;full path of the root CA certificate&gt;\"</pre>\n</li>\n<li>Or use pgAdmin and use the bastion as the SSH Tunnel. With pgAdmin4 version 6.5+, you can do this by configuring the SSH Tunnel.</li>\n</ul>\n<b>Note:</b> If you want to use a plain connection instead of TLS to the flexible server, you can go to Server parameters and use require_secure_transport to turn off the SSL force.</li>\n</ol>\n<h2>Set up PostgreSQL databases for UD/UCMDB</h2>\n<p>In a production environment, you must use external databases for UD/UCMDB. The database user and database name information are required when you install UD/UCMDB, and the database schema information is required for UCMDB Server, but optional for AutoPass. The default schema name will be used if there is no new schema name assigned.<br/>\nThe databases must be empty so that UD/UCMDB will initialize them during installation. The table below shows example database information prepared for the four components.</p>\n<table border=\"1\" cellpadding=\"1\" cellspacing=\"1\">\n<thead>\n<tr>\n<th scope=\"col\">Service</th>\n<th scope=\"col\">DB User</th>\n<th scope=\"col\">DB Name</th>\n<th scope=\"col\">Schema (default)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>UCMDB Server</td>\n<td>ucmdb</td>\n<td>ucmdb_db</td>\n<td>ucmdb</td>\n</tr>\n<tr>\n<td>APLS</td>\n<td>ucmdb_autopass</td>\n<td>ucmdb_autopass_db</td>\n<td>public</td>\n</tr>\n</tbody>\n</table>\n<p><br/>\nBelow are sample SQL commands for creating a user and a database for a service:</p>\n<ol>\n<li>\n<p>Log in to the bastion node and then run the following command to connect to the PostgreSQL instance. Replace value placeholders such as &lt;postgres admin&gt; with the actual value.</p>\n<pre>psql \"host=&lt;fqdn of flexible server&gt; port=5432 dbname=postgres user=&lt;postgres admin&gt; password=&lt;password for admin&gt; sslmode=verify-full sslrootcert=&lt;full path of the root CA certificate&gt;\"\n</pre>\n</li>\n<li>\n<p>Run the following commands to create the databases and the users used by UCMDB Server and AutoPass:</p>\n<pre>CREATE USER &lt;USERNAME&gt; PASSWORD '&lt;PASSWORD&gt;';\n\ngrant &lt;USERNAME&gt; to &lt;PostgresSQL admin&gt;;\n\nCREATE DATABASE &lt;DBNAME&gt; OWNER &lt;USERNAME&gt;;   </pre>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-note-icon\"></div>\n<div class=\"admonition-content admonition-note-content\"><code>&lt;PASSWORD&gt;</code> for database user should follow the following complexity defined by the Vault secret utility:\n\n\t<ul>\n<li>At least 8 characters long</li>\n<li>Alphanumeric characters</li>\n<li>At least one lower case letter</li>\n<li>At least one upper case letter</li>\n<li>At least one digit</li>\n</ul>\n</div>\n</div>\n<p>For example:</p>\n<b># For UCMDB </b>\n<pre>CREATE USER ucmdb PASSWORD '&lt;PASSWORD&gt;';\n\ngrant ucmdb to &lt;PostgresSQL admin&gt;;\n\nCREATE DATABASE ucmdb_db OWNER ucmdb; </pre>\n<b># For APLS  </b>\n<pre>CREATE USER ucmdb_autopass PASSWORD '&lt;PASSWORD&gt;';\n\ngrant ucmdb_autopass to &lt;PostgresSQL admin&gt;;\n\nCREATE DATABASE ucmdb_autopass_db OWNER ucmdb_autopass; </pre>\n</li>\n<li>\n<p>Run the following commands to create the schemas used by UCMDB Server and AutoPass: </p>\n<pre>\\c &lt;DBNAME&gt;\n\nCREATE SCHEMA &lt;DBSCHEMA&gt; AUTHORIZATION &lt;USERNAME&gt;;\n\nALTER USER &lt;USERNAME&gt; SET search_path TO &lt;DBSCHEMA&gt;;</pre>\n<p>For example:</p>\n<b># For UCMDB</b> (Required):\n\n\t<pre>\\c &lt;ucmdb_db&gt;\n\nCREATE SCHEMA &lt;ucmdb_schema&gt; AUTHORIZATION &lt;ucmdb_user&gt;;\n\nALTER USER &lt;ucmdb_user&gt; SET search_path TO &lt;ucmdb_schema&gt;;</pre>\n<b># For APLS</b> (Optional) :\n\n\t<pre>\\c &lt;autopass_db&gt;\n\nCREATE SCHEMA &lt;autopass_schema&gt; AUTHORIZATION &lt;autopass_user&gt;;\n\nALTER USER &lt;autopass_user&gt; SET search_path TO &lt;autopass_schema&gt;;\n</pre>\n</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}