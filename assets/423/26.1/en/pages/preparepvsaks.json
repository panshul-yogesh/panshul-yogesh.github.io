{
  "title": "Prepare persistent volumes for ESM on Azure",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>To install the application in the Helm mode, you must create PVs. You can create PVs either using static volume provisioning or dynamic volume provisioning. To learn more about the two methods, see <a href=\"/doc/423/26.1/install#Dynamic_vs_static_volume_provisioning\" title=\"Dynamic vs. static volume provisioning\">Dynamic vs. static volume provisioning</a>. </p>\n<h2>Create the secret to access Azure Files share</h2>\n<p>You must create the secret under the ESM namespace to access the Azure Files share.</p>\n<p>Perform these steps only if you choose Azure Files and Azure Disk as the storage service:</p>\n<ol>\n<li>Log in to the bastion node.</li>\n<li>Check if a file named <code>/&lt;root&gt;/.kube/config</code> with cluster credentials exists. If the file does not exist, run the <code>sudo az login</code> command to log in to the Azure CLI and follow the instructions in the command output.</li>\n<li>Run the following command to get the required permission to run the Kubernetes commands.\n\t<pre>sudo az aks get-credentials --resource-group &lt;resource_group_name&gt; --name &lt;kubernetes_cluster_name&gt; --subscription &lt;subscription_name_or_id&gt;</pre>\n<p>The following table lists the parameters used in this command:</p>\n<table cellpadding=\"1\" cellspacing=\"1\" style=\"width: 500px;\">\n<caption>AZ aks parameters FOR get-credentials</caption>\n<thead>\n<tr>\n<th scope=\"col\">\n<p>Parameters</p>\n</th>\n<th scope=\"col\">Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&lt;resource_group_name&gt;</code></td>\n<td>The name of the resource group you created on the <a href=\"/doc/423/26.1/akscluster#Prerequisites\" title=\"Build AKS cluster\">Build AKS cluster</a> page. Do not use your cluster's resource group name with the format <code>MC_&lt;resource_group&gt;_&lt;aks_cluster_name&gt;_&lt;location&gt;</code>.</td>\n</tr>\n<tr>\n<td><code>&lt;kubernetes_cluster_name&gt;</code> </td>\n<td>The name of the created Kubernetes cluster.</td>\n</tr>\n<tr>\n<td><code>&lt;subscription_name_or_id&gt;</code> </td>\n<td>Your subscription name or ID. You can get it by navigating to the Azure portal <b>Home</b> page &gt; <b>Subscriptions</b>.</td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>Run the following command to generate the secret.\n\t<pre>kubectl create secret generic azure-secret --from-literal=azurestorageaccountname=&lt;storage_account_name&gt; --from-literal=azurestorageaccountkey=&lt;storage_account_key&gt; -n &lt;ESM_Namespace&gt;</pre>\n<p>The following table lists the parameters used in this command:</p>\n<table cellpadding=\"1\" cellspacing=\"1\" style=\"width: 500px;\">\n<caption>KUBCTL Parameters for azure-secret</caption>\n<thead>\n<tr>\n<th scope=\"col\">Parameters</th>\n<th scope=\"col\">Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&lt;storage_account_name&gt;</code> </td>\n<td>\n<p>The name of the created FileStorage account.</p>\n</td>\n</tr>\n<tr>\n<td><code>&lt;storage_account_key&gt;</code></td>\n<td>The key you got in the previous step.</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ol>\n<h2>Create PVs using static volume provisioning</h2>\n<p>To create PVs for the suite using static volume provisioning, run the <strong>createPV.sh </strong>script. The following examples show how to use the <strong>createPv.sh</strong> script:</p>\n<ul>\n<li>Example for Azure Files:\n\t<pre> ./createPV.sh -n itsma -p generic/var/vols/itom/itsma -u 1999 -g 1999 -a --size small\n</pre>\n</li>\n<li>Example for NetApp:\n\t<pre>./createPV.sh -n itsma -s 10.1.50.4  -p /generic/var/vols/itom/itsma  -sp /smarta/var/vols/itom/itsma --size small\n</pre>\n</li>\n</ul>\n<h2>Create PVs using dynamic volume provisioning</h2>\n<p>To create PVs for the suite using dynamic provisioning, you must add the StorageClass name defined in your PVC to your <strong>my-values.yaml</strong> file (for CLI installation) or specify using the YAML Editor (for AppHub installation). A StorageClass defines how persistent volumes belonging to the class will be provisioned dynamically. PVC uses this StorageClass to create PVs required for the suite. Create the StorageClass in one of the following ways based on your deployment: </p>\n<h4>Azure Disks</h4>\n<div>\n<div>Perform these steps only if you choose the option <strong>Prepare File Storage - Subscribe premium Azure Files and Azure Disks(Helm)</strong>:</div>\n</div>\n<table>\n<tbody>\n<tr>\n<th>Role</th>\n<th>Location</th>\n</tr>\n<tr>\n<td>Storage administrator</td>\n<td>Bastion node</td>\n</tr>\n</tbody>\n</table>\n<p>Complete the following steps to use Azure Disks to store the search engine and RabbitMQ data.</p>\n<ol>\n<li>Copy the contents of the script below and save it as <strong>azuredisk-premium-sc.yaml</strong>:\n\n\t<pre>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: &lt;azuredisk_storageclass&gt;\nparameters:\n  cachingmode: ReadOnly\n  kind: Managed\n  storageaccounttype: Premium_LRS\nallowVolumeExpansion: true\nprovisioner: disk.csi.azure.com\nreclaimPolicy: Retain\nvolumeBindingMode: Immediate</pre>\n<p>Where <code>&lt;azuredisk_storageclass&gt;</code> is the StorageClass name you want to define. For example: <strong>esm-azuredisk-premium</strong>.</p>\n<p>Use the value for <code>&lt;azuredisk_storageclass&gt;</code>  as the StorageClass name in your <strong>my-values.yaml</strong> file. For example:</p>\n<pre tabindex=\"0\"><code data-lang=\"fallback\">persistence:\n    # When pvcCreate is set to true, the composition chart is expected to create PVCs(data-volume,config-volume and logging-volume) automatically.\n    # When pvcCreate is set to false, existing PVCs are utilized.\n    pvcCreate: true\n    # Used to inject storageClasses into PVC creation.\n    # Users can change any or all of these to match the actual storage classes used in their environment.\n    storageClasses:\n      default-rwx: itom-standard\n      default-rwo: &lt;azuredisk_storageclass&gt;</code></pre>\n</li>\n<li>\n<p>Run the following command on the bastion node to create a StorageClass for the Azure Disks:</p>\n<pre>kubectl create -f azuredisk-premium-sc.yaml</pre>\n</li>\n</ol>\n<h4 class=\"mw-headline\">Azure Files</h4>\n<p>To use Azure Files to store the generic data (data, log files, config files), you need to create a StorageClass.</p>\n<p>Perform these steps only if you choose dynamic provisioning for both Azure Files and Azure Disk:</p>\n<ol>\n<li>Copy the contents of the script below and save it as <strong>azurefile-premium-sc.yaml</strong> file.\n\n\t<pre tabindex=\"0\">apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: &lt;azurefile_storageclass&gt;\nmountOptions:\n- mfsymlinks\n- dir_mode=0775\n- uid=&lt;system_user_id&gt;\n- gid=&lt;system_group_id&gt;\n- nobrl\nparameters:\n  skuName: Premium_LRS\n  resourceGroup: &lt;resource_group_name&gt;\n  storageAccount: &lt;storage_account_name&gt;\n  shareNamePrefix: esm\n  secretName: azure-secret\n  secretNamespace: &lt;ESM_Namespace&gt;\n  csi.storage.k8s.io/provisioner-secret-name: azure-secret\n  csi.storage.k8s.io/provisioner-secret-namespace: &lt;ESM_Namespace&gt;\nprovisioner: file.csi.azure.com\nreclaimPolicy: Retain\nvolumeBindingMode: Immediate\nallowVolumeExpansion: true</pre>\n<p>The following table lists the parameters in the YAML file:</p>\n<table cellpadding=\"1\" cellspacing=\"1\" style=\"width: 500px;\">\n<caption>parameters for azurefile-premium-sc.yaml</caption>\n<thead>\n<tr>\n<th scope=\"col\">Parameters</th>\n<th scope=\"col\">Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>&lt;azurefile_storageclass&gt;</code></td>\n<td>The name of StorageClass you want to define. For example, <b>esm-azurefile-premium</b>.</td>\n</tr>\n<tr>\n<td><code>&lt;system_user_id&gt;</code></td>\n<td>Operating system user ID that is used to run the process in the container. The user ID value must be 1999 or a number between 100000 and 2000000000.</td>\n</tr>\n<tr>\n<td><code>&lt;system_group_id&gt;</code></td>\n<td>Operating system group ID that is used to run the process in the container. The values must be 1999 or a number between 100000 and 2000000000.</td>\n</tr>\n<tr>\n<td><code>&lt;resource_group_name&gt;</code></td>\n<td>The name of the resource group you created on the Build AKS cluster page.</td>\n</tr>\n<tr>\n<td><code>&lt;ESM_Namespace&gt;</code></td>\n<td>The release name that you prepared for the suite deployment.</td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>Run the following command on the bastion node to create a StorageClass for Azure Files. Use the  <strong>azurefile-premium-sc.yaml</strong> file you created in Step 1.\n\t<pre>kubectl create -f azurefile-premium-sc.yaml</pre>\n<p>Use the value for <code>&lt;azuredisk_storageclass&gt;</code>  as the StorageClass name in your <strong>my-values.yaml</strong> file. For example:</p>\n<pre>persistence:\n    # When pvcCreate is set to true, the composition chart is expected to create PVCs(data-volume,config-volume and logging-volume) automatically.\n    # When pvcCreate is set to false, existing PVCs are utilized.\n    pvcCreate: true\n    # Used to inject storageClasses into PVC creation.\n    # Users can change any or all of these to match the actual storage classes used in their environment.\n    storageClasses:\n      default-rwx: &lt;azurefile_storageclass&gt;\n      default-rwo: &lt;azuredisk_storageclass&gt;</pre>\n<p>Where <code>&lt;azuredisk_storageclass&gt;</code> is the StorageClass name you mentioned for Azure Disk in Step 1.</p>\n</li>\n</ol>\n<h4>Azure NetApp Files</h4>\n<div>\n<p>Perform these step only if you choose dynamic provisioning for Azure NetApp Files:</p>\n</div>\n<p>See the <a href=\"http://learn.microsoft.com/en-us/azure/aks/azure-netapp-files-nfs#dynamically-configure-for-applications-that-use-nfs-volumes\" title=\"Azure documentation \">Azure documentation</a> for how to create a storage class for Azure NetApp files. You must update configurations as required when you create your storage class.</p>\n<p>Complete the following steps to create the storage class:</p>\n<ol>\n<li>Install Astra Trident. See <a href=\"https://learn.microsoft.com/en-us/azure/aks/azure-netapp-files-nfs#install-astra-trident\" title=\"Install Astra Trident\">Install Astra Trident</a>.</li>\n<li>Create a backend. See <a href=\"https://learn.microsoft.com/en-us/azure/aks/azure-netapp-files-nfs#create-a-backend\" title=\"Create a backend\">Create a backend</a>. When creating the <strong>backend-anf.yaml</strong> file, replace the file content with the following:\n\t<pre>apiVersion: trident.netapp.io/v1\nkind: TridentBackendConfig\nmetadata:\n  name: backend-tbc-anf\nspec:\n  version: 1\n  storageDriverName: azure-netapp-files\n  subscriptionID: 6f33f7c2-xxxx-4cde-xxxx-e406xxxx09\n  tenantID: &lt;tenantID&gt;\n  location: &lt;region&gt;\n  capacityPools:\n  - &lt;resource-group-name&gt;/&lt;account-name&gt;/&lt;pool-name&gt;\n  serviceLevel: Premium\n  credentials:\n    name: backend-tbc-anf-secret\n</pre>\n</li>\n<li>Create a storage class. See <a href=\"https://learn.microsoft.com/en-us/azure/aks/azure-netapp-files-nfs#create-a-storage-class\" title=\"Create a storage class\">Create a storage class</a>. When creating the <strong>anf-storageclass.yaml</strong> file, replace the file content with the following:\n\t<pre>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: azure-netapp-files\nprovisioner: csi.trident.netapp.io\nparameters:\n  backendType: \"azure-netapp-files\"\n  fsType: \"nfs\"\nreclaimPolicy: Retain\nallowVolumeExpansion: true\n</pre>\n<p>The default value for <code>reclaimPolicy</code> is <strong>Delete</strong>, it is recommended to use <strong>Retain</strong> to avoid data loss. You must update the StorageClass name in the <strong>my-values.yaml</strong> file to <code>&lt;netapp_storageclass&gt;.</code></p>\n</li>\n<li>\n<p>Update the value of the <code>global.persistence.storageclass.default-rwo</code> and <code>global.persistence.storageclass.default-rwx</code> parameters in the <strong>my-values.yaml</strong> file as below:</p>\n<pre>persistence:\n    # When pvcCreate is set to true, the composition chart is expected to create PVCs (data-volume, config-volume, and logging-volume) automatically.\n    # When pvcCreate is set to false, existing PVCs are utilized.\n    pvcCreate: true\n    # Used to inject storageClass into PVC creation.\n    # You can change any or all of these to match the actual storage classes used in their environment.\n    storageClasses:\n      default-rwx: &lt;netapp_storageclass&gt;\n      default-rwo: &lt;netapp_storageclass&gt;</pre>\n</li>\n</ol>\n<h2>External references</h2>\n<ul>\n<li>For Azure Files information, see <a class=\"external text\" href=\"https://docs.microsoft.com/en-us/azure/storage/files/\" rel=\"nofollow\" target=\"1\" title=\"Azure Files\">Azure Files</a>.</li>\n<li>For the pricing information about premium/standard Azure Files storage, see <a class=\"external text\" href=\"https://azure.microsoft.com/en-us/pricing/details/storage/files/\" rel=\"nofollow\" target=\"1\" title=\"Storage pricing\">Storage pricing</a>.</li>\n<li>For storage account information, see <a class=\"external text\" href=\"https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview?toc=%2Fazure%2Fstorage%2Ffiles%2Ftoc.json\" rel=\"nofollow\" target=\"1\" title=\"Storage account\">Storage account</a>.</li>\n<li>For Azure Disks information, see <a href=\"https://docs.microsoft.com/en-us/azure/virtual-machines/managed-disks-overview\" title=\"Azure Disks\">Azure Disks</a>.</li>\n<li>For Storage Class information, see <a href=\"https://kubernetes.io/docs/concepts/storage/storage-classes/\" title=\"Storage Classes\">Storage Classes</a>.</li>\n</ul>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}