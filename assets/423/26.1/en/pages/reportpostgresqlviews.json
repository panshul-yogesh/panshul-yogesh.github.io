{
  "title": "Generate report based on PostgreSQL views",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>Service Management built-in reports and dashboards provide a quick and useful way to define many simple operational and analytic reports. Meanwhile, complex reporting and KPI needs such as queries involving many-to-many relations can be better addressed with BI Tools crafted specifically for this purpose.</p>\n<div class=\"admonition\">\n<div class=\"admonition-icon admonition-important-icon\"></div>\n<div class=\"admonition-content admonition-important-content\">Service Management only supports direct access to the database for the PostgreSQL views. Unless directed by the Support as part of a case investigation or resolution, any other database access is not supported.</div>\n</div>\n<h2 class=\"mw-headline\" id=\"PostgreSQL_view_generation\">PostgreSQL view generation</h2>\n<p>PostgreSQL views are generated during the platform start-up. By connecting a third-party tool such as Microsoft Power BI and Tableau directly to your Service Management data, PostgreSQL views can be utilized by a Service Management database user to generate database reports.</p>\n<p><b>Note:</b> You don't need to generate or refresh views to get the latest data updates. However, if the data model changes, for example, a new custom field is added, the views need to be refreshed manually by clicking the Refresh button in the Application Settings menu, as shown below.</p>\n<div><a class=\"image\" href=\"/file/images/6/6a/2018.08_Helpcenter/Resources/Images/PGView/database_reporting.png\" title=\"/file/images/6/6a/2018.08_Helpcenter/Resources/Images/PGView/database_reporting.png\"> <img alt=\"database reporting.png\" class=\"z_migration_tba_PDF\" data-file-height=\"185\" data-file-width=\"979\" height=\"185\" src=\"../../../images/database_reporting_7d3ce09e.png\" width=\"979\"/> </a></div>\n<h2 class=\"mw-headline\" id=\"PostgreSQL_reporting_with_a_mirrored_data_store\">PostgreSQL reporting with a mirrored data store</h2>\n<p>It's recommended to set up a replicated reporting store to properly support complex reporting in production environments. There are many public resources with information about PostgreSQL replication. <a class=\"external text\" href=\"https://wiki.postgresql.org/wiki/Replication,_Clustering,_and_Connection_Pooling\" rel=\"nofollow\" target=\"1\" title=\"Replication, Clustering, and Connection Pooling\">Replication, Clustering, and Connection Pooling</a> is a good overview of resources and projects providing PG replication options.</p>\n<p>At the moment, pgpool II is our primary validated solution. The solution is recommended as:</p>\n<ul>\n<li>PG stream replication in the production is for both high availability and load balance.</li>\n<li>PG pool is used in production for load balance and read/write splitting.</li>\n<li>PG pool or <a class=\"external text\" href=\"https://repmgr.org/\" rel=\"nofollow\" target=\"1\" title=\"repmgr\">repmgr</a> is used for automatic failover.</li>\n</ul>\n<p>For reference, see <a class=\"external free\" href=\"http://jensd.be/591/linux/setup-a-redundant-postgresql-database-with-repmgr-and-pgpool\" rel=\"nofollow\" target=\"1\" title=\"http://jensd.be/591/linux/setup-a-redundant-postgresql-database-with-repmgr-and-pgpool\">http://jensd.be/591/linux/setup-a-redundant-postgresql-database-with-repmgr-and-pgpool</a>.</p>\n<h2 class=\"mw-headline\" id=\"Views_and_SMAX_tenants\">Views and Service Management tenants</h2>\n<p>A separate set of views is generated for each tenant in a Service Management deployment instance. Each set contains views representing all relevant record types in the Service Management data model. The naming convention of each view indicates to which tenant it belongs. You can find the views for any given tenants by filtering with a prefix \"view_[TenantID]\", then select several views as needed to create reports. More views can be added at any point.</p>\n<p>In addition, if you have production, development, and staging tenants, there will be views for each.</p>\n<div><a class=\"image\" href=\"/file/images/4/4d/2018.08_Helpcenter/Resources/Images/PGView/views_and_tenants.png\" title=\"/file/images/4/4d/2018.08_Helpcenter/Resources/Images/PGView/views_and_tenants.png\"> <img alt=\"views and tenants.png\" class=\"z_migration_tba_PDF\" data-file-height=\"1744\" data-file-width=\"2736\" height=\"1744\" src=\"../../../images/views_and_tenants_1bb17e68.png\" width=\"2736\"/> </a></div>\n<h2 class=\"mw-headline\" id=\"PostgreSQL_view_and_SMAX_data_model\">PostgreSQL view and Service Management data model</h2>\n<div><a class=\"image\" href=\"/file/images/a/a2/2018.08_Helpcenter/Resources/Images/PGView/pgview_and_smax_data_model.png\" title=\"/file/images/a/a2/2018.08_Helpcenter/Resources/Images/PGView/pgview_and_smax_data_model.png\"> <img alt=\"pgview and smax data model.png\" class=\"z_migration_tba_PDF\" data-file-height=\"594\" data-file-width=\"1430\" height=\"594\" src=\"../../../images/pgview_and_smax_data_model_c30d5569.png\" width=\"1430\"/> </a></div>\n<p>As shown in the figure above, each record type has a corresponding view of the same name. The Studio definition in Service Management is used as a reference for fields in the record model. Note that ENTITY_LINK fields point to related tables (one-to-many relationships).</p>\n<p>The following figure demonstrates many-to-many associations. A specific many-to-many association table view is generated for each many-to-many association listed in an Service Management record model. You can use these association views to generate queries that join records from both tables.</p>\n<div><a class=\"image\" href=\"/file/images/9/91/2018.08_Helpcenter/Resources/Images/PGView/m2m_associations.png\" title=\"/file/images/9/91/2018.08_Helpcenter/Resources/Images/PGView/m2m_associations.png\"> <img alt=\"m2m associations.png\" class=\"z_migration_tba_PDF\" data-file-height=\"1531\" data-file-width=\"2272\" height=\"1531\" src=\"../../../images/m2m_associations_11d359ac.png\" width=\"2272\"/> </a></div>\n<h2 class=\"mw-headline\" id=\"Example:_Generating_reports_with_Microsoft_Power_BI\">Example: Generating reports with Microsoft Power BI</h2>\n<p>This section provides an example tutorial for creating reports using Microsoft Power BI. You will need a Power BI license or a trial version to apply the steps in this section.</p>\n<p><b>Note:</b> This type of report can also be created using other BI tools, which may also suit your business needs.</p>\n<p>To generate the report based on the PostgreSQL view using Microsoft Power BI, follow these steps.</p>\n<ol>\n<li>\n<p>Download and install Power BI Desktop from Microsoft website.</p>\n</li>\n<li>\n<p>Install <a class=\"external text\" href=\"https://github.com/npgsql/Npgsql/releases\" rel=\"nofollow\" target=\"1\" title=\"Npgsql-3.2.7\">Npgsql-3.2.7</a> on the local computer.</p>\n</li>\n<li>\n<p>Enable a certificate for Power BI to communicate with PostgreSQL through an SSL connection.</p>\n<ol>\n<li>\n<p>Download the certificate stores <a class=\"external free\" href=\"https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem\" rel=\"nofollow\" target=\"1\" title=\"https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem\">https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem</a>.</p>\n</li>\n<li>\n<p>Convert pem to crt:</p>\n<pre>openssl x509 -outform der -in rds-combined-ca-bundle.pem -out rds-combined-ca-bundle.crt</pre>\n</li>\n<li>\n<p>Import the certificates into the Windows certificate store. You can use <a class=\"external text\" href=\"http://www.cs.virginia.edu/~gsw2c/GridToolsDir/Documentation/ImportTrustedCertificates.htm\" rel=\"nofollow\" target=\"1\" title=\"this link\">this link</a> as a reference.</p>\n</li>\n</ol>\n</li>\n<li>\n<p>Get data from the PostgreSQL view.</p>\n<ul>\n<li>\n<p>Click <b>Get Data</b> under the <b>Home</b> tab.</p>\n</li>\n<li>\n<p>Select data source type <b>PostgreSql</b>.</p>\n</li>\n<li>\n<p>Connect to the database as demonstrated in the following example.</p>\n<div><a class=\"image\" href=\"/file/images/c/ca/2018.08_Helpcenter/Resources/Images/PGView/pgview_db_connection_1.png\" title=\"/file/images/c/ca/2018.08_Helpcenter/Resources/Images/PGView/pgview_db_connection_1.png\"> <img alt=\"pgview db connection 1.png\" class=\"z_migration_tba_PDF\" data-file-height=\"333\" data-file-width=\"877\" height=\"333\" src=\"../../../images/pgview_db_connection_1_d281e2d1.png\" width=\"877\"/> </a></div>\n<p>Contact your administrator to obtain the database server host from the <b>config</b> value of <b>xruntime_db_host</b> in <b>configmap database-configmap</b>. Database name is <b>xservices_ems</b>.</p>\n<div><a class=\"image\" href=\"/file/images/1/12/2018.08_Helpcenter/Resources/Images/PGView/pgview_db_connection_2.png\" title=\"/file/images/1/12/2018.08_Helpcenter/Resources/Images/PGView/pgview_db_connection_2.png\"> <img alt=\"pgview db connection 2.png\" class=\"z_migration_tba_PDF\" data-file-height=\"424\" data-file-width=\"875\" height=\"424\" src=\"../../../images/pgview_db_connection_2_ce872333.png\" width=\"875\"/> </a></div>\n<p>If the connection is successful, all views will be listed. Choose the view you want to use. Take <b>Incident by change</b> as an example, there are three related views, <b>incidents</b>, <b>incidentscausedbychange</b>, and <b>change</b>. The following steps will create a sample report showing \"all incidents resulting from a faulty Change\".</p>\n</li>\n</ul>\n</li>\n<li>\n<p>Edit query (take <b>Incident by change</b> as an example).</p>\n<ul>\n<li>\n<p>Click <b>Edit queries</b>, you will see the following three queries listed in the left panel.</p>\n<div><a class=\"image\" href=\"/file/images/f/fb/2018.08_Helpcenter/Resources/Images/PGView/edit_query_1.png\" title=\"/file/images/f/fb/2018.08_Helpcenter/Resources/Images/PGView/edit_query_1.png\"> <img alt=\"edit query 1.png\" class=\"z_migration_tba_PDF\" data-file-height=\"92\" data-file-width=\"435\" height=\"92\" src=\"../../../images/edit_query_1_4da4dd3b.png\" width=\"435\"/> </a></div>\n</li>\n<li>\n<p>(Optional) Select the columns you want to use. You can click the query and click <b>Choose Columns</b> to filter the columns, this will simplify the actions. In this example, for <b>Incident</b>, choose <b>column id</b> and <b>displaylabel</b>. For <b>Change</b>, choose <b>column id</b> and <b>displayLabel</b>.</p>\n</li>\n<li>\n<p>In the left panel, click <b>Incident</b> as the source table, and then click <b>Merge Queries as New</b>.</p>\n<div><a class=\"image\" href=\"/file/images/1/1c/2018.08_Helpcenter/Resources/Images/PGView/edit_query_2.png\" title=\"/file/images/1/1c/2018.08_Helpcenter/Resources/Images/PGView/edit_query_2.png\"> <img alt=\"edit query 2.png\" class=\"z_migration_tba_PDF\" data-file-height=\"80\" data-file-width=\"210\" height=\"80\" src=\"../../../images/edit_query_2_957f8a8b.png\" width=\"210\"/> </a></div>\n<div><a class=\"image\" href=\"/file/images/d/db/2018.08_Helpcenter/Resources/Images/PGView/edit_query_3.png\" title=\"/file/images/d/db/2018.08_Helpcenter/Resources/Images/PGView/edit_query_3.png\"> <img alt=\"edit query 3.png\" class=\"z_migration_tba_PDF\" data-file-height=\"751\" data-file-width=\"882\" height=\"751\" src=\"../../../images/edit_query_3_7085249f.png\" width=\"882\"/> </a></div>\n</li>\n<li>\n<p>Choose the column you want to merge. In this example, choose <b>Id</b> from <b>incident</b>, and <b>incidentid</b> from <b>relationship r_incidentcausedbychange</b>. The constructed query will resemble:</p>\n<pre>select incident.displayLable, incident.id, r_incidentcausedbychange.incidentId,r_ incidentcausedbychange.changeId from incident left join incidentcausedbychange on incident.id = incidentcausedbychange.incidentId</pre>\n<p>At this stage, there should be a new query named <b>Merge1</b> with the merge result between <b>Incident</b> and <b>incidentcausedbychange</b>.</p>\n</li>\n<li>\n<p>Select this Merge1 query. By default, the right side (incidentcausedbychange) of the join table is collapsed. Click the following button to expand the column for further usage.</p>\n<div><a class=\"image\" href=\"/file/images/5/56/2018.08_Helpcenter/Resources/Images/PGView/merge_1.png\" title=\"/file/images/5/56/2018.08_Helpcenter/Resources/Images/PGView/merge_1.png\"> <img alt=\"merge 1.png\" class=\"z_migration_tba_PDF\" data-file-height=\"640\" data-file-width=\"940\" height=\"640\" src=\"../../../images/merge_1_9d94949b.png\" width=\"940\"/> </a></div>\n</li>\n<li>\n<p>Select the <b>Merge1</b> query and click <b>Merge Queries</b> to continue further merge with <b>Change</b>.</p>\n<div><a class=\"image\" href=\"/file/images/5/5c/2018.08_Helpcenter/Resources/Images/PGView/merge_2.png\" title=\"/file/images/5/5c/2018.08_Helpcenter/Resources/Images/PGView/merge_2.png\"> <img alt=\"merge 2.png\" class=\"z_migration_tba_PDF\" data-file-height=\"752\" data-file-width=\"861\" height=\"752\" src=\"../../../images/merge_2_bd987d39.png\" width=\"861\"/> </a></div>\n<p>Then, expand the collapsed columns.</p>\n<ul>\n<li>\n<p>(Optional) You can rename <b>Merge1</b> to a meaningful name such as <b>IncidentCausedByChange</b>.</p>\n</li>\n<li>\n<p>Click <b>Close &amp; Apply</b>. The queries have been built for the report.</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>Create the report.</p>\n<ol>\n<li>\n<p>Select the chart type (<b>stacked</b>, <b>column</b>) in this example.</p>\n</li>\n<li>\n<p>Drag the <b>ID</b> value into the <b>Value</b> drop-down slot.</p>\n</li>\n<li>\n<p>Drag the <b>Priority</b> field into the <b>Axis</b> value slot.</p>\n</li>\n</ol>\n</li>\n<li>\n<p>The report will be generated.</p>\n<div><a class=\"image\" href=\"/file/images/b/b8/2018.08_Helpcenter/Resources/Images/PGView/generate_report.png\" title=\"/file/images/b/b8/2018.08_Helpcenter/Resources/Images/PGView/generate_report.png\"> <img alt=\"generate report.png\" class=\"z_migration_tba_PDF\" data-file-height=\"1702\" data-file-width=\"2311\" height=\"1702\" src=\"../../../images/generate_report_427e40ef.png\" width=\"2311\"/> </a></div>\n<p>You can also create other graphs (click new visual) on the same page. The following figure is an example that combines three graphs, which are table views for all incidents by faulty change, incidents of caused by change grouped by change priority, and the one that shows grouping by change owner group.</p>\n<div><a class=\"image\" href=\"/file/images/e/ec/2018.08_Helpcenter/Resources/Images/PGView/other_graphs.png\" title=\"/file/images/e/ec/2018.08_Helpcenter/Resources/Images/PGView/other_graphs.png\"> <img alt=\"other graphs.png\" class=\"z_migration_tba_PDF\" data-file-height=\"1744\" data-file-width=\"2736\" height=\"1744\" src=\"../../../images/other_graphs_60afb40c.png\" width=\"2736\"/> </a></div>\n</li>\n</ol>\n<h2 class=\"mw-headline\" id=\"PostgreSQL_view_access\">PostgreSQL view access</h2>\n<p>For security reasons, we recommend that you create dedicated PostgreSQL users to access PostgreSQL views. We also recommend that you create a separate user per tenant, with each user having read-only access to his/her own tenant views but no access to other tenants. This is particularly important in the Managed Service Provider mode, where tenants may belong to different customers and where each customer is provided direct access to his/her own views.</p>\n<p>For your convenience, the following 2 processes are listed to create these users with appropriate permissions:</p>\n<ul>\n<li>A process to create PostgreSQL users for existing tenants in the farm</li>\n<li>A process to automate the PostgreSQL user creation for new tenants in the farm and to handle tenant view refreshes</li>\n</ul>\n<p>If you haven't created any tenants in your farm, you can simply use the second process, which should take care of all your needs. Otherwise, you need to run both processes.</p>\n<h2 class=\"mw-headline\" id=\"Create_PostgreSQL_users_for_existing_tenants\">Create PostgreSQL users for existing tenants</h2>\n<p>If you have existing tenants in your farm, connect to the PostgreSQL database \"<b>xservices_ems</b>\" using the user <b>postgres</b>, and then run the following SQL statements for each existing tenant:</p>\n<pre>/* For each existing tenant in the farm &lt;tenantid-i&gt; i = 1…n do */ \nCREATE USER user_&lt;tenantid-i&gt; WITH PASSWORD '&lt;password&gt;'; \nGRANT USAGE ON SCHEMA view_&lt;tenantid-i&gt; TO user_&lt;tenantid-i&gt;; \nGRANT SELECT ON ALL TABLES IN SCHEMA view_&lt;tenantid-i&gt; TO user_&lt;tenantid-i&gt;; \n</pre>\n<p>At this point, you have created a user named <b>user_&lt;tenantid-i&gt;</b> with a corresponding password for each tenant <b>&lt;tenantid-i&gt;</b>. You can provide the user to a tenant owner for reporting purposes.</p>\n<h2 id=\"Create/update_PostgreSQL_users_for_new_tenants_and_refreshed_tenants\"><span class=\"mw-headline\" id=\"Create.2Fupdate_PostgreSQL_users_for_new_tenants_and_refreshed_tenants\">Create/update PostgreSQL users for new tenants and refreshed tenants</span></h2>\n<p>The following procedure automates the process of the user creation for each new tenant to be added to the farm. It also takes care of view refreshes (see the PostgreSQL view generation section).</p>\n<p>Connect to PostgreSQL database \"<b>xservices_ems</b>\" using the user <b>postgres,</b> who must be a super user, and then run the following SQL statements only once:</p>\n<pre>/* Grant some additional permissions to special users 'postgres' and 'maas_admin' */ \n\nGRANT maas_admin to postgres; \n\nALTER USER maas_admin CREATEROLE; \n\n \n\n/* Define the grant_view_access() PL/pgSQL function that creates a new PostgreSQL user named user_&lt;tenantid&gt; (if it doesn't already exist) and provides it with read-only access to all the views under the schema view_&lt;tenantid&gt; */ \n\nCREATE FUNCTION grant_view_access() RETURNS event_trigger AS $$ \n\nDECLARE \n\n  obj RECORD; \n\n  u varchar; \n\n  s varchar; \n\nBEGIN \n\n  FOR obj IN SELECT * FROM pg_event_trigger_ddl_commands() WHERE command_tag in ('CREATE SCHEMA') AND object_identity ~ 'view_.*$' \n\n  LOOP \n\n    s := obj.object_identity; \n\n    u := regexp_replace(s, 'view', 'user'); \n\n     \n\n    IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = u) THEN \n\n      EXECUTE format('CREATE USER %I NOINHERIT', u); \n\n    END IF; \n\n     \n\n    EXECUTE format('GRANT USAGE ON SCHEMA %I TO %I', s, u); \n\n    EXECUTE format('GRANT SELECT ON ALL TABLES IN SCHEMA %I TO %I', s, u); \n\n    EXECUTE format('ALTER DEFAULT PRIVILEGES FOR ROLE maas_admin IN SCHEMA %I GRANT SELECT ON TABLES TO %I', s, u); \n\n     \n\n  END LOOP; \n\nEND; \n\n$$ LANGUAGE plpgsql; \n\n \n\n/* Create a new event trigger on the 'CREATE SCHEMA' statement that invokes the grant_view_access() callback */ \n\nCREATE EVENT TRIGGER create_schema_trigger \n\n    ON ddl_command_end \n\n    WHEN TAG IN ('CREATE SCHEMA') \n\n    EXECUTE PROCEDURE grant_view_access(); \n</pre>\n<p>After these SQL statements are run, any new tenant <b>&lt;tenantid-new&gt;</b> that gets added to the farm automatically creates a new PostgreSQL user named <b>user_&lt;tenantid-new&gt;</b> with the appropriate permissions. At this point, all you need to do is set a password for this new user and provide it to the tenant owner for reporting purposes:</p>\n<p><code>ALTER USER user_&lt;tenantid-new&gt; PASSWORD '&lt;password&gt;';</code></p>\n<p><b>Note:</b> With the current implementation, due to user access control limitations in PostgreSQL, the tenant segregation provided by the above users isn't complete. Each user can see only the data in his/her own tenant views, thus completely avoiding data leak between tenants. However, a user can see the view names of other tenants. In particular, it's possible to see the tenantids of other tenants in the farm (but no actual data). This isn't a security concern since tenant access still requires full authentication irrespective of knowledge of another tenantid, but can be a privacy concern in the case of an MSP.</p>\n<div></div>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}