{
  "title": "SAM license rule APIs",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>This section describes how to extend SAM's license rules through programming. SAM supports license rule extension by providing the capability of creating license rules and the corresponding rule scripts. For more information about how to create license rules, see <a href=\"/doc/423/26.1/samlicenserules\" title=\"SMAX:25.1/SAMLicenseRules\">License rules</a>.</p>\n<h2 class=\"mw-headline\" id=\"What_is_license_rule\">What's license rule</h2>\n<p>A rule script implements the algorithms of license consumption calculation. It focuses on a particular resource unit and generates one valid result. The resource unit can be a software instance, an OSE, a physical device, or other devices, depending on the license terms of the product. The following example uses the Microsoft license terms.</p>\n<p><b>Server licenses (per instance)</b>: Customers might use one running software instance in either a physical or virtual OSE deployed on a licensed server for each license. If a license rule is created for products of this metric, the rule must be implemented on an OSE.</p>\n<h2 class=\"mw-headline\" id=\"Script_security\">Script security</h2>\n<p>The license rules provided by SAM are developed using groovy scripts. The script can do almost everything that Java can do. SAM defines a class allowlist to prevent problematic scripts or even malicious code from harming the service. During scripting, make sure you only use the allowlisted classes. For more information, see the following <em>Class allowlist for scripting</em> section.</p>\n<h2 class=\"mw-headline\" id=\"Develop_a_license_rule_script\">Develop a license rule script</h2>\n<p>After you create a new license rule, SAM automatically generates a rule script from an OOTB template. The OOTB template varies according to license metrics. You can edit the code in the generated script for your own algorithm.</p>\n<p>A valid rule script contains the following parts:</p>\n<ul>\n<li>Part 1: Package definition</li>\n<li>Part 2: Implement the standard ConsumptionCalculator interface</li>\n<li>Part 3: Implement the calculate method</li>\n<li>Part 4: Parameter ParamPerUnit</li>\n<li>Part 5: Implement the license rule</li>\n<li>Part 6: Consumption result</li>\n<li>Part 7: Return the result</li>\n</ul>\n<p>The following figure shows an example script:</p>\n<div><a class=\"image\" href=\"/file/images/e/e4/SAM_2020.11_ConsumptionCalculation.PNG\" title=\"/file/images/e/e4/SAM_2020.11_ConsumptionCalculation.PNG\"> <img alt=\"SAM_2020\" border=\"0\" src=\"../../../images/SAM_2020.11_ConsumptionCalculation_c3c06deb.png\"/> </a></div>\n<h3 class=\"mw-headline\" id=\"Part_1:_Package_definition\">Part 1: Package definition</h3>\n<p>You must define a script class within a package that starts with “script.licenserule”. For example, “script.licenserule” and “script.licenserule.oracle” are valid package names, and “script” and “script.licenserules” are invalid package names. SAM logs an error if an invalid package name is used in the rule script.</p>\n<h3 class=\"mw-headline\" id=\"Part_2:_Implement_the_standard_ConsumptionCalculator_interface\">Part 2: Implement the standard ConsumptionCalculator interface</h3>\n<p>For SAM to recognize your groovy script as a valid license rule, make sure the <code><b>com.microfocus.sam.model.calc.ConsumptionCalculator</b></code> interface is implemented in the script.</p>\n<p>The default rule script has a class that implements the interface defined in the script. It resembles the following:<br/>\n<code>class GenRulePerCore implements ConsumptionCalculator</code></p>\n<p>You can change the class name, but make sure it's unique.</p>\n<h3 class=\"mw-headline\" id=\"Part_3:_Implement_the_calculation_method\">Part 3: Implement the calculation method</h3>\n<p>You must implement the calculation method that allows throwing the <b>ComplianceCalculateException</b> exception. The <b>ParamPerUnit</b> context stores all necessary information in the license rule.</p>\n<p><code>List&lt;ComplianceAnalysis&gt; calculate(ParamPerUnit param) throws ComplianceCalculateException</code></p>\n<h3 class=\"mw-headline\" id=\"Part_4:_Parameter_ParamPerUnit\">Part 4: Parameter <i>ParamPerUnit</i></h3>\n<p>The <i>ParamPerUnit</i> parameter contains CI data. Depending on the license metric of the rule, the parameter can be an instance of the <code><b>com.microfocus.sam.model.params.ParamPerHost</b></code> and <code><b>com.microfocus.sam.model.params.ParamPerOSE</b></code> classes. The following table shows the relationships between the object type of the <b>ParamPerUnit</b> instance and the license metric.</p>\n<table>\n<tbody>\n<tr>\n<th><b>License metric</b></th>\n<th><b>Object type of instance ParamPerUnit</b></th>\n<th><b>Scenario</b></th>\n</tr>\n<tr>\n<td>OOTB\n\t\t\t<p>“Per installation” metric</p>\n</td>\n<td><code>com.microfocus.sam.model.params.ParamPerOSE</code></td>\n<td>ParamPerOSE contains the data of VMs/physical devices and the software instances directly running on them. \n\t\t\t<p>The rule calculates the total number of software installations on the device.</p>\n</td>\n</tr>\n<tr>\n<td>OOTB “Per OSE”\n\t\t\t<p>metric</p>\n</td>\n<td><code>com.microfocus.sam.model.params.ParamPerOSE</code></td>\n<td>ParamPerOSE contains the data of VMs/physical devices and the software instances directly running on them.\n\t\t\t<p>The rule calculates the license consumption of the device, not of each instance.</p>\n</td>\n</tr>\n<tr>\n<td>OOTB \"Named user\" metric</td>\n<td><code>com.microfocus.sam.model.params.ParamPerPerson</code></td>\n<td>\n<p>ParamPerPerson contains the data of users and the software instances are running on the devices managed by the user.</p>\n<p>The rule calculates the license consumption of the person, not of each instance or device.</p>\n</td>\n</tr>\n<tr>\n<td>OOTB \"Per device\" metric</td>\n<td><code>com.microfocus.sam.model.params.ParamPerHost</code></td>\n<td>ParamPerHost contains the data of physical devices/VMs along with their hosts and the software instances running on them.\n\t\t\t<p>The rule calculates the license consumption of the entire host, not of each instance or OSE.</p>\n</td>\n</tr>\n<tr>\n<td>OOTB \"Per core\" metric</td>\n<td><code>com.microfocus.sam.model.params.ParamPerHost</code></td>\n<td>\n<p>ParamPerHost contains the data of physical devices/VMs along with their hosts and the software instances running on them. <span style=\"background-color: transparent;\">Note that the required data of physical cores comes from the physical devices. </span></p>\n<p>The rule calculates the license consumption of the entire host, not of each instance or OSE.</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>As shown in the following examples, you can cast the parameter in the script to a proper object type and invoke methods to get the required CI data. Note that the software list grabbed via the following parameters only refers to the software that you selected to calculate its license consumption. This information is all you need in a calculation. For more information about APIs, see the following <em>Classes and APIs for scripting</em> section.</p>\n<ul>\n<li>ParamPerOSE\n\t<pre><code>Node node =((ParamPerOSE) param).getNode()\n    \n//get software list installed on the OSE directly\nList&lt;SoftwareInstance&gt; softs = node.getSoftwareInstances()\nList&lt;Software&gt; softwareList = ((ParamPerOSE) param).getSoftwareList()</code></pre>\n</li>\n<li>ParamPerHost\n\t<pre><code>Node node =((ParamPerHost) param). getHost()\n    \n//get software list installed on the Host directly\nList&lt;SoftwareInstance&gt; softs = node.getSoftwareInstances()\n    \n//get software list on the host and virtual machines\nList&lt;Software&gt; softwareList = ((ParamPerHost) param).getSoftwareList()</code></pre>\n</li>\n<li>\n<p>ParamPerPerson</p>\n<pre><code>Person person = ((ParamPerPerson) param).getUnitCI()\n    \n//get software list on devices owned by user\nList&lt;Software&gt; softwareList = ((ParamPerPerson) param).getSoftwareList()</code></pre>\n</li>\n</ul>\n<h3 class=\"mw-headline\" id=\"Part_5:_Implement_the_license_rule\">Part 5: Implement the license rule</h3>\n<p>You can refer to the licensing guide of the corresponding publisher to implement your own rules.</p>\n<p>If you want to retrieve the non-OOTB attributes by customizing the query, you can use <strong>ciRawData</strong> to access the custom attributes. For example:</p>\n<ul>\n<li>Choose the<strong> domain_name</strong> attribute in the Node record type.</li>\n</ul>\n<pre>Node node =((ParamPerOSE) param). getNode()\ndef cusDomainName= node.<strong>ciRawData</strong>.domain_name</pre>\n<ul>\n<li>Choose <strong>number_of_points </strong>attribute in InstalledSoftware record type.</li>\n</ul>\n<pre>Node node =((ParamPerOSE) param). getNode()\nList&lt;SoftwareInstance&gt; softs = node.getSoftwareInstances()\ndef usage = 0\nsofts.forEach(e-&gt;usage += (e.ciRawData.number_of_points == null) ? 0 : e.ciRawData.number_of_points)</pre>\n<h3 class=\"mw-headline\" id=\"Part_6:_Consumption_result\">Part 6: Consumption result</h3>\n<p>After SAM calculates the number of consumption points, an instance of the <code><b>com.microfocus.sam.model.vo.compliance.ComplianceAnalysis</b></code> class needs to be created and returned together with the consumption result. The object type returned varies according to the license metric.</p>\n<p>This table lists the mappings between the license metrics and the object types returned.</p>\n<table>\n<tbody>\n<tr>\n<th><b>License metric</b></th>\n<th><b>Instance object type returned</b></th>\n<th><b>Description</b></th>\n</tr>\n<tr>\n<td>OOTB\n\t\t\t<p>“Per installation” metric</p>\n</td>\n<td><code>com.microfocus.sam.model.vo.compliance.NodeComplianceAnalysis</code></td>\n<td>The instance returned stands for the consumption result of the device that's provided in the <em>ParamPerOSE</em> parameter.</td>\n</tr>\n<tr>\n<td>OOTB\n\t\t\t<p>“Per OSE” metric</p>\n</td>\n<td><code>com.microfocus.sam.model.vo.compliance.NodeComplianceAnalysis</code></td>\n<td>The instance returned stands for the consumption result of the device that's provided in the <em>ParamPerOSE </em>parameter.</td>\n</tr>\n<tr>\n<td>OOTB \"Named user\" metric</td>\n<td><code>com.microfocus.sam.model.vo.compliance.PersonComplianceAnalysis</code></td>\n<td>The instance returned stands for the consumption result of the person that's provided in the<em> ParamPerPerson</em> parameter.</td>\n</tr>\n<tr>\n<td>OOTB \"Per device\" metric/OOTB \"Per core\" metric</td>\n<td><code>com.microfocus.sam.model.vo.compliance.NodeCompliance Analysis</code></td>\n<td>The instance returned stands for the consumption result of the host that's provided in the <i>ParamPerHost</i> parameter.\n\t\t\t<p>It can contain multiple NodeComplianceAnalysis records. Each record is related to a VM where the software instances are located. These NodeComplianceAnalysis records are used for further analysis.</p>\n</td>\n</tr>\n</tbody>\n</table>\n<h4 class=\"mw-headline\" id=\"Major_methods_related_to_consumption_result\">Method related to the consumption result</h4>\n<p><b>setConsumptionPoints: </b>Sets the number of consumption points for the compliance analysis result.</p>\n<p>Example: <code>analysis.setConsumptionPoints(iTotalConsumptionPoints)</code></p>\n<p>In this example, <i>analysis</i> can be <b>NodeComplianceAnalysis</b>.</p>\n<h3 class=\"mw-headline\" id=\"Part_7:_Return_result\">Part 7: Return result</h3>\n<p>After being created and assigned with proper values, the instance of the <code><b>com.microfocus.sam.model.vo.compliance.ComplianceAnalysis</b></code> class needs to be returned.</p>\n<p>Example: <code>return hostAnalysis</code></p>\n<h2>Return two sets of consumption result in one license rule</h2>\n<p>A product version might have different licensing options. From Service Management 2020.11, SAM can return two sets of consumption result in one license rule. For example, a SQL Server Enterprise Edition application running on a virtual machine can be licensed either by the <strong>Licensing by all physical cores</strong> option or the <strong>Licensing individual virtual machine </strong>option, and an IBM DB2 application can be licensed either by <strong>PVU Sub-capacity</strong> or <strong>PVU Full-capacity</strong>. You can get a result for each licensing option and use one result for later compliance calculation.</p>\n<div><a class=\"image\" href=\"/file/images/3/39/SAM_2020.11_TwoResultSets.PNG\" title=\"/file/images/3/39/SAM_2020.11_TwoResultSets.PNG\"> <img alt=\"SAM_2020\" border=\"0\" src=\"../../../images/SAM_2020.11_TwoResultSets_a1970566.png\"/> </a></div>\n<h3>Part 1: Calculate two sets of result</h3>\n<p>When a product version has multiple licensing options, SAM can return two result sets for each option.</p>\n<h3>Part 2: Save two sets of result</h3>\n<p>Methods related to the consumption results:</p>\n<ul>\n<li><b>setConsumption1: </b>Sets the number of consumption points for result 1.</li>\n<li><b>setConsumption2: </b>Sets the number of consumption points for result 2.</li>\n</ul>\n<p>By using the following methods, you can configure licensing option descriptions for each consumption result, which is presented as the display label on SAM UI (<strong>Analysis</strong> &gt; <strong>Consumption</strong> &gt; <strong>Details</strong>). </p>\n<ul>\n<li><b>setConsumption1Desc: </b>Describes the licensing option for result 1.</li>\n<li><b>setConsumption2Desc: </b>Describes the licensing option for result 2.</li>\n</ul>\n<div><a class=\"image\" href=\"/file/images/4/42/SAM_2020.11_ResultSets_UI.PNG\" title=\"/file/images/4/42/SAM_2020.11_ResultSets_UI.PNG\"> <img alt=\"SAM_2020\" border=\"0\" src=\"../../../images/SAM_2020.11_ResultSets_UI_89ec9085.png\"/> </a></div>\n<h3>Part 3: Select one result for subsequent compliance calculation</h3>\n<p>If two result sets exist, select one of them for later compliance calculation using the following method:</p>\n<p><b>setChosenOption: </b>Indicates the consumption result that's used for compliance calculation. Valid values include <strong>1</strong> and <strong>2</strong>. The default value is <strong>1</strong>. </p>\n<p>For a given license rule, we recommend that you assign the same licensing option description for the same consumption result set, as shown in the following figure. By default, result 1 is used for compliance calculation. However, you can use the <b>setChosenOption </b>method to choose your desired consumption result for compliance calculation.</p>\n<div><a class=\"image\" href=\"/file/images/c/cb/SAM_2020.11_LicensingOption.PNG\" title=\"/file/images/c/cb/SAM_2020.11_LicensingOption.PNG\"> <img alt=\"SAM_2020\" border=\"0\" src=\"../../../images/SAM_2020.11_LicensingOption_1a5bc48d.png\"/> </a></div>\n<h2 class=\"mw-headline\" id=\"Use_logs_in_a_script\">Use logs in a script</h2>\n<p>A license rule script can write information to a log file for debugging and diagnostic purposes. To do that, you must define the logger object first. An example script resembles the following:</p>\n<pre>class YOUR_CLASS implements ConsumptionCalculator {\nLogger log = LoggerFactory.getLogger(this.class)\nList&lt;ComplianceAnalysis&gt; calculate(ParamPerUnit param) throws\nCalculateException {\n……\nlog.debug(“This is debug info”)\n……\n}\n}</pre>\n<h2 class=\"mw-headline\" id=\"Class_allowlist_for_scripting\">Class allowlist for scripting</h2>\n<p>In SAM, you can use the following allowlisted classes in a license rule script.</p>\n<ul>\n<li>java.lang.Object</li>\n<li>java.lang.String</li>\n<li>java.lang.Long</li>\n<li>java.lang.Integer</li>\n<li>java.lang.Double</li>\n<li>java.lang.Boolean</li>\n<li>java.lang.Byte</li>\n<li>java.lang.Character</li>\n<li>java.lang.Enum</li>\n<li>java.lang.Math</li>\n<li>java.lang.Number</li>\n<li>java.lang.Float</li>\n<li>java.lang.StringBuffer</li>\n<li>java.lang.StringBuilder</li>\n<li>java.math.BigDecimal</li>\n<li>java.math.BigInteger</li>\n<li>java.util.ArrayList</li>\n<li>java.util.Arrays</li>\n<li>java.util.Collection</li>\n<li>java.util.Collections</li>\n<li>java.util.Date</li>\n<li>java.util.HashMap</li>\n<li>java.util.HashSet</li>\n<li>java.util.Hashtable</li>\n<li>java.util.Iterator</li>\n<li>java.util.List</li>\n<li>java.util.Locale</li>\n<li>java.util.Map</li>\n<li>java.util.Set</li>\n<li>java.util.StringTokenizer</li>\n<li>java.util.TimeZone</li>\n<li>java.util.UUID</li>\n<li>java.util.stream.Collector</li>\n<li>java.util.stream.Collectors</li>\n<li>java.util.stream.Stream</li>\n<li>java.util.stream.Streams</li>\n<li>org.slf4j.Logger</li>\n<li>org.slf4j.LoggerFactory</li>\n<li><code>com.microfocus.sam.model.calc.ConsumptionCalculator</code></li>\n<li><code>com.microfocus.sam.model.exception.ComplianceCalculateException</code></li>\n<li><code>com.microfocus.sam.model.vo.compliance.ComplianceAnalysis</code></li>\n<li><code>com.microfocus.sam.model.vo.compliance.NodeComplianceAnalysis</code></li>\n<li><code>com.microfocus.sam.model.vo.compliance.PersonComplianceAnalysis</code></li>\n<li><code>com.microfocus.sam.model.params.ParamPerUnit</code></li>\n<li><code>com.microfocus.sam.model.params.ParamPerUnit$PropertyName</code></li>\n<li><code>com.microfocus.sam.model.params.ParamPerHost</code></li>\n<li><code>com.microfocus.sam.model.params.ParamPerOSE</code></li>\n<li><code>com.microfocus.sam.model.params.ParamPerPerson</code></li>\n<li><code>com.microfocus.sam.model.params.enums.CIValidationEnum</code></li>\n<li><code>com.microfocus.sam.model.params.enums.PerCoreLicensingOptionEnum</code></li>\n<li><code>com.microfocus.sam.model.vo.ci.Device</code></li>\n<li><code>com.microfocus.sam.model.vo.ci.Host</code></li>\n<li><code>com.microfocus.sam.model.vo.ci.VirtualMachine</code></li>\n<li><code>com.microfocus.sam.model.vo.ci.VirtualizationTechEnum</code></li>\n<li><code>com.microfocus.sam.model.vo.ci.Node</code></li>\n<li><code>com.microfocus.sam.model.vo.ci.NodeTypeEnum</code></li>\n<li><code>com.microfocus.sam.model.vo.ci.OSFamilyEnum</code></li>\n<li><code>com.microfocus.sam.model.vo.ci.Processor</code></li>\n<li><code>com.microfocus.sam.model.vo.ci.SoftwareInstance</code></li>\n<li><code>com.microfocus.sam.model.vo.licenserule.Product</code></li>\n<li><code>com.microfocus.sam.model.vo.licenserule.ProductVersion</code></li>\n<li><code>com.microfocus.sam.model.vo.licenserule.ProductEditionEnum</code></li>\n<li><code>com.microfocus.sam.model.vo.misc.LanguageEnum</code></li>\n<li><code>com.microfocus.sam.model.vo.ext_ci.ExternalLicenseModel</code></li>\n<li>\n<p><code>com.microfocus.sam.model.vo.contract.ContractStatusEnum</code></p>\n</li>\n</ul>\n<p>The following primitive data types also work in the script:</p>\n<ul>\n<li>long</li>\n<li>int</li>\n<li>boolean</li>\n<li>double</li>\n<li>float</li>\n<li>byte</li>\n<li>char</li>\n</ul>\n<p>For classes whose package name contains the <code><b>com.microfocus.sam</b></code> prefix, see the following <em>Classes and APIs for scripting</em> section. For other classes, see the corresponding JDK documentation.</p>\n<h2 class=\"mw-headline\" id=\"Classes_and_APIs_for_scripting\">Classes and APIs for scripting</h2>\n<p>This section describes the classes and APIs for license rule scripting.</p>\n<table>\n<tbody>\n<tr>\n<th><b>Packages</b></th>\n</tr>\n<tr>\n<td><code>com.microfocus.sam.model.exception</code></td>\n</tr>\n<tr>\n<td><code>com.microfocus.sam.model.params</code></td>\n</tr>\n<tr>\n<td><code>com.microfocus.sam.model.vo.ci</code></td>\n</tr>\n<tr>\n<td><code>com.microfocus.sam.model.vo.compliance</code></td>\n</tr>\n<tr>\n<td><code>com.microfocus.sam.model.vo.misc</code></td>\n</tr>\n</tbody>\n</table>\n<p>For more information about the available classes and APIs and how to use them, click <a href=\"/SAM/2021.11/index.html\" title=\"here\">here</a>.</p>\n<div></div>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}