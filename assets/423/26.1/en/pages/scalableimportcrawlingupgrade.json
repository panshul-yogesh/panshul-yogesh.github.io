{
  "title": "Errors occur running ScalableImportTableSeparationUpdateCrawlingStep during upgrade",
  "content": "<div class=\"mw-parser-output\"><br/><p>After you run the <code>ScalableImportTableSeparationUpdateCrawlingStep</code> crawling upgrade step, you find errors that resemble the following written to the <code>maas_crawling_upgrade.log</code> file:</p>\n<pre><code>ScalableImportTableSeparationUpdateCrawlingStep failed to retrieve legacyJobIds from scalableImportState table... \nScalableImportTableSeparationUpdateCrawlingStep failed to migrate data for JobId...</code></pre>\n<h2>Cause</h2>\n<p>The cause of this issue is unknown.</p>\n<h2>Solution</h2>\n<ol>\n<li>Generate SQL scripts to migrate the results data from the <code>scalableImportState</code> tables to the <code>scalableImportResult</code> tables in the <strong>xservices_rms</strong> database. To do this, enter the <strong>xservices_mng</strong> database and run the following commands on the database client:\n\n\t<pre><code>\\c xservices_mng;\nSET SEARCH_PATH=maas_admin,\"$user\", public;\nSELECT\n'INSERT INTO \"scalableImportResult_'||tenant_id||'\"\nSELECT\n id,\n json_build_object(\n ''id'', state.id,\n ''jobId'', state.body::json-&gt;''jobId'',\n ''details'', state.body::json-&gt;''details'',\n ''sourceLayout'', state.body::json-&gt;''sourceLayout''\n )\nFROM \"scalableImportState_'||tenant_id||'\" state\nWHERE state.id IN (\n SELECT\n sis.id from \"scalableImportState_'||tenant_id||'\" sis\n LEFT OUTER JOIN \"scalableImportResult_'||tenant_id||'\" sir\n ON sis.body::json-&gt;''jobId''-&gt;&gt;''id'' = sir.body::json-&gt;''jobId''-&gt;&gt;''id''\n WHERE sir.id IS NULL AND sis.body::json-&gt;&gt;''status'' &lt;&gt; ''SUCCESS''\n);' \nas \"STEP 1: SQLs for migration of state data (xservices_rms):\"\nFROM data_upgrade_state where length(tenant_id)=9 and tenant_id &lt;&gt; '857561481';</code></pre>\n<p>This will generate one SQL command for each tenant. The returned value should resemble the following:</p>\n<pre><code>INSERT INTO \"scalableImportResult_&lt;tenant_ID&gt;\"\nSELECT\n id,\n json_build_object(\n 'id', state.id,\n 'jobId', state.body::json-&gt;'jobId',\n 'details', state.body::json-&gt;'details',\n 'sourceLayout', state.body::json-&gt;'sourceLayout'\n )\nFROM \"scalableImportState_&lt;tenant_ID&gt;\" state\nWHERE state.id IN (\n SELECT\n sis.id from \"scalableImportState_&lt;tenant_ID&gt;\" sis\n LEFT OUTER JOIN \"scalableImportResult_&lt;tenant_ID&gt;\" sir\n ON sis.body::json-&gt;'jobId'-&gt;&gt;'id' = sir.body::json-&gt;'jobId'-&gt;&gt;'id'\n WHERE sir.id IS NULL AND sis.body::json-&gt;&gt;'status' &lt;&gt; 'SUCCESS'\n);</code></pre>\n</li>\n<li>Enter the <strong>xservices_rms</strong> database, then run all the SQL commands generated in step 1 to copy the detailed data from the <code>scalableImportState</code> table to the <code>scalableImportResult</code> table on each tenant.</li>\n<li>Generate SQL scripts to delete the results data from the <code>scalableImportState</code> table. To do this, enter the <strong>xservices_mng</strong> database and run the following commands:\n\t<pre><code>\\c xservices_mng;\nSET SEARCH_PATH=maas_admin,\"$user\", public;\nSELECT\n'UPDATE \"scalableImportState_'||tenant_id||'\"\nSET body = jsonb_set(body, ''{details,records}'', ''[]''::jsonb, true)\nwhere id IN (\nSELECT sis.id FROM \"scalableImportState_'||tenant_id||'\" sis\nWHERE sis.body::json-&gt;&gt;''status'' &lt;&gt; ''SUCCESS''\n);'\nas \"STEP 2: SQLs for removing results from state (xservices_rms):\"\nFROM data_upgrade_state where length(tenant_id)=9 and tenant_id &lt;&gt; '857561481';</code></pre>\n<p>This will generate one SQL command for each tenant. The returned value should resemble the following:</p>\n<pre><code>UPDATE \"scalableImportState_&lt;tenant_ID&gt;\"\nSET body = jsonb_set(body, '{details,records}', '[]'::jsonb, true)\nwhere id IN (\n SELECT sis.id FROM \"scalableImportState_&lt;tenant_ID&gt;\" sis\n WHERE sis.body::json-&gt;&gt;'status' &lt;&gt; 'SUCCESS'\n);</code></pre>\n</li>\n<li>Enter the <strong>xservices_rms</strong> database, then run all the commands generated in step 3 to delete the results data from the <code>scalableImportState</code> on each tenant.</li>\n</ol>\n</div>",
  "modifiedon": "2025-10-24 08:51:12"
}