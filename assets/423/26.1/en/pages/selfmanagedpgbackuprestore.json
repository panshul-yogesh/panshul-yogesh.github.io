{
  "title": "Self-managed PostgreSQL backup and restore",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\"></p><div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>This topic provides instructions on how to back up the data of a self-managed PostgreSQL instance, using base backups and continuous archives, which you can perform at runtime without service interruption. To keep data consistency among all databases of the suite, instance-level backup is recommended. If your databases are running on different PostgreSQL instances, consider creating backups of these instances simultaneously to avoid inconsistency. </p>\n<p>This topic doesn't discuss how to back up a single database using pg_dump. Note that although you can use pg_dump without stopping the PostgreSQL service, you need to stop the applications to keep data consistency when using pg_dump to back up the Service Management databases one by one. </p>\n<div class=\"Admonition_Important\"><span class=\"autonumber\">Important</span> Practice guidance of any third-party products (for example, PostgreSQL) provided by <code>OpenText</code> is for reference purposes only with an intention to help customers. However, customers will remain responsible for ensuring that the end-to-end solution works with the underlying infrastructure, hardware/software dependencies, and more. <code>OpenText</code> will extend its responsibility and support for <code>OpenText</code> products only per contractual agreements as applicable.</div>\n<h2 id=\"Prerequisites\">Prerequisites</h2>\n<p>Before you begin, complete the following prerequisite tasks.</p>\n<h3>Prepare a PostgreSQL Client host</h3>\n<p>Prepare a Linux host with a PostgreSQL Client installed. The version of the Linux OS and the version of the PostgreSQL Client should be the same as those of the PostgreSQL Server.</p>\n<p><strong>Notes:</strong> You can find a <a href=\"https://www.postgresql.org/download/linux/redhat/\">Postgres Repository</a> and then install the Client.</p>\n<pre><code>#An example for installing the client of PostgreSQL 12 on Redhat 8\n# Install the repository RPM:\nyum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm\n\n# Disable the built-in PostgreSQL module:\nsudo dnf -qy module disable postgresql\n\n#Install PostgreSQL Client\nyum install -y postgresql12-libs\nyum install -y postgresql12\n\n </code></pre>\n<h3>Prepare a disk for backup storage</h3>\n<p>Prepare a disk to store the backup files. Make sure the disk capacity is enough.</p>\n<h2>Backup</h2>\n<p>There are two types of backup: base backup, and continuous archive. </p>\n<h3>Create base backups</h3>\n<p>A base backup is a full backup. Create a base backup on a regular basis. </p>\n<p>The procedure varies depending on whether you're using single-node PostgreSQL or a Patroni-based PostgreSQL HA cluster. </p>\n<h4>Create a base backup for single-node PostgreSQL</h4>\n<ol>\n<li>Make sure you have the following parameters configured in the postgresql.conf file on the PostgreSQL Server. If there are no such parameters already configured, you can skip this step to use the default values.<br/>\n\tHere is an example of a single-node PostgreSQL server:\n\t<pre><code>max_replication_slots = '4'\nmax_wal_senders = '4'\nwal_level = 'replica'\n</code></pre>\n</li>\n<li>Create a PostgreSQL slot, by running the following commands on the PostgreSQL server:\n\t<pre><code>sudo su - postgres\npsql -c \"select * from pg_create_physical_replication_slot('&lt;pg-slotname&gt;');\"\npsql -c \"select * from pg_replication_slots;\"</code></pre>\n</li>\n<li>PostgreSQL requires a user, also called a role, with special permissions to perform replication. Create a user to perform replication, by running the following command on the PostgreSQL server:\n\t<pre><code>sudo su - postgres\ncreateuser -U postgres &lt;replicatoin-user&gt; -P -c 5 --replication</code></pre>\n</li>\n<li>Add a new line to &lt;PGDATA&gt;/pg_hba.conf to make sure the created user can access the PostgreSQL Server.\n\t<p>For an example, add the following line to /var/lib/pgsql/12/data/pg_hba.conf:</p>\n<pre><code>host replication &lt;replication-user&gt; &lt;client-ip&gt; md5</code></pre>\n\tWhere: &lt;replication-user&gt; is the user you created for performing replication, and &lt;client-ip&gt; is the IP address of the PostgreSQL Client host.\n\n\t<p>Make the change take effect. Running the following command if you are using PostgreSQL 12 as an example:</p>\n<pre><code>sudo su - postgres\n/usr/pgsql-12/bin/pg_ctl reload      </code></pre>\n</li>\n<li>Make sure the owners of all the files under the PGDATA folder are 'postgres'.\n\t<p>For an example, go to the folder /var/lib/pgsql/12/ and list all the files:</p>\n<pre><code>cd /var/lib/pgsql/12\nls -la</code></pre>\n<p>If there are some files which names are not 'postgres'，you need move or remove them out of the PGDATA folder or change the owner of these files to be 'postgres' if you want to bring them to the target database server.</p>\n</li>\n<li>Run the following command to back up the data on the PostgreSQL Client host or the target database server.  \n\t<p>If you want to backup the data and restore them directly to the target database server, you need shutdown the target PostgreSQL server then backup the PGDATA folder to other place in advance. After run the following command, you can start the PostgreSQL server.</p>\n<pre><code>pg_basebackup -h &lt;pg-host&gt; -p 5432 -D &lt;target-folder&gt;/data -v -P --wal-method=stream --slot=&lt;pg-slotname&gt; -U &lt;replicatoin-user&gt; </code></pre>\n\tWhere:\n\n\t<ul>\n<li>&lt;pg-host&gt;: the host name or IP address of the primary PostgreSQL Server host.</li>\n<li>&lt;target-folder&gt;: an existing folder on the disk that you prepared to store backup data. The &lt;target-folder&gt;/data could be the target PGDATA folder if you run it on the target PostgreSQL server.</li>\n<li>&lt;pg-slotname&gt;: the name of the PostgreSQL slot you created.</li>\n<li>&lt;replication-user&gt;: the user you created for performing replication.</li>\n</ul>\n</li>\n<li>Compress the backup data to a *.tar.gz file if you want to take the data as an archive.\n\t<pre><code>tar czvf data.tar.gz data</code></pre>\n</li>\n</ol>\n<h4>Create a base backup for a Partroni-based PogreSQL HA setup</h4>\n<ol>\n<li>Create a PostgreSQL slot, by running the following command on the primary server:\n\t<pre><code>sudo su - postgres\npsql -c \"select * from pg_create_physical_replication_slot('&lt;pg-slotname&gt;');\"\npsql -c \"select * from pg_replication_slots;\"</code></pre>\n</li>\n<li>Create a user to perform replication. On the primary server, run the following command:\n\t<pre><code>sudo su - postgres\ncreateuser -U postgres &lt;replicatoin-user&gt; -P -c 5 --replication</code></pre>\n</li>\n<li>Add a new line to &lt;PGDATA&gt;/pg_hba.conf of the primary server to make sure the replication user you created can access the primary server.\n\t<p>For an example, add the line to /var/lib/pgsql/12/data/pg_hba.conf:</p>\n<pre><code>host replication &lt;replication-user&gt; &lt;client-ip&gt; md5</code></pre>\n\tReload the configuration by running the following command:\n\n\t<pre><code>patronictl -c /opt/app/patroni/etc/postgresql.yml reload postgres</code></pre>\n</li>\n<li>Run the following command to back up the data on the PostgreSQL Client host. \n\t<pre><code>pg_basebackup -h &lt;pg-host&gt; -p 5432 -D &lt;target-folder&gt;/data -v -P --wal-method=stream --slot=&lt;pg-slotname&gt; -U &lt;replicatoin-user&gt; </code></pre>\n<p>Where:</p>\n<ul>\n<li>&lt;pg-host&gt;: the host name or IP address of the primary PostgreSQL Server host.</li>\n<li>&lt;target-folder&gt;: an existing folder on the disk that you prepared to store backup data.</li>\n<li>&lt;pg-slotname&gt;: the name of the PostgreSQL slot you created.</li>\n<li>&lt;replication-user&gt;: the user you created for performing replication.</li>\n</ul>\n</li>\n<li>Compress the backup data to a *.tar.gz file.\n\t<pre><code>tar czvf data.tar.gz data</code></pre>\n</li>\n</ol>\n<h3>Set up a standby (read-only) database server without failover</h3>\n<ol>\n<li>Prepare the primary database for the standby database server. To do this, follow these steps on the primary database server:\n\t<ol start=\"1\">\n<li>Create a PostgreSQL slot by running the following command on the primary server:\n\t\t<pre><code>sudo su - postgres\npsql -c \"select * from pg_create_physical_replication_slot('&lt;pg-slotname&gt;');\"\npsql -c \"select * from pg_replication_slots;\"</code></pre>\n</li>\n<li>Create a user to perform replication. On the primary server, run the following command:\n\t\t<pre><code>sudo su - postgres\ncreateuser -U postgres &lt;replicatoin-user&gt; -P -c 5 --replication</code></pre>\n</li>\n<li>Add a new line to &lt;PGDATA&gt;/pg_hba.conf to make sure the created user can access the PostgreSQL Server.\n\t\t<p>For example, add the following line to /var/lib/pgsql/12/data/pg_hba.conf:</p>\n<pre><code>host replication &lt;replication-user&gt; &lt;client-ip&gt; md5</code></pre>\n\t\tWhere: &lt;replication-user&gt; is the user you created for performing replication and &lt;client-ip&gt; is the IP address of the PostgreSQL Client host.\n\n\t\t<p>Make the change effective. For example, run the following command if you are using PostgreSQL 12:</p>\n<pre><code>sudo su - postgres\n/usr/pgsql-12/bin/pg_ctl reload      </code></pre>\n</li>\n<li>Make sure you have the following parameters configured in the postgresql.conf file on the PostgreSQL Server. If there are no such parameters already configured, you can skip this step to use the default values. Here is an example for the primary server:\n\t\t<pre><code>max_replication_slots = '4'\nmax_wal_senders = '4'\nwal_level = 'replica'\n</code></pre>\n</li>\n</ol>\n</li>\n<li>Install a new PostgreSQL server with the same version as the primary database server.\n\t<pre><code>#An example for installing the client of PostgreSQL 12 on Redhat 8\n# Install the repository RPM:\nyum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm\n\n# Disable the built-in PostgreSQL module:\nsudo dnf -qy module disable postgresql\n\n#Install PostgreSQL Client\nyum install -y postgresql12-server\n\n# Optionally initialize the database and enable automatic start:\nsudo /usr/pgsql-12/bin/postgresql-12-setup initdb\nsudo systemctl enable postgresql-12\nsudo systemctl start postgresql-12\n </code></pre>\n</li>\n<li>Run the standby server with base backup data. To do this, run the following steps on the standby server:\n\t<ol start=\"1\">\n<li>Stop the standby database server.\n\t\t<pre><code>systemctl stop postgresql-12</code></pre>\n</li>\n<li>Remove the &lt;PGDATA&gt; folder you just created by running the initdb command. For example:\n\t\t<pre><code>rm -rf /var/lib/pgsql/12/data</code></pre>\n</li>\n<li>Do a base backup to synchronize the data from the primary server. On the standby host, run the following command.\n\t\t<pre><code>pg_basebackup -h &lt;pg-host&gt; -p 5432 -D &lt;target-folder&gt;/data -v -P --wal-method=stream --slot=&lt;pg-slotname&gt; -U &lt;replicatoin-user&gt; </code></pre>\n<p>Where:</p>\n<ul>\n<li>&lt;pg-host&gt;: the hostname or IP address of the primary PostgreSQL Server host.</li>\n<li>&lt;target-folder&gt;: an existing folder on the disk that you prepared to store backup data. For example, /var/lib/pgsql/12</li>\n<li>&lt;pg-slotname&gt;: the name of the PostgreSQL slot you created.</li>\n<li>&lt;replication-user&gt;: the user you created for performing replication.</li>\n</ul>\n</li>\n<li>Start up the standby server.\n\t\t<pre><code>systemctl start postgresql-12</code></pre>\n</li>\n<li>Check if the databases and the users have already been synchronized to this standby server.\n\t\t<pre><code>psql -c 'select datname from pg_database;'\npsql -c 'select usename from pg_user;'</code></pre>\n</li>\n</ol>\n</li>\n<li>Configure streaming replication and run it on the standby database server. To do this, run the following steps on the standby server:\n\t<ol start=\"1\">\n<li>In the PGDATA folder, create a file with the name \"standby.signal.\"<br/>\n\t\tHere is an example:\n\t\t<pre><code>su - postgres\ncd /var/lib/pgsql/12/data\ntouch standby.signal</code></pre>\n</li>\n<li>Add the following parameters in postgresql.conf.\n\t\t<pre><code>primary_conninfo = 'host=&lt;primary-server-ip&gt; port=&lt;db-port&gt; user=&lt;replication-user&gt; password=&lt;replication-user-password&gt;'\nprimary_slot_name = &lt;pg-slotname&gt;</code></pre>\n</li>\n<li>Restart the PostgreSQL server.\n\t\t<pre><code>systemctl start postgresql-12</code></pre>\n</li>\n<li>Check if the streaming replication works and all changes on the primary database are synchronized to the standby database server.</li>\n</ol>\n</li>\n<li>Make sure the database server certification on this DB instance is signed by the same CAs as the primary database server so that the read-only platform pods in Service Management suite can connect to it.</li>\n</ol>\n<h3>Enable continuous archiving</h3>\n<p>If you want to be able to do point-in-time recovery (PITR), you need to archive the WAL segments which can later be used to roll forward from a base backup.</p>\n<p>Note that you must meet the following requirements:</p>\n<ul>\n<li>The archival storage is big enough.</li>\n<li>You have a warning mechanism when the storage is nearly full.</li>\n<li>The IOPS and the throughput of the storage are acceptable.</li>\n<li>The storage is a secure place to keep the backup data.</li>\n</ul>\n<p>To enable continuous archiving:</p>\n<ol start=\"1\">\n<li>Mount the archival storage to the primary host. Make sure the user \"postgres\" has write permission to the mounted folder.</li>\n<li>Enable continuous archiving:<br/>\n\tFor single-node PostgreSQL, add the following lines to the postgresql.conf file:\n\t<pre><code>archive_command: 'test ! -f /mnt/server/archivedir/%f &amp;&amp; cp %p /mnt/server/archivedir/%f'\narchive_mode: 'true'\narchive_timeout: 60</code></pre>\n\tFor a Patroni-based PostgreSQL HA cluster, perform the following steps:\n\n\t<pre><code>#run command\npatronictl -c /opt/app/patroni/etc/postgresql.yml edit-config postgres\n\n#add the following lines to the section postgresql.parameters:\narchive_command: 'test ! -f /mnt/server/archivedir/%f &amp;&amp; cp %p /mnt/server/archivedir/%f'\narchive_mode: 'true'\narchive_timeout: 60</code></pre>\n</li>\n<li>Verify that your archived files are copied to the archival storage.\n\t<p><strong>Note:  </strong>Refer to the PostgreSQL document <a href=\"https://www.postgresql.org/docs/current/continuous-archiving.html#BACKUP-ARCHIVING-WAL\">BACKUP-ARCHIVING-WAL</a> if you want an archive file to be generated immediately for testing. For example, you can run the following sql: <strong>select pg_switch_wal();</strong>.</p>\n</li>\n<li>\n<p>If the archival process works as expected, create a base backup (which will be used as the baseline of subsequent continuous archives) and keep the base backup on the archival storage.</p>\n</li>\n</ol>\n<h2>Restore</h2>\n<p>Restore backup data from a base backup or continuous archives.</p>\n<h3>Restore from a base backup</h3>\n<h4>For a Patroni-based PostgreSQL HA cluster</h4>\n<ol>\n<li>Stop the PostgreSQL Servers.\n\t<p><strong>Note:</strong> You must stop the standby host first and then the primary host. </p>\n<ol start=\"1\">\n<li>On the standby host, run the following command to stop Patroni:\n\t\t<pre><code>systemctl stop patroni</code></pre>\n</li>\n<li>On the primary host, run the following command to stop Patroni:\n\t\t<pre><code>systemctl stop patroni</code></pre>\n</li>\n</ol>\n</li>\n<li>Restore the base backup data to the PGDATA folder on each of the PostgreSQL servers.\n\t<ol start=\"1\">\n<li>Back up the PGDATA folder to another place in case you need it in the future.</li>\n<li>Copy the base backup data to the PGDATA folder.</li>\n<li>Make sure the owner of the restored PGDATA folder including the subfolders and files is \"postgres\". For example, you can do the following:\n\t\t<pre><code>cd /var/lib/pgsql/12</code>\n\n<code>chown postgres:postgres data</code></pre>\n</li>\n</ol>\n</li>\n<li>Start the PostgreSQL Servers.\n\t<p><strong>Note:</strong> You must start the primary host first and then the standby host.</p>\n<ol start=\"1\">\n<li>On the primary host, run the following command to start Patroni:\n\t\t<pre><code>systemctl start patroni</code></pre>\n</li>\n<li>On the standby host, run the following command to start Patroni:\n\t\t<pre><code>systemctl start patroni</code></pre>\n</li>\n</ol>\n</li>\n</ol>\n<h4>For a single-node PostgreSQL</h4>\n<ol>\n<li>Stop the PostgreSQL Server.</li>\n<li>Restore the base backup data to the PGDATA folder on the PostgreSQL Server.</li>\n<li>Start the PostgreSQL Server.</li>\n</ol>\n<h3>Perform Point-in-Time Recovery (PITR)</h3>\n<p><strong>Note: </strong>This recovery is used to recover from data loss. For example, your DBA drops a table by mistake. If you have decided to perform a PITR, you need to disconnect the applications from the database server in the first place.</p>\n<h4>For a single-node PostgreSQL</h4>\n<ol>\n<li>Back up the pg_hba file.</li>\n<li>Change the pg_hba file and make sure no application can connect to the database. </li>\n<li>Determine your recovery target. See <a href=\"https://www.postgresql.org/docs/current/runtime-config-wal.html#RUNTIME-CONFIG-WAL-ARCHIVE-RECOVERY\">\"20.5.5. Recovery Target\"</a>.</li>\n<li>Get the base backup data and the archived wal files, and make sure these files can be accessed by the OS user postgres on the PostgreSQL Server. You can copy the base backup data and archived files to the PostgreSQL host if the disk capacity is big enough.</li>\n<li>Stop the PostgreSQL Server.</li>\n<li>Recover the data on the PostgreSQL Server.\n\t<ol start=\"1\">\n<li>On the PostgreSQL Server, replace the data with the base backup.</li>\n<li>Add the following lines to the postgresql.conf file:\n\t\t<pre><code>restore_command = 'cp /mnt/server/archivedir/%f \"%p\"'\n#Set your recovery target here.Here is an example to recover the data before the time specified.\n#recovery_target_time=&lt;Specify a time from when you begin your wrong operation&gt;\n#recovery_target_inclusive='off'</code></pre>\n</li>\n<li>Create a file called recovery.signal in the data directory. </li>\n</ol>\n</li>\n<li>Start the PostgreSQL Server.</li>\n<li>Make sure you have the data restored as expected.</li>\n<li>Recover the original pg_hba file by copying the original file back.<br/>\n\tRun the following command on the PostgreSQL Server to reload the file:\n\t<pre><code>pg_ctl reload</code></pre>\n</li>\n<li>Make sure the applications can connect to the database and work as expected.</li>\n</ol>\n<h4>For a Patroni-based PostgreSQL HA cluster</h4>\n<ol>\n<li>Back up the pg_hba file of the primary node.</li>\n<li>Change the pg_hba and make sure no application can connect to the database.</li>\n<li>Determine your recovery target. Please see <a href=\"https://www.postgresql.org/docs/current/runtime-config-wal.html#RUNTIME-CONFIG-WAL-ARCHIVE-RECOVERY\">\"20.5.5. Recovery Target\"</a>.</li>\n<li>Get the base backup data and the archived wal files. You can copy them to the primary host if the disk capacity is big enough. Make sure these files can be accessed by the OS user postgres on the primary host.</li>\n<li>Stop the Patroni Service on both PostgreSQL nodes.</li>\n<li>Recover the data on the primary database.\n\t<ol start=\"1\">\n<li>On the primary database server, replace the data with the base backup.</li>\n<li>Start Patroni on the primary database.</li>\n<li>Add configuration to fetch the data by using restore_command.\n\t\t<pre><code>#run command\npatronictl -c /opt/app/patroni/etc/postgresql.yml edit-config postgres\n\n#add the following lines to the section postgresql.parameters:\n    restore_command = 'cp /mnt/server/archivedir/%f \"%p\"'\n\n#Set your recovery target here.Here is an example to recover the data before the time specified.\n#recovery_target_time=&lt;Specify a time from when you begin your wrong operation&gt;\n#recovery_target_inclusive='off'</code></pre>\n</li>\n<li>Create a file called recovery.signal in the data directory. </li>\n</ol>\n</li>\n<li>On the standby PostgreSQL node, create a base backup of the primary database. Then start it.</li>\n<li>Make sure you have the data restored as expected.</li>\n<li>Make sure the data replication from the primary to the standby works.</li>\n<li>Recover the original pg_hba file of the primary node by copying the original file back.<br/>\n\tReload the file:\n\t<pre><code>patronictl -c /opt/app/patroni/etc/postgresql.yml reload postgres</code></pre>\n</li>\n<li>Make sure the applications can connect to the database and work as expected.</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}