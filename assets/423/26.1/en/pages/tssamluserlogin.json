{
  "title": "SAML users failed to log in",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>The SAML users can't log in to the suite.</p>\n<h2 id=\"Cause\">Cause</h2>\n<p>This issue occurs due to the SAML certificate expiration. </p>\n<ol>\n<li>Log in to a control plane node or bastion node as root or a sudo user, and run the following command to get the pod name of idm:\n\t<p><code>kubectl get pods -n &lt;suite namespace&gt; | grep idm</code></p>\n</li>\n<li>Run the following command to access the installer's log:\n\t<p><code>kubectl logs &lt;idm pod name&gt; -n &lt;suite namespace&gt; -c idm</code></p>\n<p>If there're more than one idm pod, run this command on each pod one by one.</p>\n</li>\n<li>You can find the following text in the log.<br/>\n<code>checkSignatureValue Signature verficiation failed</code></li>\n</ol>\n<h2 id=\"Solution\">Solution</h2>\n<ol>\n<li>Log in to the control plane node or bastion node as root or a sudo user and run the following command to enter the idm container:\n\t<p><code>namespace=$(kubectl get ns|grep itsma|head -1|awk '{print $1}') &amp;&amp; pod=$(kubectl get po -n $namespace|grep idm|head -1|awk '{print $1}') &amp;&amp; kubectl exec -ti $pod -n $namespace -c idm /bin/bash</code></p>\n</li>\n<li>Run the following command to import the env parameters:<br/>\n<code>export CERT_CN=&lt;suite FQDN&gt;<br/>\n\texport CERT_OU=&lt;organizational unit&gt;<br/>\n\texport CERT_O=&lt;organization&gt;<br/>\n\texport CERT_L=&lt;locality&gt;<br/>\n\texport CERT_ST=&lt;state&gt;<br/>\n\texport CERT_C=&lt;country&gt;<br/>\n\texport CERT_ALIAS=&lt;certificate alias name&gt;<br/>\n\texport KEY_STORE_FILE=&lt;filepath&gt;/samlKeystore.jks<br/>\n\texport KEY_STORE_PASS=&lt;keystore password&gt;<br/>\n\texport KEY_PASS=&lt;key password&gt;<br/>\n\texport CERT_VALIDITY=&lt;validity period of the cerficiate&gt; (3650 means that the validity period is 10 years) <br/>\n\texport KEY_SIZE=2048<br/>\n\texport KEY_STORE_TYPE=JKS</code></li>\n<li>Run the following commands to generate a new smalKeystore.jks file:<br/>\n<code>keytool -noprompt -genkey -dname \"CN=${CERT_CN}, OU=${CERT_OU}, O=${CERT_O}, L=${CERT_L}, ST=${CERT_ST}, C=${CERT_C}\" -keyalg RSA -alias ${CERT_ALIAS} -keystore ${KEY_STORE_FILE} -storepass ${KEY_STORE_PASS} -keypass ${KEY_PASS} -validity ${CERT_VALIDITY} -keysize ${KEY_SIZE} -deststoretype ${KEY_STORE_TYPE}</code></li>\n<li>Run the following commands to verify the new samlKeystore.jks file:<br/>\n<code>keytool -list -alias ${CERT_ALIAS} -keystore ${KEY_STORE_FILE} -storepass ${KEY_STORE_PASS} -storetype ${KEY_STORE_TYPE} -v</code></li>\n<li>Run the following commands to replace verify the samlKeystore.jks file with the new one:<br/>\n<code>cp &lt;file path defined in step 6&gt;/samlKeystore.jks /var/itsma/upload/security/</code></li>\n<li>Run the following command to get the idm database password:\n\t<p><code>get_secret itom_itsma_db_password_secret_key</code></p>\n</li>\n<li>Run the following command to connect to the idm database:\n\t<p><code>psql -d idm -U idm -h postgresql-svc</code></p>\n</li>\n<li>Run the following SQLs to update the keystore password, key password, and key name in the IdM database:<br/>\n<code>update system_resource_config set value = &lt;KEY_STORE_PASS&gt; where name = 'idm.saml.keystore.password';<br/>\n\tupdate system_resource_config set value = &lt;KEY_PASS&gt; where name = 'idm.saml.keystore.defaultKey.password';<br/>\n\tupdate system_resource_config set value = &lt;CERT_ALIAS&gt; where name = 'idm.saml.keystore.defaultKey.name';</code></li>\n<li>\n<p>Exit the idm container and run the following command restart idm pod:</p>\n<p><code>kubectl scale -n &lt;suite namespace&gt; deployment idm --replicas 0<br/>\n\tkubectl scale -n &lt;suite namespace&gt; deployment idm --replicas &lt;number of idm pod&gt;</code></p>\n</li>\n<li>\n<p>Download the saml metadata file spring_saml_metadata.xml from https://&lt;EXTERNAL_ACCESS_HOST&gt;/idm-service/saml/metadata</p>\n</li>\n<li>\n<p>Delete the old IdM relying party trust entry in the SAML IDP and import the SAML metadata XML file to the IDP server.<br/>\n\tTake Microsoft ADFS as an example, on the ADFS management console, click <strong>Relying Party Trust</strong>, select the old IdM relying party trust entry, right-click and delete it.</p>\n</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}