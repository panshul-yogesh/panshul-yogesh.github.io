{
  "title": "Upgrade Audit (embedded Kubernetes)",
  "content": "<div class=\"mw-parser-output\"><p>This page contains the steps to upgrade Audit service and Audit collector in an on-premises environment. You must upgrade both Audit service and Audit collector. </p>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-tip-icon\"></div><div class=\"admonition-content admonition-tip-content\"><div>If the suite deployment is Helm-based, the Audit Collector is upgraded during the suite upgrade. In this case, skip the Audit Collector upgrade steps described below.</div></div></div>\n<h2>Back up Audit service</h2>\n<p>This section gives the steps to back up Audit files and data:</p>\n<ol>\n<li>\n<p>Back up audit database.</p>\n</li>\n<li>\n<p>Back up all the configuration files that you are using. For example, <b>values.yaml</b> file, <strong>audit-secret.yaml</strong>, chart tar file, and certificates.</p>\n</li>\n<li>\n<p>Back up the <strong>itom-audit</strong><b>-pv.yaml</b> file.</p>\n</li>\n<li>\n<p>Back up the following data on the NFS volumes for the Audit deployment:</p>\n<table>\n<thead>\n<tr>\n<th scope=\"col\">Component</th>\n<th scope=\"col\">NFS volume name</th>\n<th scope=\"col\">Description</th>\n<th scope=\"col\">Example directory path</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Audit</td>\n<td><strong>as-vault-volume-&lt;Audit Namespace&gt;</strong></td>\n<td>Stores Audit configuration files.</td>\n<td>/var/vols/itom/audit/auditns/vault</td>\n</tr>\n<tr>\n<td>Audit</td>\n<td><strong>as-log-volume-&lt;Audit Namespace&gt;</strong></td>\n<td>Stores logs generated by Audit.</td>\n<td>/var/vols/itom/audit/auditns/log</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ol>\n<h2>Download new Audit service Helm chart</h2>\n<p>To download the Audit Helm chart to the control plane node, follow these steps:</p>\n<ol>\n<li>Log in to the control plane node and navigate to the directory where you want to download and install Audit service. In this directory, create a folder, for example, <strong>audit-2x.x</strong>.\n\n\t<pre>mkdir audit-2x.x\ncd audit-2x.x</pre>\n</li>\n<li>Download the <strong>Audit</strong><b>_Helm_Chart</b><b>-2x.x.zip</b> file from the <a href=\"https://sld.microfocus.com/mysoftware/index\" title=\"Software Licenses and Downloads\">Software Licenses and Downloads</a> website to this folder.</li>\n<li>Unzip the package:\n\t<pre>unzip Audit_Helm_Chart-2x.x.zip</pre>\n</li>\n<li>Untar the Audit chart package:\n\t<pre>$tar -xvf audit-1.2.0+2x.x-xx.tgz</pre>\n</li>\n<li>Copy the Helm chart and the sample files to the install directory created in the step 1.\n\t<pre>cp audit-helm-chart/audit/charts/*.tgz .\ncp audit-helm-chart/audit/samples/* .</pre>\n</li>\n<li>Refer to <a href=\"/doc/423/26.1/configureaudityaml4audit\" title=\"Configure values.yaml for Audit service (on-premises)\">Configure values.yaml for Audit service (on-premises)</a> and update the backed up values.yaml file.</li>\n</ol>\n<h2>Download and upload new Audit service images</h2>\n<ol>\n<li>Prepare the related images by following the instructions in <a href=\"/doc/423/26.1/installauditdownloadimages\" title=\"Download Audit images\">Download Audit images</a>.</li>\n<li>Upload container images for Audit to a registry by following the instructions in <a href=\"/doc/423/26.1/uploadauditimageshelm\" title=\"Upload Audit images\">Upload Audit images</a>.</li>\n</ol>\n<h2>Upgrade Audit service</h2>\n<p>Perform the following steps to upgrade to the latest version of Audit service:</p>\n<ol>\n<li>First note down the namespace where you have installed the Audit service. Run the following command to get the namespace: \n\t<pre>kubectl get namespace</pre>\n</li>\n<li>Run the following command to upgrade the Audit service:\n\t<pre>$helm upgrade &lt;Audit Release Name&gt; &lt;Audit Service Chart&gt; -n &lt;Audit Namespace&gt; -f &lt;Values YAML File&gt; -f &lt;<code>Secrets YAML File&gt;</code> --set-file \"caCertificates.cert_one\"=/path/to/cert_one.crt --set-file \"caCertificates.cert_two\"=/path/to/cert_two.crt\n</pre>\n<p>where,</p>\n<p><em>&lt;Audit Release Name&gt; </em> is the release name of the Audit deployment that you specified when installing Audit.<br/>\n<em>&lt;Audit Service Chart&gt;</em> is the new tar file containing the Audit installation chart.<br/>\n<em>&lt;Audit Namespace&gt;</em> is the unique namespace you created for the Audit service.<br/>\n<em>&lt;Values YAML File&gt;</em> is your <b>values.yaml</b> file with properties configured for the Audit deployment.<br/>\n<em>&lt;Secrets YAML File&gt;</em> is the YAML file that stores the Audit secrets. Specify the file name (for example, <strong>audit-secret-backup.yaml</strong>). If you don't have this file, run the following command to get the file:</p>\n<pre>kubectl get secret &lt;name&gt; -n &lt;auditns&gt; -o yaml &gt; audit-secret-backup.yaml</pre>\n<p>You can pass the certificates by using the <strong>--set-file</strong> option. You can pass the IdM and database certificates.<br/>\n\tYou can find the <strong>values.yaml</strong>, <strong>audit-secret-backup.yaml</strong>, and the certificates in the backed up file.<br/>\n\tAn example command:</p>\n<pre>$helm upgrade audit audit-&lt;version&gt;.tgz -n auditns -f values.yaml -f audit-secret-backup.yaml --set-file \"caCertificates.RE_ca_idmcrt\"=./RE_ca_idm.crt --set-file \"caCertificates.RE_ca_dbcrt\"=./RE_ca_db.crt\n</pre>\n</li>\n<li>Run the following command to check if the Audit service pods are ready:\n\t<pre>kubectl get pod -n &lt;Audit Namespace&gt; |grep -v 1/1|grep -v 2/2|grep -v 3/3|grep -v 4/4|grep -v Completed</pre>\n<p>where,</p>\n<p><em>&lt;Audit Namespace&gt;</em> is the namespace where you have deployed the Audit Helm chart.</p>\n<p>This command returns a list of abnormal pods. When it returns no results, all pods are ready.</p>\n</li>\n</ol>\n<h2>Restore Audit service to previous version when upgrade fails</h2>\n<p>Follow the instructions below to restore Audit service if upgrade fails due to failure or corruption of audit deployment. </p>\n<ol>\n<li>\n<p>To uninstall Audit, delete the Audit deployment.</p>\n</li>\n<li>\n<p>Remove persistent volumes.</p>\n</li>\n<li>\n<p>Clean the NFS volumes.</p>\n</li>\n<li>\n<p>Create a new deployment. </p>\n</li>\n<li>\n<p>To restore secret, create a new <strong>audit-secret</strong> using the backup secret YAML file:</p>\n<pre>kubectl apply -f itom-audit-secret_backup_yyyy-mm-dd.yaml -n &lt;Audit namespace&gt;</pre>\n</li>\n</ol>\n<ul>\n<li>\n<p>Recreate NFS volumes (in the NFS server). </p>\n</li>\n<li>\n<p>Recreate PVs using the same configuration (<strong>itom-audit</strong><b>-pv.yaml</b>). </p>\n</li>\n<li>\n<p>Restore the audit database from the backed up DB.</p>\n</li>\n<li>\n<p>Reinstall audit deployment with the same configuration (<b>values.yaml</b>) and the same helm chart.</p>\n</li>\n</ul>\n<h2>Back up Audit collector</h2>\n<p>Back up all the Audit collector configuration files: <strong>audit collector values.yaml</strong>, <strong>audit collector secret backup.yaml</strong> file (you may need this file in case you need to restore Audit collector to the previous version), audit collector chart tar file, and certificates.</p>\n<h2>Download new Audit collector Helm chart</h2>\n<p>To download the Audit collector Helm chart to the control plane node, follow these steps:</p>\n<ol>\n<li>Log in to the control plane node and navigate to the directory where you want to download and install Audit collector, for example, <strong>auditcollector</strong>. In this directory, create a folder, for example, <strong>audit-collector-2x.x</strong>.\n\n\t<pre>mkdir audit-collector-2x.x\ncd audit-collector-2x.x</pre>\n</li>\n<li>Download the <strong>Audit</strong><b>_Collector_Helm_Chart</b><b>-2x.x.zip</b> file from the <a href=\"https://sld.microfocus.com/mysoftware/index\" title=\"Software Licenses and Downloads\">Software Licenses and Downloads</a> website to <strong>audit-collector-2x.x </strong>folder or the folder that you have created in Step 1.</li>\n<li>Unzip the package:\n\t<pre>unzip Audit_Collector_Helm_Chart-2x.x.zip</pre>\n</li>\n<li>Untar the Audit collector chart package:\n\t<pre>$tar -xvf audit-collector-&lt;Version&gt;.tgz</pre>\n</li>\n<li>Make sure you are in the <strong>audit-collector-2x.x</strong> folder or the folder that you have created in Step 1. Copy the Helm chart and the sample value.yaml files using the following commands:\n\t<pre>cp audit-collector-helm-chart/audit-collector/charts/*.tgz .\ncp audit-collector-helm-chart/audit-collector/samples/* .</pre>\n</li>\n<li>Update the values in the new Audit collector values.yaml file by referring to the backed up Audit collector values.yaml file. Refer <a aria-label=\"Link Configure values.yaml for Audit collector (on-premises)\" href=\"/doc/131-configureauditcollectoryaml\" id=\"menurgre\" rel=\"noreferrer noopener\" target=\"_blank\" title=\"https://docs.microfocus.com/doc/131-configureauditcollectoryaml\">Configure values.yaml for Audit collector (on-premises)</a>. </li>\n</ol>\n<h2>Download and upload new Audit collector images</h2>\n<div class=\"admonition\"><div class=\"admonition-icon admonition-note-icon\"></div><div class=\"admonition-content admonition-note-content\"><div>The Audit collector is included in the ESM Helm upgrade chart. Skip this step if your Service Management deployment is Helm based.</div></div></div>\n<p>Prepare the Audit collector images by following the instructions in <a href=\"/doc/423/26.1/auditcollectordownloadimages\" title=\"Download images for audit collector\">Download images for Audit collector</a>.</p>\n<h2>Upgrade Audit collector</h2>\n<ol>\n<li>Deploy the Audit collector file in the same namespace where the Audit producer is running.</li>\n<li>\n<p>Generate vault secrets for the Audit collector chart by running the following command on the control plane node:</p>\n<pre>$CDF_HOME/scripts/gen_secrets.sh -n &lt;Audit Producer Namespace&gt; -c &lt;Audit Collector Chart File&gt; -o &lt;Secrets YAML File&gt;</pre>\n<p>where,</p>\n<p><em>&lt;Audit producer Namespace&gt;</em> is the namespace in which the Audit Producer (for example, Service Management or UCMDB) is running.<br/>\n<em>&lt;Audit collector Chart File&gt;</em> is the tar file containing the Audit collector installation charts (<strong>audit-collector-&lt;version&gt;.tgz</strong>)<br/>\n<em>&lt;Secrets YAML File&gt;</em> is the YAML file that stores the Audit collector secret. Specify the file name (for example, <strong>audit-collector-secret.yaml</strong>), and then the script will generate this YAML file after you run the script. You will need to use this file when you run the command to install the Audit collector.</p>\n<p>For example,</p>\n<pre>/opt/cdf/scripts/gen_secrets.sh -n itsma-cfpni -c audit-collector-&lt;version&gt;.tgz -o audit-collector-secret.yaml</pre>\n</li>\n<li>\n<p>The vault secret utility prompts you for the Audit collector integration user password: <strong>audit_collector_integration_user_pass_key</strong>.</p>\n</li>\n<li>Run the following command to upgrade audit collector to the latest version:\n\t<pre>$helm upgrade &lt;Audit Collector Release Name&gt; &lt;Audit Collector Chart&gt; -n &lt;Audit Producer Namespace&gt; -f values.yaml -f audit-collector-secret.yaml --set-file \"caCertificates.cert_one\\.crt\"=/path/to/cert_one.crt --set-file \"caCertificates.cert_two\\.crt\"=/path/to/cert_two.crt\n</pre>\n<p>where,</p>\n<p><em>&lt;Audit Collector Release Name&gt;</em> is the release name of the Audit collector deployment that you specified when installing the Audit collector.<br/>\n<em>&lt;Audit Collector Chart&gt;</em> is the tar file containing the Audit collector installation charts.<br/>\n<em>&lt;Audit Producer Namespace&gt;</em> is the namespace where the Audit producer is running.<br/>\n<em>&lt;Values YAML File&gt;</em> is your <strong>values.yaml</strong> file with properties configured for the Audit collector deployment.<br/>\n<em>&lt;Audit Collector Secrets YAML file&gt;</em> is the file that gen_secret script generates and holds the Audit collector secrets.<br/>\n\tYou can pass certificates using the <code>--set-file</code> option. In the following example, you can see the suite certificate and Audit service engine certificates. You can find the Audit collector <strong>values.yaml</strong> and the certificates in the backed up file.</p>\n<p>An example command:</p>\n<pre>$helm upgrade audit-collector audit-collector-&lt;version&gt;.tgz -n itsma-cfpni -f values.yaml -f audit-collector-secrets-backup.yaml --set-file \"caCertificates.idm\\.crt\"=idm.crt --set-file \"caCertificates.auditservice\\.crt\"=ase.crt</pre>\n</li>\n</ol>\n<h2>Restore Audit collector</h2>\n<p>Follow the instructions below to restore the Audit collector to the previous version if upgrade fails. </p>\n<ol>\n<li>\n<p>Uninstall Audit collector.</p>\n</li>\n<li>\n<p>To restore the secret, create a new <strong>audit-collector-secret</strong> using the backup secret YAML file:</p>\n<pre>kubectl apply -f itom-audit-collector-secret-backup-yyyy-mm-dd.yaml -n &lt;Audit producer namespace&gt;</pre>\n</li>\n<li>\n<p>Reinstall Audit collector with the same configuration (<b>values.yaml</b>) and the same helm chart.</p>\n</li>\n</ol>\n<h2>Enable indexing for existing tenants</h2>\n<p>To enable indexing in the audit database for existing tenants, you can run a script. Open the query tool for the required schema under the audit table and run the following script:</p>\n<pre>CREATE INDEX IF NOT EXISTS &lt;index_name&gt; ON \"&lt;schema&gt;\".audit (column1,column2,...);</pre>\n<p>For example:</p>\n<pre>CREATE INDEX IF NOT EXISTS AUDIT_INDEX ON \"100000002\".audit (action, audit_time, event_category, result, service, tenant_id);\n</pre>\n<p><em>&lt;index_name&gt;</em>: Any name you want to give for the index.<br/>\n<em>&lt;schema&gt;</em>: The schema for which you want to enable indexing.<br/>\n<em>&lt;column 1, column 2...&gt;</em>: The name of the columns that you want to enable indexing for. This is a comma separated list.</p>\n<h2>Related topics</h2>\n<ul>\n<li>For instructions about backing up PostgreSQL database, see the <a href=\"https://www.postgresql.org/docs/current/backup.html\" title=\"PostgreSQL documentation\">PostgreSQL documentation</a>.</li>\n<li>For any new parameters in the values.yaml file, see <a href=\"/doc/423/26.1/configureaudityaml4audit\" title=\"Configure values.yaml for Audit service (on-premises)\">Configure values.yaml for Audit service (on-premises)</a>.</li>\n<li>To uninstall Audit service in an on-premises environment when upgrade fails, see <a href=\"/doc/423/26.1/uninstallauditonpremises\" title=\"Uninstall the Audit service on-premises\">Uninstall the Audit service on-premises</a>.</li>\n<li>After uninstalling Audit service, create a deployment to restore to the previous version in case of upgrade failure. See <a href=\"/doc/423/26.1/createauditdeploymentonprem\" title=\"Create a deployment (on-premises)\">Create a deployment (on-premises)</a>.</li>\n<li>To recreate NFS volumes, see <a href=\"/doc/423/26.1/createnfsvolumes\" title=\"Create NFS volumes for Audit (on-premises)\">Create NFS volumes for Audit (on-premises)</a>.</li>\n<li>To recreate PVs, see <a href=\"/doc/423/26.1/preparepv4audit\" title=\"Prepare persistent volumes (on-premises)\">Prepare persistent volumes (on-premises)</a>.</li>\n<li>To restore the database, see <a href=\"/doc/423/26.1/prepareexternaldb4audit\" title=\"Prepare an external database for Audit (on-premises)\">Prepare an external database for Audit (on-premises)</a>.</li>\n<li>To reinstall Audit service, see <a href=\"/doc/423/26.1/installauditonpremises\" title=\"Deploy Audit (on-premises)\">Deploy Audit (on-premises)</a>.</li>\n</ul>\n</div>",
  "modifiedon": "2025-10-24 08:51:12"
}