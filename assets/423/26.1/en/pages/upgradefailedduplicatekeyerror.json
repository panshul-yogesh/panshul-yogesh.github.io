{
  "title": "Tenant upgrade fails with \"Duplicate key violation: field name 'Id' \" error",
  "content": "<div class=\"mw-parser-output\"><p class=\"mw-empty-elt\">\n</p><p>Tenant upgrade fails during an upgrade. The upgrade fails with a error in the <code>itom-xruntime-platform-xxxxxxxxxx-xxxxx-2024-03-26/maas/maas_upg_step_audit.log</code> log file as below:</p>\n<pre>INFO |shared-pool-1-thread-6|1xx.xx.xx.xxx|platform-webapp|bo-integration@dummy.com||857561481|RID-d1e6e191-0e56-451f-8df0-8101c15a6b4e|RID-d1e6e191-0e56-451f-8df0-8101c15a6b4e| AviatorModelContentUpgrade-&gt;AviatorModelContentUpgrade : AviatorModelUpgrade batch insert AviatorModel failed, exception message: Duplicate key violation: field name 'Id'  \nINFO |shared-pool-1-thread-5|1xx.xx.xx.xxx|platform-webapp|bo-integration@dummy.com||857561481|RID-0a4ecaf0-eab6-4e62-8769-5e5fea306a51|RID-0a4ecaf0-eab6-4e62-8769-5e5fea306a51| About to copy workflow of entity type [AviatorModel] of targetVersion: [v26]\n</pre>\n<h2>Cause </h2>\n<p>When performing insert operation for <code>entities_&lt;tenant_id&gt;</code>, EMS service will allocate an entity ID. If this ID is being used by other record, a key violation error occurs.</p>\n<h2>Solution </h2>\n<p>This solution will check next value of the sequence to make sure the allocated ID is not being used by another record. </p>\n<ol>\n<li>Perform a system diagnosis. Set up the SMA Operation Toolkit, see <a href=\"/doc/423/26.1/tookitcontainer\" title=\"SMA Support Assistant\">SMA Support Assistant</a> for details.</li>\n<li>Open the toolkit and navigate to <code>tmp </code>folder with the following command.\n\t<pre> kubectl exec -it $( kubectl get pods -n $( kubectl get ns |grep itsma | cut -f1 -d \" \") |grep itom-toolkit | awk '{print $1}' | head -1) bash -n $( kubectl get ns |grep itsma | cut -f1 -d \" \") -c itom-toolkit \n cd /tmp</pre>\n</li>\n<li>Create a new <code>check_tenant_sequence.sh</code> file.</li>\n<li>Copy the content below into the <code>check_tenant_sequence.sh</code> file.\n\t<pre>#!/bin/sh\ndebug=N\nwhile [[ ! -z $1 ]] ; do\n    case \"$1\" in\n        --debug)\n        case \"$2\" in\n            *) debug=Y ; shift 1 ;;\n        esac ;;\n        *|-*|-h|--help|/?|help) echo \"Usage: $0 \"\n            echo \"       --debug            Enable debug mode\"\n            echo \"       -h|--help          Show help.\" ; exit 1 ;;\n    esac\ndone\nif [[ $debug == Y ]]; then\n    set -x\nfi\nfunction get_token(){\n    PASSWORD=`kubectl exec $(kubectl get pods -n $(kubectl get namespace |grep itsma | cut -f1 -d \" \") |grep bo-ats | cut -f1 -d \" \" | tail -1) -n $(kubectl get namespace |grep itsma | cut -f1 -d \" \")  -c itom-bo-ats -- get_secret bo_integration_password_secret_key itom-bo | sed 's/PASS=//g'`\n    if [[ -z $PASSWORD ]]; then\n      echo \"ERROR: cannot get password of integration user, exit ...\"\n      exit 1\n    fi\n    namespace=`kubectl get namespaces |grep itsm |awk '{print($1)}'`\n    svc_ip=`kubectl get svc itom-xruntime-ui-svc -n $namespace --no-headers | awk '{print($3)}'`\n    if [[ -z $svc_ip ]]; then\n      echo \"ERROR: xruntime-ui-svc IP is empty, exit ...\"\n      exit 1\n    fi\n    token=`curl -X POST --noproxy \"*\" --max-time 10 -k -H \"Content-Type:application/json\" -d \"{\\\"login\\\": \\\"bo-integration@dummy.com\\\", \\\"password\\\": \\\"${PASSWORD}\\\"}\" -sL \"http://$svc_ip:8090/auth/authentication-endpoint/authenticate/token\"`\n    if [[ -z $token ]]; then\n      echo \"ERROR: cannot get token, exit ...\"\n      exit 1\n    fi\n}\n function db_call(){\n    echo $db_query\n    pod_name=`kubectl get pods -n $(kubectl get namespace |grep itsma | cut -f1 -d \" \") |grep bo-ats  |grep -v dnd  |grep -v controller |cut -f1 -d \" \" |  tail -1`\n    v_pwd=`kubectl exec  $pod_name  -n $(kubectl get namespace |grep itsma | cut -f1 -d \" \")  -c itom-bo-ats  -- get_secret  itom_itsma_db_password_secret_key itom-xruntime-infra | sed 's/PASS=//g'`\n    pwd=`echo $v_pwd |sed 's/&amp;/\\\\\\&amp;/g'`\n    if [ ! -z $output ]; then\n        kubectl exec $pod_name -n $(kubectl get namespace |grep itsma | cut -f1 -d \" \")  -c itom-bo-ats -- bash -c \"PGPASSWORD=$pwd psql $pretty_flag -U maas_admin  -h $db_server -p $db_port -d $db_name -c \\\" $db_query \\\"\"\n        if [ $? = 0 ] ; then\n            result=SUCC\n        else\n            result=FAIL\n            rcode=`expr $rcode + 1`\n        fi\n    else\n        kubectl exec $pod_name -n $(kubectl get namespace |grep itsma | cut -f1 -d \" \")  -c itom-bo-ats -- bash -c \"PGPASSWORD=$pwd psql $pretty_flag -U maas_admin  -h $db_server -p $db_port -d $db_name -c \\\" $db_query \\\"\"\n        if [ $? = 0 ] ; then\n            result=SUCC\n        else\n            result=FAIL\n            rcode=`expr $rcode + 1`\n        fi\n    fi\n}\nfunction check_tenant_sequence(){\n  get_tenant_url=\"http://$svc_ip:8090/rest/operator/TenantManagement/tenants\"\n  tenant_value=`curl --noproxy \"*\" --max-time 10  -k -sL -X GET -H \"Cookie:SMAX_AUTH_TOKEN=${token}\" -H \"Content-Type:application/json\" \"$get_tenant_url\"`\n  echo $tenant_value &gt; /tmp/tenant_list.json\n  rm -rf  /tmp/tenant_ids.log\n  echo -e \"check sequence for tenant xxxxx \\t  max\\t  next value\\tstatus\"\n  echo -e \"+--------------------------------------+-------+-------------+---------+\"\n  jq -c '.[]' /tmp/tenant_list.json | while read i; do\n      tenant_id=$(echo $i | jq .tenantId)\n      v_tenant_id=`echo $tenant_id |sed 's/\"//g'`\n      db_query=\"select 'check sequence for tenant ${v_tenant_id}';\"\n      description=`db_call |grep -v select |grep -v \"\\-\" |grep -v row |grep -v column`\n      db_query=\"select max(entity_id) from entities_${v_tenant_id};\"\n      max_sequence=`db_call |grep -v select |grep -v \"\\-\" |grep -v row |grep -v max`\n      db_query=\"select idc_id from id_catalog_${v_tenant_id} where idc_namespace='ems' and idc_key='EntityId';\"\n      next_sequence=`db_call |grep -v select |grep -v \"\\-\" |grep -v row |grep -v idc_id`\n      if [[ $max_sequence -gt $next_sequence ]]; then\n\n          fix_sql=\"update id_catalog_${v_tenant_id} set idc_id=$max_sequence where idc_namespace='ems' and idc_key='EntityId';\"\n\n          echo -e \"$description\\t$max_sequence\\t$next_sequence\\t\\tWARN: $fix_sql\"\n      else\n          echo -e \"$description\\t$max_sequence\\t$next_sequence\\t\\tOK\"\n      fi\n  done\n  rm -rf /tmp/tenant_list.json\n}\n# main function\nidm_pod_name=`kubectl get pods -n $(kubectl get namespace |grep itsma | cut -f1 -d \" \") |grep idm  |grep -v dnd  |grep -v controller |cut -f1 -d \" \" |  tail -1`\ndb_server=`kubectl exec -n $(kubectl get namespace |grep itsma | cut -f1 -d \" \") $idm_pod_name -c idm -- env |grep POSTGRESQL_HOST |sed 's/POSTGRESQL_HOST=//g'`\nif [[ -z $db_server ]]; then\n    echo \"Error: Cannot get DB Server, exit ...\"\n    exit 1\nfi\ndb_port=`kubectl exec -n $(kubectl get namespace |grep itsma | cut -f1 -d \" \") $idm_pod_name -c idm -- env |grep POSTGRESQL_PORT |sed 's/POSTGRESQL_PORT=//g'`\nif [[ -z $db_port ]]; then\n    echo \"Error: Cannot get DB Port, exit ...\"\n    exit 1\nfi\ndb_name=xservices_ems\nget_token\ncheck_tenant_sequence\n</pre>\n</li>\n<li>Run the script\n\t<pre>bash ./check_tenant_sequence.sh</pre>\n</li>\n<li>\n<p>You should get an output similar to the image below</p>\n<a class=\"image\" href=\"https://staging.docs.microfocus.com/file/images/b/b8/GetImageDupKey.png\" title=\"https://staging.docs.microfocus.com/file/images/b/b8/GetImageDupKey.png\"> <img alt=\"Upgrade Failed with DuplicateKey Error\" border=\"0\" file=\"https://staging.docs.microfocus.com/mediawiki/images/b/b8/GetImageDupKey.png\" height=\"218\" hspace=\"0\" src=\"../../../images/GetImageDupKey_40d688d9.png\" style=\"width:800px;height:218px;margin-top:0px;margin-bottom:0px;margin-left:0px;margin-right:0px;border:0px solid black;\" vspace=\"0\" width=\"800\"/> </a></li>\n<li>If you get a warning message, please go to database xservices_ems and run the update query as below.\n\t<pre>update id_catalog_178569385 set idc_id=19464 where idc_namesacpe='ems' and idc_key='EntityId';</pre>\n</li>\n<li>After updating, re-run the step 4 command to make sure all status is 'OK'</li>\n<li>Rerun the tenant upgrade.</li>\n</ol>\n<p class=\"mw-empty-elt\"></p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}