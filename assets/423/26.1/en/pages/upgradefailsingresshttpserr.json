{
  "title": "Upgrade fails with \"Ingress should allow https only.\" error on AKS",
  "content": "<div class=\"mw-parser-output\"><p>If your deployment is running on AKS and the policy <i>“</i><strong>Kubernetes clusters should be accessible only over HTTPS</strong><i>”</i>  is enabled, the upgrade process will fail with the following error:</p><pre><code>Error: UPGRADE FAILED: failed to create resource: admission webhook \"validation.gatekeeper.sh\" denied the request: [azurepolicy-k8sazurev1ingresshttpsonly-&lt;id&gt;] Ingress should allow https only. tls configuration and annotation nginx.ingress.kubernetes.io/force-ssl-redirect=true are required for itom-esm-api-ingress </code></pre><h2 id=\"Cause\"><a id=\"Cause\" name=\"Cause\" title=\"Cause\"></a>Cause</h2><p>The issue occurs if TLS is not configured for the ingress deployed in the Suite.</p><h2 id=\"Solution\"><a id=\"Solution\" name=\"Solution\" title=\"Solution\"></a>Solution</h2><div><span class=\"snippet-start\" data-sname=\"enable-tls-for-ingress\"></span><p>If the built-in Azure policy <strong>Kubernetes clusters should be accessible only over HTTPS</strong> is enabled, Suite upgrade on AKS fails with the error '<em>Ingress should allow HTTPS only</em>'. To fix the error, you must  configure TLS for all the ingress deployed in the Suite.</p>\n<p>Complete the following steps to configure TLS. Make sure you replace the following placeholders with values from your deployment environment:</p>\n<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 28px; position: relative;\"><strong>&lt;release name&gt;:  </strong>The release name you provided when you installed the Suite. </li><li style=\"margin-left: 28px; position: relative;\"><strong>&lt;suite namespace&gt;:</strong> The Suite namespace.</li><li style=\"margin-left: 28px; position: relative;\"><strong>&lt;external access host&gt;:</strong> The actual access host name.</li></ul>\n<ol style=\"padding-left: 0px;\"><li style=\"--number-width: 10px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following command to fetch the <strong>externalAccessHost </strong>parameter value from the <strong>values.yaml </strong>file. This value corresponds to the external access host name.\n\n\t<pre><code>helm get values &lt;release name&gt; -n &lt;suite namespace&gt; -o json | jq -r '.global.externalAccessHost'</code></pre>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Run the following command to configure TLS for all the ingress deployed in the Suite. Replace <strong>&lt;external access host&gt;</strong> placeholder with the external access host name you retrieved in the earlier step.\n\t<pre><code>kubectl get ingress -n &lt;suite namespace&gt; -o jsonpath='{range .items[*]}{.metadata.name}{\"\\n\"}{end}' \\\n| while read -r ing; do\n  echo \"Patching $ing ...\"\n  kubectl patch ingress \"$ing\" -n &lt;suite namespace&gt; --type='merge' -p '{\n    \"metadata\": {\n      \"annotations\": {\n        \"nginx.ingress.kubernetes.io/force-ssl-redirect\": \"true\"\n      }\n    },\n    \"spec\": {\n      \"tls\": [\n        {\n          \"hosts\": [\"&lt;external access host&gt;\"],\n          \"secretName\": \"nginx-default-secret\"\n        }\n           ]\n    }\n  }'\ndone</code></pre>\n</li><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\"><span id=\"cke_bm_30302S\" style=\"display: none;\"> </span>Run the following command to verify that TLS is enabled.<span id=\"cke_bm_30302E\" style=\"display: none;\"> </span>\n<pre><code>kubectl get ingress -n &lt;suite namespace&gt; -o json | jq '.items[] | {name: .metadata.name, tls: (.spec.tls // [])}'\n</code></pre>\n</li></ol>\n<span class=\"snippet-end\" data-sname=\"enable-tls-for-ingress\"></span></div><ol start=\"4\" style=\"padding-left: 0px;\"><li style=\"--number-width: 13px; --number-spacing: 24px; margin-left: 36px; position: relative;\">Make sure you apply changes by running the helm upgrade command. Replace the placeholder(s) in the command with the values for your deployment environment:\n\t<ul style=\"padding-left: 0px;\"><li style=\"margin-left: 40px; position: relative;\"><b>&lt;ESM helm chart path&gt;:</b> Path to the tar file containing the suite installation charts. </li></ul><pre><code>helm upgrade &lt;release name&gt; &lt;ESM helm chart path&gt; -n &lt;suite namespace&gt; -f my-values.yaml\n\n</code></pre></li></ol><style type=\"text/css\">a {\n    text-decoration: none;\n    color: #464feb;\n}\ntr th, tr td {\n    border: 1px solid #e6e6e6;\n}\ntr th {\n    background-color: #f5f5f5;\n}\n</style></div>",
  "modifiedon": "2026-01-19 12:47:54"
}