{
  "title": "Flannel pod doesn't start after you restart a node",
  "content": "<div class=\"mw-parser-output\"><span class=\"snippet-start\" data-sname=\"423-25.4-423-25.3-UpgradeFlannelPodsDontStart||N\"></span><p class=\"mw-empty-elt\">\n</p><p>When you restart a node, a Flannel pod doesn't restart. If you check the Flannel pod (<code>kube-flannel-ds-amd64-xxxx</code>) for errors, you find error messages that resemble the following:</p>\n<pre><code>Warning FailedCreatePodSandBox 3m4s          kubelet      Failed to create pod sandbox: rpc error: code = Unknown desc = failed to set up sandbox container \"6d5cc08c264973d09dc3da6529150921efa117a11de2b1b1757f8ed3fdefc989\" network for pod \"itom-prometheus-node-exporter-f5kwm\": networkPlugin cni failed to set up pod \"itom-prometheus-node-exporter-f5kwm_core\" network: open /run/flannel/subnet.env: no such file or directory</code></pre>\n<p>This issue occurs after you upgrade OMT.</p>\n<h2>Cause</h2>\n<p>This issue occurs because the <code>kubectl</code> command fails to patch the Flannel configuration during the upgrade, but later successfully upgrades Flannel. Although Flannel is successfully upgraded, it's missing some key configurations. Therefore, this issue occurs after you restart the node.</p>\n<h2>Solution</h2>\n<ol>\n<li>Run the following command to find which node the crashed Flannel pod is on:\n\t<pre><code>kubectl get pods -n kube-system -o wide | grep flannel</code></pre>\n<p>The output resembles the following. Look for the node that's not in the \"Running\" state.</p>\n<pre><code>kube-flannel-ds-amd64-22m94               1/1     Running            0          11h    192.0.2.0   autovmcos76vm01.company.net   &lt;none&gt;           &lt;none&gt;\nkube-flannel-ds-amd64-jc6hl               1/1     Running            0          11h    192.0.2.1    autovmcos76vm04.company.net   &lt;none&gt;           &lt;none&gt;\nkube-flannel-ds-amd64-shtv2               1/1     Running            0          11h    192.0.2.2   autovmcos76vm05.company.net   &lt;none&gt;           &lt;none&gt;\nkube-flannel-ds-amd64-sk4fb               1/1     Running            0          11h    192.0.2.3   autovmcos76vm02.company.net   &lt;none&gt;           &lt;none&gt;\nkube-flannel-ds-amd64-zt4lh               0/1     CrashLoopBackOff   4          11h    192.0.2.4    autovmcos76vm03.company.net   &lt;none&gt;           &lt;none&gt;\n</code></pre>\n</li>\n<li>Log on to the node that you identified in step 1, and then run the following script:\n\t<pre><code>#!/bin/bash\n\nsource ${K8S_HOME}/bin/env.sh\n\ngetThisNode(){\n    local thisNode=\n    local all_nodes=$1\n    local local_ips=\n    local local_hostname=\n    local local_shortname=\n    local_ips=$(ifconfig | grep -Eo 'inet (addr:)?([0-9]*\\.){3}[0-9]*' | grep -Eo '([0-9]*\\.){3}[0-9]*' | grep -v '127.0.0.1')\n    local_hostname=$(hostname -f | tr '[:upper:]' '[:lower:]')\n    local_shortname=$(hostname -s | tr '[:upper:]' '[:lower:]')\n    for node in ${all_nodes}\n    do\n        lower_node=$(echo $node | tr '[:upper:]' '[:lower:]')\n        if [[ \"$local_hostname\" == \"$lower_node\" ]]; then\n            thisNode=\"$local_hostname\"\n            break\n        else \n            for ip in $local_ips\n            do\n              if [ \"$node\" == \"$ip\" ]; then\n                thisNode=\"$ip\"\n                break\n              fi\n            done\n        fi\n        # shortname\n        if [[ \"$local_shortname\" == \"$lower_node\" ]]; then\n            thisNode=\"$local_shortname\"\n            break\n        fi\n    done\n    echo \"$thisNode\"\n}\n\nif [[ -d ${RUNTIME_CDFDATA_HOME}/etcd ]] &amp;&amp; [[ $(ls ${RUNTIME_CDFDATA_HOME}/etcd|wc -l) -gt 0 ]]; then\n    ALL_NODES=$(kubectl get nodes --no-headers | awk '{print $1}' | xargs | tr '[:upper:]' '[:lower:]')\n    THIS_NODE=$(getThisNode \"${ALL_NODES}\")\n    HOST=$THIS_NODE\nelse\n    K8S_MASTER_IP=$(kubectl get cm base-configmap -n $CDF_NAMESPACE -o json | jq -r \".data.API_SERVER\")\n    HOST=$K8S_MASTER_IP\nfi\n\njsonData=\"export KUBERNETES_SERVICE_HOST=${HOST}\"\n\nFLANNEL_IFACE=$(cat ${K8S_HOME}/cni/conf/cdf-flannel-iface | grep FLANNEL_IFACE | awk -F= '{print $2}')\n\nif [ -n \"${FLANNEL_IFACE}\" ]; then\n    jsonData=\"${jsonData}\\nexport FLANNELD_IFACE=${FLANNEL_IFACE}\"\nfi\n\nkubectl patch cm kube-flannel-cfg -n kube-system -p \"{\\\"data\\\": { \\\"${THIS_NODE}\\\": \\\"${jsonData}\\\" }}\"\nkubectl rollout restart ds kube-flannel-ds-amd64 -n kube-system\nkubectl rollout status ds kube-flannel-ds-amd64 -n kube-system\n</code></pre>\n</li>\n</ol>\n<p><br/>\n</p>\n<p class=\"mw-empty-elt\"></p><span class=\"snippet-end\" data-sname=\"423-25.4-423-25.3-UpgradeFlannelPodsDontStart||N\"></span><p>  </p></div>",
  "modifiedon": "2025-10-24 08:51:12"
}